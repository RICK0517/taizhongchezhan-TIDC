<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>匯入班表</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:20px auto;padding:0 14px}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
    input,button{width:100%;padding:10px;margin-top:6px}
    button{font-weight:700;cursor:pointer;background:#2563eb;color:#fff;border:none;border-radius:4px;}
    button:hover{background:#1d4ed8;}
    .small{opacity:.75;font-size:13px;line-height:1.4}
    .msg{margin-top:10px;color:#b00020;white-space:pre-wrap}
    .ok{color:#0a7a2f}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="bar">
    <div>
      <h1 style="margin:0">匯入班表</h1>
      <div class="small" id="me_line">讀取中…</div>
    </div>
  </div>

  <section class="card">
    <h2 style="margin:0">上傳 Excel（.xlsx）</h2>
    <div class="small" style="margin-top:8px;line-height:1.6">
      支援格式：第 1 列是日期（B1 起），第 2 列是星期提示（可有可無），A 欄是姓名，交叉格是班別文字（空白會略過）。<br/>
      匯入會先刪除同場域該日期區間的既有班表，再寫入新資料，用來「覆蓋」更新。
    </div>

    <input id="sched_file" type="file" accept=".xlsx" />
    <button id="btn_import">開始匯入</button>
    <div id="import_msg" class="msg"></div>

    <div class="small" style="margin-top:10px">
      小提醒：若你要讓「主頁上方顯示自己的今日/明日班表」，請先到 <code>人員對照</code> 把班表姓名連到帳號。
    </div>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import * as XLSX from "https://esm.sh/xlsx@0.18.5";

    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    function setMsg(el, text, ok=false){
      el.textContent = text || "";
      el.className = ok ? "msg ok" : "msg";
    }

    const params = new URLSearchParams(window.location.search);
    const currentSiteId = params.get("site_id");

    function toISODateLocal(d){
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tz).toISOString().slice(0,10);
    }
    function normDateCell(v){
      if (!v) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return toISODateLocal(v);
      if (typeof v === "number" && isFinite(v)){
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(epoch.getTime() + v * 86400000);
        return toISODateLocal(d);
      }
      if (typeof v === "string"){
        const t = Date.parse(v);
        if (!isNaN(t)) return toISODateLocal(new Date(t));
      }
      return null;
    }

    function isManagerRole(role){ return role === "engineer" || role === "supervisor"; }

    async function init(){
        if(!currentSiteId) { $("me_line").textContent="網址缺少 site_id"; return; }
        
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) { location.href = "./index.html"; return; }
        const uid = session.user.id;

        const { data: site } = await supabase.from("sites").select("name").eq("id", currentSiteId).single();
        const { data: mem } = await supabase.from("site_memberships").select("role").eq("user_id", uid).eq("site_id", currentSiteId).eq("is_active", true).maybeSingle();

        if(!mem) { $("me_line").textContent = "無此場域權限"; return; }
        $("me_line").textContent = `場域：${site?.name} ｜ 您的身分：${mem.role}`;

        $("btn_import").addEventListener("click", async () => {
            setMsg($("import_msg"), "");
            await importScheduleXlsx(currentSiteId, uid, mem.role);
        });
    }

    async function importScheduleXlsx(siteId, meUid, role){
      const f = $("sched_file")?.files?.[0];
      if (!f){ setMsg($("import_msg"), "請先選擇 .xlsx 檔案"); return; }
      if (!isManagerRole(role)){ setMsg($("import_msg"), "只有主管/工程師可以匯入班表"); return; }

      setMsg($("import_msg"), "解析中…");

      let rows;
      try{
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array", cellDates: true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: "" });
      }catch(e){
        setMsg($("import_msg"), "Excel 解析失敗：" + (e?.message || String(e)));
        return;
      }

      if (!rows || rows.length < 3){
        setMsg($("import_msg"), "檔案內容太少，至少要有：第1列日期、第3列起人員資料");
        return;
      }

      const dateRow = rows[0] || [];
      const dataStartRow = 2;
      const dateCols = [];
      for (let c = 1; c < dateRow.length; c++){ // B欄起
        const iso = normDateCell(dateRow[c]);
        if (iso) dateCols.push({ c, iso });
      }

      if (!dateCols.length){ setMsg($("import_msg"), "找不到日期列（第 1 列 B1 起）"); return; }

      const allDates = dateCols.map(x => x.iso).sort();
      const minDate = allDates[0];
      const maxDate = allDates[allDates.length - 1];
      const out = [];

      for (let r = dataStartRow; r < rows.length; r++){ // 第3列起
        const name = String(rows[r]?.[0] ?? "").trim();
        if (!name) continue;
        for (const dc of dateCols){
          const v = rows[r]?.[dc.c];
          const shift = String(v ?? "").trim();
          if (!shift) continue;
          out.push({ site_id: siteId, work_date: dc.iso, person_name: name, shift, imported_by: meUid });
        }
      }

      if (!out.length){ setMsg($("import_msg"), "沒有可匯入的班表內容（交叉格皆空白）"); return; }

      const namesInFile = Array.from(new Set(out.map(x => (x.person_name||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      const ym = String(minDate).slice(0,7); 

      setMsg($("import_msg"), `準備寫入 ${out.length} 筆（${minDate} ～ ${maxDate}）\n先清除既有資料…`);

      // 1. 清除舊班表
      const del = await supabase.from("site_schedules").delete().eq("site_id", siteId).gte("work_date", minDate).lte("work_date", maxDate);
      if (del.error){ setMsg($("import_msg"), "清除舊資料失敗：" + del.error.message); return; }

      // 2. 更新本月名單 (site_month_people)
      await supabase.from("site_month_people").delete().eq("site_id", siteId).eq("ym", ym);
      if (namesInFile.length){
        const rosterRows = namesInFile.map(n => ({ site_id: siteId, ym, person_name: n }));
        await supabase.from("site_month_people").insert(rosterRows);
      }

      // 3. 寫入新班表
      const chunkSize = 500;
      for (let i = 0; i < out.length; i += chunkSize){
        const chunk = out.slice(i, i + chunkSize);
        const ins = await supabase.from("site_schedules").insert(chunk);
        if (ins.error){ setMsg($("import_msg"), `寫入失敗（第 ${i+1}～${i+chunk.length} 筆）：` + ins.error.message); return; }
      }

      setMsg($("import_msg"), `匯入完成：${out.length} 筆（${minDate} ～ ${maxDate}）`, true);
    }

    init();
  </script>
</body>
</html>