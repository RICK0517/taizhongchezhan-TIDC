<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç­è¡¨åŠƒå¡</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;padding:20px;max-width:100%}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .card{border:1px solid #ddd;border-radius:10px;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,0.05);background:#fff;}
    
    /* è©¦ç®—è¡¨æ¨£å¼æ ¸å¿ƒ */
    #month_wrap{overflow-x:auto; margin-top:10px; border:1px solid #ccc;}
    table{border-collapse:collapse;width:max-content}
    th, td{border:1px solid #ccc;text-align:center;padding:0;min-width:60px;height:42px;font-size:14px;position:relative;}
    th{background:#f0f0f0;font-weight:bold;position:sticky;top:0;z-index:2;padding:5px;}
    .name-col{position:sticky;left:0;z-index:3;background:#fafafa;min-width:90px;font-weight:bold;border-right:2px solid #ddd;}
    
    /* è¼¸å…¥æ¡†æ¨£å¼ - åƒ Excel ä¸€æ¨£ */
    .sheet-input {
        width: 100%; height: 100%; border: none; outline: none;
        text-align: center; font-size: 14px; font-family: inherit;
        background: transparent; color: #333; padding: 0; margin: 0;
        cursor: text;
    }
    .sheet-input:focus { background: #e3f2fd; box-shadow: inset 0 0 0 2px #2196f3; }
    
    /* ç‹€æ…‹é¡è‰² (ä¾æ“šæ–‡å­—å…§å®¹è‡ªå‹•è®Šè‰²) */
    .st-off { color: #d32f2f; background-color: #ffebee; } /* ä¼‘/å‡ */
    .st-leave { color: #e65100; background-color: #fff3e0; } /* è«‹å‡ */
    .st-work { color: #333; }
    
    .today-col { background-color: #fff9c4 !important; border-left: 2px solid #fbc02d; border-right: 2px solid #fbc02d; }
    
    /* å½ˆçª—æ¨£å¼ */
    dialog { border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 20px; max-width: 400px; width:90%; }
    dialog::backdrop { background: rgba(0,0,0,0.4); }
    .grid-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
    .picker-btn { padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; font-weight: bold; }
    .picker-btn:hover { background: #f0f0f0; transform: scale(1.02); }
    .btn-w { color: #1565c0; border-color: #90caf9; background: #e3f2fd; }
    .btn-h { color: #c62828; border-color: #ef9a9a; background: #ffebee; }
    .btn-l { color: #ef6c00; border-color: #ffcc80; background: #fff3e0; }
    
    /* å„²å­˜ç‹€æ…‹æŒ‡ç¤º */
    .saving { opacity: 0.5; }
    .saved { animation: flashGreen 0.5s; }
    @keyframes flashGreen { 0% { background: #dcfce7; } 100% { background: transparent; } }
  </style>
</head>
<body>

<div class="bar">
    <h2 style="margin:0">æ’ç­åŠƒå¡ (é›™æ“Šé–‹å•ŸæŒ‰éˆ•)</h2>
</div>

<section class="card">
    <div class="bar" style="margin-bottom:10px">
        <div>
            <button onclick="changeMonth(-1)">â—€ ä¸Šæœˆ</button>
            <input type="month" id="month_picker" style="font-size:16px;padding:4px">
            <button onclick="changeMonth(1)">ä¸‹æœˆ â–¶</button>
        </div>
        <button onclick="scrollToToday()" style="background:#fff9c4;border:1px solid #fbc02d;cursor:pointer;padding:4px 10px;">è·³è‡³ä»Šå¤©</button>
    </div>
    <div id="loading" style="display:none;color:#666">è®€å–ä¸­...</div>
    <div style="font-size:12px;color:#666;margin-bottom:6px;">
        ğŸ’¡ æç¤ºï¼šé»æ“Šæ ¼å­å¯<b>ç›´æ¥æ‰“å­—</b>ï¼Œç§»é–‹å³å„²å­˜ï¼›<b>é›™æ“Š (Double Click)</b> å¯å«å‡ºå¿«é€Ÿé¸å–®ã€‚
    </div>
    <div id="month_wrap">
        <table id="schedule_table"></table>
    </div>
</section>

<dialog id="shift_dialog">
    <h3 style="margin:0 0 10px 0; text-align:center" id="dialog_title">å¿«é€Ÿé¸æ“‡</h3>
    <div class="grid-btns">
        <button class="picker-btn btn-w" onclick="pickVal('æ—©ç­')">æ—©ç­</button>
        <button class="picker-btn btn-w" onclick="pickVal('9-17')">9-17</button>
        <button class="picker-btn btn-w" onclick="pickVal('ä¸­ç­')">ä¸­ç­</button>
        <button class="picker-btn btn-w" onclick="pickVal('14-22')">14-22</button>
        <button class="picker-btn btn-w" onclick="pickVal('17-22')">é˜¿å‡±å¿«æ¨‚ç­</button>
        <button class="picker-btn btn-w" onclick="pickVal('æ™šç­')">æ™šç­</button>
        <button class="picker-btn btn-w" onclick="pickVal('å…¨å¤©')">å…¨å¤©</button>
        <button class="picker-btn btn-h" onclick="pickVal('ä¼‘')">æ’ä¼‘</button>
        <button class="picker-btn btn-h" onclick="pickVal('è¡Œæ”¿')">è¡Œæ”¿</button>
        <button class="picker-btn btn-l" onclick="pickVal('ç‰¹ä¼‘')">ç‰¹ä¼‘</button>
        <button class="picker-btn btn-l" onclick="pickVal('äº‹å‡')">äº‹å‡</button>
        <button class="picker-btn btn-l" onclick="pickVal('ç—…å‡')">ç—…å‡</button>
        <button class="picker-btn btn-l" onclick="pickVal('å…¬å‡')">å…¬å‡</button>
        <button class="picker-btn btn-l" onclick="pickVal('å©šå‡')">å©šå‡</button>
        <button class="picker-btn btn-l" onclick="pickVal('å–ªå‡')">å–ªå‡</button>
        <button class="picker-btn" style="grid-column:span 3;color:#888" onclick="pickVal('')">æ¸…é™¤ (ç©ºç™½)</button>
    </div>
    <button onclick="closeDialog()" style="width:100%;margin-top:15px;padding:8px;cursor:pointer">å–æ¶ˆ</button>
</dialog>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const sb = createClient("https://whbllncddoqbwukstxel.supabase.co", "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2");
const $ = id => document.getElementById(id);
const params = new URLSearchParams(window.location.search);
const currentSiteId = params.get("site_id");

let currentRole = "";
let activeCell = null; // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ input å…ƒç´ 

(async () => {
    const {data:{session}} = await sb.auth.getSession();
    if(!session) { location.href="./index.html"; return; }
    if(!currentSiteId) { alert("ç„¡æ•ˆçš„å ´åŸŸåƒæ•¸"); return; }
    
    const uid = session.user.id;
    const {data:mem} = await sb.from("site_memberships").select("role").eq("user_id",uid).eq("site_id",currentSiteId).maybeSingle();
    if(!mem) return alert("ç„¡æ¬Šé™");
    currentRole = mem.role;
    
    const now = new Date();
    $("month_picker").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    $("month_picker").onchange = () => loadSchedule();
    loadSchedule();
    
    window.changeMonth = (d) => {
        const [y, m] = $("month_picker").value.split("-").map(Number);
        const dt = new Date(y, m-1+d, 1);
        $("month_picker").value = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        loadSchedule();
    }
    window.scrollToToday = () => {
        const el = document.querySelector(".today-col");
        if(el) el.scrollIntoView({behavior:"smooth", inline:"center"});
    }
    window.closeDialog = () => $("shift_dialog").close();

    // è™•ç†å¿«é€Ÿé¸å–®é»æ“Š
    window.pickVal = (val) => {
        if(activeCell) {
            activeCell.value = val;
            saveCell(activeCell); // è§¸ç™¼å„²å­˜
        }
        $("shift_dialog").close();
    };
})();

// æ±ºå®šé¡è‰²æ¨£å¼
function getColorClass(val){
    if(!val) return "";
    if(["ä¼‘","åœ‹å®š"].includes(val)) return "st-off";
    if(["è¡Œæ”¿","ç‰¹ä¼‘","äº‹å‡","ç—…å‡","å–ªå‡","å…¬å‡","å©šå‡","ç”¢å‡","é™ªç”¢"].includes(val)) return "st-leave";
    return "st-work"; // é è¨­å·¥ä½œè‰²
}

async function loadSchedule(){
    const ym = $("month_picker").value;
    if(!currentSiteId || !ym) return;
    
    $("loading").style.display="block";
    const [y, m] = ym.split("-").map(Number);
    const daysInMonth = new Date(y, m, 0).getDate();
    const startDate = `${ym}-01`;
    const endDate = `${ym}-${daysInMonth}`;
    
    const { data: rows } = await sb.from("site_schedules")
        .select("work_date, person_name, shift")
        .eq("site_id", currentSiteId)
        .gte("work_date", startDate).lte("work_date", endDate);
        
    const map = {}; 
    const nameSet = new Set();
    (rows||[]).forEach(r => {
        if(!map[r.person_name]) map[r.person_name] = {};
        map[r.person_name][r.work_date] = r.shift;
        nameSet.add(r.person_name);
    });
    const names = Array.from(nameSet).sort();
    
    const table = $("schedule_table");
    table.innerHTML = "";
    
    // è¡¨é ­
    const trH = document.createElement("tr");
    trH.innerHTML = `<th class="name-col" style="z-index:5">å§“å</th>`;
    const todayStr = new Date().toISOString().slice(0,10);
    
    for(let d=1; d<=daysInMonth; d++){
        const dateIso = `${ym}-${String(d).padStart(2,'0')}`;
        const dayOfWeek = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][new Date(dateIso).getDay()];
        const isToday = (dateIso === todayStr);
        trH.innerHTML += `<th class="${isToday?'today-col':''}">${d}<br><span style="font-weight:normal;font-size:11px">${dayOfWeek}</span></th>`;
    }
    table.appendChild(trH);
    
    // å…§å®¹
    const isEditable = (currentRole === 'engineer' || currentRole === 'supervisor');

    names.forEach(name => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="name-col">${name}</td>`;
        for(let d=1; d<=daysInMonth; d++){
            const dateIso = `${ym}-${String(d).padStart(2,'0')}`;
            const val = map[name][dateIso] || "";
            const isToday = (dateIso === todayStr);
            const cellId = `c_${name}_${d}`;
            
            // å»ºç«‹è¼¸å…¥æ¡† Cell
            const td = document.createElement("td");
            if(isToday) td.className = "today-col";
            
            if(isEditable){
                const input = document.createElement("input");
                input.className = `sheet-input ${getColorClass(val)}`;
                input.value = val;
                input.dataset.name = name;
                input.dataset.date = dateIso;
                
                // äº‹ä»¶ 1: å¤±å»ç„¦é»æˆ–æŒ‰ Enter æ™‚å„²å­˜
                input.onblur = () => saveCell(input);
                input.onkeydown = (e) => { if(e.key==='Enter') input.blur(); };
                
                // äº‹ä»¶ 2: é›™æ“Šæ‰“é–‹é¸å–®
                input.ondblclick = () => {
                    activeCell = input;
                    $("dialog_title").textContent = `${name} - ${dateIso.slice(5)}`;
                    $("shift_dialog").showModal();
                };

                td.appendChild(input);
            } else {
                td.textContent = val;
                td.className += " " + getColorClass(val);
            }
            tr.appendChild(td);
        }
        table.appendChild(tr);
    });
    $("loading").style.display="none";
}

// å„²å­˜é‚è¼¯
async function saveCell(input){
    const name = input.dataset.name;
    const date = input.dataset.date;
    const val = input.value.trim();
    
    // æ›´æ–°é¡è‰²
    input.className = `sheet-input ${getColorClass(val)}`;
    
    // UI åé¥‹
    const td = input.parentElement;
    td.classList.add("saving");

    try {
        await sb.from("site_schedules").delete().eq("site_id", currentSiteId).eq("work_date", date).eq("person_name", name);
        if(val){
            await sb.from("site_schedules").insert({ site_id: currentSiteId, work_date: date, person_name: name, shift: val });
        }
        td.classList.remove("saving");
        td.classList.add("saved"); // é–ƒçˆç¶ è‰²
        setTimeout(() => td.classList.remove("saved"), 500);
    } catch(e) {
        alert("å„²å­˜å¤±æ•—: " + e.message);
        td.classList.remove("saving");
    }
}
</script>
</body>
</html>