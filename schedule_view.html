<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŸ¥çœ‹ç­è¡¨</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:28px auto;padding:0 14px}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
    input,select,button{padding:10px}
    button{font-weight:700;cursor:pointer}
    .small{opacity:.75;font-size:13px;line-height:1.4}
    .msg{margin-top:10px;color:#b00020;white-space:pre-wrap}
    .ok{color:#0a7a2f}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  
    /* ===== æœˆç­è¡¨ ===== */
    #month_wrap{border:1px solid #eee;border-radius:10px;padding:10px;background:#fff}
    #month_table th,#month_table td{border:1px solid #eee;padding:0;font-size:12px;white-space:nowrap; height: 36px; vertical-align: middle;}
    #month_table th{background:#fafafa;font-weight:700; padding: 6px 8px;}
    #month_table .wk{font-weight:600;opacity:.75;background:#fcfcfc}
    #month_table .namecell{font-weight:700;background:#fcfcfc;position:sticky;left:0;z-index:2; padding: 6px 8px; border-right: 2px solid #eee;}
    #month_table .headsticky{position:sticky;top:0;z-index:3}
    #month_table .cellshift{min-width:52px;text-align:center; padding: 6px 8px;}
    
    /* ===== ç›´æ¥ç·¨è¼¯è¼¸å…¥æ¡†æ¨£å¼ ===== */
    .month-input {
        width: 100%; height: 100%; border: none; 
        background: transparent; text-align: center; 
        font-size: 13px; padding: 8px 4px;
        min-width: 50px;
        font-family: inherit;
        outline: none;
        transition: background 0.2s;
        cursor: pointer;
    }
    .month-input:focus {
        background: #fff;
        box-shadow: inset 0 0 0 2px #2196f3;
        cursor: text;
        z-index: 10;
        position: relative;
    }
    
    /* ===== ä»Šæ—¥é«˜äº®æ¨£å¼ ===== */
    .today-col {
        background-color: #fff9c4 !important; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
        border-left: 2px solid #fbc02d !important;
        border-right: 2px solid #fbc02d !important;
    }
    .today-header {
        background-color: #fff9c4 !important;
        color: #f57f17;
        font-weight: 800 !important;
        border-top: 2px solid #fbc02d !important;
    }

    /* ç‹€æ…‹å›é¥‹ */
    .saving-cell { background-color: #fff3e0 !important; } 
    .saved-cell { background-color: #e8f5e9 !important; animation: fadeOut 1.5s forwards; } 
    .error-cell { background-color: #ffebee !important; } 

    @keyframes fadeOut {
        0% { background-color: #e8f5e9; }
        100% { background-color: transparent; }
    }

    /* ===== ç­åˆ¥é¡è‰²è¦å‰‡ ===== */
    .shift-red{ color:#d10000; font-weight:700; }
    .shift-orange{ color:#e67e00; font-weight:700; }
    
  </style>
</head>
<body>
  <div class="bar">
    <div>
      <h1 style="margin:0">æŸ¥çœ‹ç­è¡¨</h1>
      <div class="small" id="site_line">è®€å–ä¸­â€¦</div>
      <div class="small" id="role_line" style="margin-top:6px"></div>
      <div id="msg" class="msg"></div>
    </div>
    <div class="row">
      <select id="site_sel" style="min-width:240px"></select>
      <button id="btn_back">å›ä¸»æ§å°</button>
      <button id="btn_logout">ç™»å‡º</button>
    </div>
  </div>

  
<section class="card" id="month_card">
  <div class="row" style="justify-content:space-between">
    <div>
      <h2 style="margin:0">æœˆç­è¡¨</h2>
      <div class="small" id="month_hint" style="margin-top:6px">è®€å–ä¸­â€¦</div>
    </div>
    <div class="row">
      <button id="btn_jump_today" style="background:#fff9c4; border:1px solid #fbc02d; color:#f57f17;">è·³è‡³ä»Šå¤©</button>
      <button id="btn_m_prev">ä¸Šå€‹æœˆ</button>
      <input id="month_sel" type="month" />
      <button id="btn_m_next">ä¸‹å€‹æœˆ</button>
      <button id="btn_m_reload">é‡æ–°è¼‰å…¥</button>
    </div>
  </div>
  <div id="month_wrap" style="margin-top:12px;overflow-x:auto">
    <table id="month_table" style="width:max-content;border-collapse:collapse"></table>
  </div>
  <div class="small" style="margin-top:10px;line-height:1.5; color:#666;">
    ğŸ’¡ æç¤ºï¼šé»æ“Šæ ¼å­ç›´æ¥è¼¸å…¥ç­åˆ¥ï¼Œç§»é–‹æ¸¸æ¨™å³è‡ªå‹•å„²å­˜ã€‚é»ƒè‰²æ¬„ä½ç‚ºä»Šæ—¥ã€‚
  </div>
</section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    function setMsg(t, ok=false){ const el=$("msg"); el.textContent=t||""; el.className = ok ? "msg ok" : "msg"; }
    function escapeHtml(s){ return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function isManagerRole(role){ return role === "engineer" || role === "supervisor"; }
    function roleLabel(role){ if (role==="engineer") return "å·¥ç¨‹å¸«"; if (role==="supervisor") return "ä¸»ç®¡"; if (role==="employee") return "å“¡å·¥"; return role||"æœªçŸ¥"; }
    function toISODateLocal(d){ const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }

    function getQueryParam(k){ return new URL(location.href).searchParams.get(k); }

    async function requireSession(){
      const { data, error } = await supabase.auth.getSession();
      if (error) return null;
      if (!data.session) { location.href = "./index.html"; return null; }
      return data.session;
    }

    async function loadMe(){
      const sess = await requireSession();
      if (!sess) return null;
      const uid = sess.user.id;

      const p = await supabase.from("profiles").select("username,display_name").eq("user_id", uid).single();
      const m = await supabase.from("site_memberships").select("site_id,role,is_active").eq("user_id", uid).eq("is_active", true);

      if (p.error) throw new Error("profilesï¼š" + p.error.message);
      if (m.error) throw new Error("membershipï¼š" + m.error.message);

      return { uid, username: p.data.username, name: p.data.display_name||"", memberships: m.data||[] };
    }

    async function loadSites(siteIds){
      const s = await supabase.from("sites").select("id,code,name");
      if (s.error) throw new Error("sitesï¼š" + s.error.message);
      const map = {};
      for (const it of s.data) map[it.id] = it;
      return siteIds.map(id => map[id]).filter(Boolean);
    }

    function getShiftClass(shiftText) {
        if (!shiftText) return "";
        if (["ä¼‘","å–ªå‡","äº‹å‡","ç—…å‡"].includes(shiftText)) return "shift-red";
        if (["ç‰¹ä¼‘","è¡Œæ”¿"].includes(shiftText)) return "shift-orange";
        return "";
    }

    // ===== æœˆç­è¡¨é‚è¼¯ =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoFromYMD(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
    function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
    function weekdayZh(d){
      const w = d.getDay();
      return ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][w] || "";
    }

    // è™•ç†æœˆç­è¡¨æ ¼å­è®Šæ›´ (è‡ªå‹•å„²å­˜)
    window.handleCellChange = async function(input) {
        const newVal = input.value.trim();
        const date = input.dataset.date;
        const name = input.dataset.name;
        const siteId = $("site_sel").value;

        const td = input.parentElement;
        td.classList.add("saving-cell");
        td.classList.remove("saved-cell", "error-cell");

        try {
            await supabase.from("site_schedules").delete()
                .eq("site_id", siteId)
                .eq("work_date", date)
                .eq("person_name", name);
            
            if (newVal) {
                const { error } = await supabase.from("site_schedules").insert({
                    site_id: siteId,
                    work_date: date,
                    person_name: name,
                    shift: newVal
                });
                if (error) throw error;
            }

            td.classList.remove("saving-cell");
            td.classList.add("saved-cell");
            input.className = "month-input " + getShiftClass(newVal);

        } catch(err) {
            console.error(err);
            td.classList.remove("saving-cell");
            td.classList.add("error-cell");
            setMsg("å„²å­˜å¤±æ•—ï¼š" + err.message);
        }
    };

    // æ²å‹•åˆ°ä»Šå¤©çš„é‚è¼¯
    function scrollToToday() {
        const todayEl = document.querySelector('.today-header');
        if (todayEl) {
            todayEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
            // å¦‚æœä»Šå¤©ä¸åœ¨ç•¶æœˆï¼Œåˆ‡æ›åˆ°ç•¶æœˆ
            const now = new Date();
            const currentYM = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
            if($("month_sel").value !== currentYM) {
                $("month_sel").value = currentYM;
                $("month_sel").dispatchEvent(new Event('change')); // è§¸ç™¼é‡æ•´
            }
        }
    }

    async function refreshMonth(siteId, roleCur, siteList){
      const hint = $("month_hint");
      const table = $("month_table");
      const monthInput = $("month_sel");
      if (!hint || !table || !monthInput) return;

      // æ›´æ–°ä¸Šæ–¹çš„è³‡è¨Šåˆ— (é€™æ˜¯ä¿®å¾©çš„é—œéµ)
      const s = siteList.find(x => x.id === siteId);
      $("site_line").textContent = s ? `ç›®å‰å ´åŸŸï¼š${s.name} (${s.code})` : `ç›®å‰å ´åŸŸï¼š${siteId}`;
      $("role_line").textContent = `ä½ çš„èº«åˆ†ï¼š${roleLabel(roleCur)}`;

      const ym = monthInput.value;
      if (!ym){ hint.textContent = "è«‹é¸æ“‡æœˆä»½"; return; }
      const [Y, M] = ym.split("-").map(x => parseInt(x,10));
      if (!Y || !M){ hint.textContent = "æœˆä»½æ ¼å¼éŒ¯èª¤"; return; }

      const dim = daysInMonth(Y, M);
      const start = isoFromYMD(Y, M, 1);
      const end = isoFromYMD(Y, M, dim);
      const canEdit = isManagerRole(roleCur);
      
      // è¨ˆç®—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²
      const todayStr = toISODateLocal(new Date());

      hint.textContent = "è®€å–ä¸­â€¦";
      table.innerHTML = "";

      const q = await supabase
        .from("site_schedules")
        .select("work_date,person_name,shift")
        .eq("site_id", siteId)
        .gte("work_date", start)
        .lte("work_date", end);

      if (q.error){
        hint.textContent = "è®€å–å¤±æ•—ï¼š" + q.error.message;
        return;
      }

      const rows = q.data || [];
      const nameSet = new Set(rows.map(r => String(r.person_name||"").trim()).filter(Boolean));
      const names = Array.from(nameSet).sort((a,b)=>a.localeCompare(b, "zh-Hant"));

      const dates = [];
      for (let d=1; d<=dim; d++){
        const iso = isoFromYMD(Y,M,d);
        const dt = new Date(`${iso}T00:00:00`);
        const isToday = (iso === todayStr);
        dates.push({ iso, label: `${M}æœˆ${d}æ—¥`, wk: weekdayZh(dt), isToday });
      }

      const mp = new Map();
      for (const r of rows){
        const name = String(r.person_name||"").trim();
        const date = r.work_date;
        const shift = String(r.shift||"").trim();
        if (!name || !date) continue;
        if (!mp.has(name)) mp.set(name, new Map());
        mp.get(name).set(date, shift);
      }

      // Render Header (æ—¥æœŸ)
      const tr1 = document.createElement("tr");
      tr1.innerHTML = `<th class="headsticky namecell">å§“å</th>` + 
        dates.map(d => `<th class="headsticky ${d.isToday ? 'today-header' : ''}" title="${d.wk}">${d.label}</th>`).join("");
      table.appendChild(tr1);

      // Render Header (æ˜ŸæœŸ)
      const tr2 = document.createElement("tr");
      tr2.innerHTML = `<th class="headsticky wk namecell">ã€€</th>` + 
        dates.map(d => `<th class="headsticky wk ${d.isToday ? 'today-col' : ''}">${d.wk}</th>`).join("");
      table.appendChild(tr2);

      // Render Body
      for (const name of names){
        const tr = document.createElement("tr");
        const rowMap = mp.get(name) || new Map();
        let tds = `<td class="namecell">${escapeHtml(name)}</td>`;
        
        for (const d of dates){
          const shiftText = rowMap.get(d.iso) || "";
          const cls = getShiftClass(shiftText);
          const todayClass = d.isToday ? 'today-col' : '';

          if (canEdit) {
            tds += `<td class="${todayClass}">
                <input class="month-input ${cls}" 
                       data-date="${d.iso}" 
                       data-name="${escapeHtml(name)}" 
                       value="${escapeHtml(shiftText)}" 
                       onfocus="this.select()"
                       onchange="window.handleCellChange(this)">
            </td>`;
          } else {
            tds += `<td class="cellshift ${cls} ${todayClass}">${escapeHtml(shiftText)}</td>`;
          }
        }
        tr.innerHTML = tds;
        table.appendChild(tr);
      }

      hint.textContent = `æœˆä»½ï¼š${ym}ï½œäººå“¡ï¼š${names.length}ï½œç­†æ•¸ï¼š${rows.length}`;

      // è‡ªå‹•æ²å‹•åˆ°ä»Šå¤©
      setTimeout(scrollToToday, 100);
    }


    async function main(){
      $("btn_back").onclick = () => location.href = "./app.html";
      $("btn_logout").onclick = async () => { await supabase.auth.signOut(); location.href = "./index.html"; };

      let me;
      try {
        me = await loadMe();
      } catch(e) {
        setMsg("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š" + (e?.message || String(e)));
        return;
      }

      const siteIds = me.memberships.map(x => x.site_id);
      const siteList = await loadSites(siteIds);

      const sel = $("site_sel");
      sel.innerHTML = "";
      for (const s of siteList){
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name} (${s.code})`;
        sel.appendChild(opt);
      }

      const qp = getQueryParam("site_id");
      const initSite = (qp && siteIds.includes(qp)) ? qp : (siteList[0]?.id || "");
      if (!initSite){ setMsg("ä½ æ²’æœ‰ä»»ä½•å¯ç”¨å ´åŸŸï¼ˆmembership=0ï¼‰ã€‚"); return; }
      sel.value = initSite;

      // å–å¾—èº«åˆ†
      const getRole = () => (me.memberships.find(x => x.site_id === sel.value)?.role) || "";

      // ===== æœˆç­è¡¨åˆå§‹åŒ– =====
      const monthInput = $("month_sel");
      if (monthInput){
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      }
      const shiftMonth = (delta) => {
        if (!monthInput || !monthInput.value) return;
        const [Y,M] = monthInput.value.split("-").map(x=>parseInt(x,10));
        const dt = new Date(Y, (M-1)+delta, 1);
        monthInput.value = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;
      };
      
      // æ³¨æ„ï¼šé€™è£¡å¤šå‚³äº† siteList
      const doRefreshMonth = async () => await refreshMonth(sel.value, getRole(), siteList);

      const btnPrev = $("btn_m_prev");
      const btnNext = $("btn_m_next");
      const btnReload = $("btn_m_reload");
      if (btnPrev) btnPrev.onclick = async () => { shiftMonth(-1); await doRefreshMonth(); };
      if (btnNext) btnNext.onclick = async () => { shiftMonth(1); await doRefreshMonth(); };
      if (btnReload) btnReload.onclick = async () => { await doRefreshMonth(); };
      if (monthInput) monthInput.onchange = async () => { await doRefreshMonth(); };
      
      // æ–°å¢ï¼šè·³è‡³ä»Šå¤©æŒ‰éˆ•
      $("btn_jump_today").onclick = () => scrollToToday();

      // åˆæ¬¡è¼‰å…¥æœˆç­è¡¨
      await doRefreshMonth();
      
      sel.onchange = async () => { await doRefreshMonth(); };
    }

    main();
  </script>
</body>
</html>