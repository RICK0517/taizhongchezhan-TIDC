<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŠ ç­ç®¡ç†</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:20px auto;padding:0 14px;background:#f5f7f9}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 5px rgba(0,0,0,0.03)}
    
    label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:#555}
    input,select,textarea,button{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box}
    input:focus,select:focus,textarea:focus{border-color:#2196f3;outline:none}
    
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px}
    
    button{background:#2563eb;color:#fff;font-weight:700;cursor:pointer;border:none;transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button.secondary{background:#64748b}
    
    .record-item{border-bottom:1px solid #eee;padding:12px 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .record-item:last-child{border-bottom:none}
    .tag{padding:2px 8px;border-radius:12px;font-size:12px;background:#eee;color:#333;margin-right:6px}
    .tag-blue{background:#e3f2fd;color:#1565c0}
    .tag-orange{background:#fff3e0;color:#ef6c00}
    
    .msg{margin-top:10px;padding:10px;border-radius:6px;display:none}
    .msg.ok{background:#dcfce7;color:#15803d;display:block}
    .msg.err{background:#fee2e2;color:#b91c1c;display:block}
  </style>
</head>
<body>

  <div class="bar">
    <div>
      <h1 style="margin:0">åŠ ç­ç®¡ç†</h1>
      <div id="site_info" style="font-size:13px;color:#666;margin-top:4px">è®€å–ä¸­...</div>
    </div>
  </div>

  <section class="card">
    <h2 style="margin-top:0;border-left:4px solid #2563eb;padding-left:10px">æ–°å¢åŠ ç­ç´€éŒ„</h2>
    
    <div class="grid">
        <div>
            <label>1. åŠ ç­åŸå› </label>
            <select id="reason_cat" onchange="toggleOtherInput()">
                <option value="æ–½å·¥">ğŸš§ æ–½å·¥</option>
                <option value="ä»£ç­">ğŸ‘¥ ä»£ç­</option>
                <option value="å…¶ä»–">âœï¸ å…¶ä»– (è«‹è¼¸å…¥)</option>
            </select>
            <input id="reason_detail" placeholder="è«‹è¼¸å…¥åŸå› ..." style="margin-top:6px;display:none;">
        </div>

        <div>
            <label>2. åŠ ç­åˆ¥</label>
            <select id="ot_type">
                <option value="ä¼‘å‡æ—¥åŠ ç­">ğŸ–ï¸ ä¼‘å‡æ—¥åŠ ç­</option>
                <option value="å¹³æ—¥æ—©å‡º">â˜€ï¸ å¹³æ—¥æ—©å‡º</option>
                <option value="å¹³æ—¥å»¶å¾Œ">ğŸŒ™ å¹³æ—¥å»¶å¾Œ</option>
            </select>
        </div>

        <div>
            <label>3. åŠ ç­äººå“¡</label>
            <select id="target_user">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <div>
            <label>4. åŠ ç­æ—¥æœŸ</label>
            <input type="date" id="work_date">
        </div>

        <div>
            <label>5. æ™‚æ•¸ (å°æ™‚)</label>
            <input type="number" id="hours" step="0.5" placeholder="ä¾‹å¦‚: 2.0">
        </div>
    </div>

    <div style="margin-top:16px">
        <label>6. å‚™è¨» (é¸å¡«)</label>
        <textarea id="note" rows="2" placeholder="è£œå……èªªæ˜..."></textarea>
    </div>

    <button id="btn_submit" style="margin-top:16px">é€å‡ºç´€éŒ„</button>
    <div id="msg" class="msg"></div>
  </section>

  <section class="card">
    <h2 style="margin-top:0">è¿‘æœŸç´€éŒ„ (æœ€è¿‘ 20 ç­†)</h2>
    <div id="list_box">
        <div style="color:#888;font-size:13px">è¼‰å…¥ä¸­...</div>
    </div>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const $ = id => document.getElementById(id);
    let myUid = "";

    const params = new URLSearchParams(window.location.search);
    const currentSiteId = params.get("site_id");

    window.toggleOtherInput = function() {
        const val = $("reason_cat").value;
        $("reason_detail").style.display = (val === "å…¶ä»–") ? "block" : "none";
    }

    async function init() {
        if(!currentSiteId) { $("site_info").textContent = "éŒ¯èª¤ï¼šç„¡å ´åŸŸID"; return; }

        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { location.href = "./index.html"; return; }
        myUid = session.user.id;
        
        // é©—è­‰ä¸¦å–å¾—å ´åŸŸåç¨±
        const { data: site } = await supabase.from("sites").select("name").eq("id", currentSiteId).single();
        const { data: mem } = await supabase.from("site_memberships").select("role").eq("user_id", myUid).eq("site_id", currentSiteId).maybeSingle();

        if (!mem) { $("site_info").textContent = "ç„¡æ­¤å ´åŸŸæ¬Šé™"; return; }
        $("site_info").textContent = `å ´åŸŸï¼š${site?.name} ï½œ æ‚¨çš„èº«åˆ†ï¼š${roleLabel(mem.role)}`;

        $("work_date").value = new Date().toISOString().slice(0, 10);
        
        loadSiteData(currentSiteId);
        $("btn_submit").onclick = submitForm;
    }

    async function loadSiteData(siteId) {
        // A. è¼‰å…¥è©²å ´åŸŸäººå“¡æ¸…å–®
        const userSel = $("target_user");
        userSel.innerHTML = "<option>è¼‰å…¥ä¸­...</option>";
        
        const { data: people } = await supabase.rpc("get_site_people", { p_site_id: siteId });
        
        userSel.innerHTML = "";
        if (people) {
            people.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.user_id;
                opt.textContent = p.display_name || p.username;
                userSel.appendChild(opt);
            });
        }
        // B. è¼‰å…¥æ­·å²ç´€éŒ„
        loadHistory(siteId);
    }

    async function submitForm() {
        const msg = $("msg"); msg.className = "msg"; 
        const reasonCat = $("reason_cat").value;
        const reasonDetail = $("reason_detail").value;
        const otType = $("ot_type").value;
        const targetUser = $("target_user").value;
        const workDate = $("work_date").value;
        const hours = $("hours").value;
        const note = $("note").value;

        if (!targetUser) return showMsg("è«‹é¸æ“‡åŠ ç­äººå“¡", false);
        if (!workDate) return showMsg("è«‹é¸æ“‡æ—¥æœŸ", false);
        if (!hours || parseFloat(hours) <= 0) return showMsg("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚æ•¸", false);
        if (reasonCat === "å…¶ä»–" && !reasonDetail) return showMsg("è«‹è¼¸å…¥å…¶ä»–åŸå› èªªæ˜", false);

        $("btn_submit").textContent = "è™•ç†ä¸­...";
        $("btn_submit").disabled = true;

        const { error } = await supabase.from("overtime_records").insert({
            site_id: currentSiteId,
            user_id: targetUser,
            overtime_type: otType,
            reason_category: reasonCat,
            reason_detail: (reasonCat === "å…¶ä»–") ? reasonDetail : null,
            work_date: workDate,
            hours: hours,
            note: note,
            created_by: myUid
        });

        $("btn_submit").textContent = "é€å‡ºç´€éŒ„";
        $("btn_submit").disabled = false;

        if (error) showMsg("å¤±æ•—ï¼š" + error.message, false);
        else {
            showMsg("æ–°å¢æˆåŠŸï¼", true);
            $("hours").value = ""; $("note").value = "";
            loadHistory(currentSiteId);
        }
    }

    async function loadHistory(siteId) {
        const box = $("list_box");
        box.innerHTML = `<div style="color:#888;font-size:13px">æ›´æ–°ä¸­...</div>`;

        const { data, error } = await supabase.from("overtime_records")
            .select(`*, profiles:user_id ( display_name, username )`)
            .eq("site_id", siteId)
            .order("created_at", { ascending: false }).limit(20);

        if (error || !data) { box.innerHTML = `<div style="color:red">è®€å–å¤±æ•—</div>`; return; }
        if (data.length === 0) { box.innerHTML = `<div style="color:#888;padding:10px">å°šç„¡ç´€éŒ„</div>`; return; }

        box.innerHTML = "";
        data.forEach(r => {
            const name = r.profiles?.display_name || r.profiles?.username || "æœªçŸ¥äººå“¡";
            const reason = r.reason_category === "å…¶ä»–" ? `å…¶ä»– (${r.reason_detail})` : r.reason_category;
            
            const div = document.createElement("div");
            div.className = "record-item";
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:bold;font-size:15px;margin-bottom:4px">
                        ${name} <span style="font-weight:normal;color:#666">åŠ ç­ ${r.hours} å°æ™‚</span>
                    </div>
                    <div style="font-size:13px;color:#555">
                        <span class="tag tag-blue">${r.overtime_type}</span>
                        <span class="tag tag-orange">${reason}</span>
                        ğŸ“… ${r.work_date}
                    </div>
                    ${r.note ? `<div style="font-size:12px;color:#888;margin-top:4px">å‚™è¨»: ${escapeHtml(r.note)}</div>` : ""}
                </div>
                <div>
                     <button class="secondary" style="padding:4px 8px;font-size:12px;background:#ef5350" onclick="window.delRec('${r.id}')">åˆªé™¤</button>
                </div>
            `;
            box.appendChild(div);
        });
    }

    window.delRec = async function(id) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†åŠ ç­ç´€éŒ„ï¼Ÿ")) return;
        const { error } = await supabase.from("overtime_records").delete().eq("id", id);
        if(error) alert("åˆªé™¤å¤±æ•—:" + error.message);
        else loadHistory(currentSiteId);
    }

    function showMsg(text, isOk) {
        const el = $("msg");
        el.textContent = text;
        el.className = isOk ? "msg ok" : "msg err";
        setTimeout(() => { if(isOk) el.style.display="none"; }, 3000);
    }
    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    function roleLabel(r){ return r==='engineer'?'å·¥ç¨‹å¸«':r==='supervisor'?'ä¸»ç®¡':'å“¡å·¥'; }

    init();
  </script>
</body>
</html>