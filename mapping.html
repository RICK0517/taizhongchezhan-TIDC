<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>人員對照</title>
  <script src="theme.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:20px auto;padding:0 14px; background:var(--bg-color); color:var(--text-color)}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-top:14px; background:var(--card-bg)}
    
    select,button{padding:8px 12px;border:1px solid var(--input-border);border-radius:6px; background:var(--input-bg); color:var(--text-color)}
    button{font-weight:700;cursor:pointer;background:rgba(0,0,0,0.05);}
    button:hover{opacity:0.8}
    
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--border-color);padding:8px 6px;text-align:left;vertical-align:top}
    th{font-size:13px;opacity:.75}
    .small{opacity:.75;font-size:13px;line-height:1.4}
    .msg{margin-top:10px;color:#b00020;white-space:pre-wrap}
    .ok{color:#0a7a2f}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border-color);border-radius:999px;font-size:12px;opacity:.8}
    /* 強調當前場域標題 */
    .site-title { font-size: 1.2rem; font-weight: bold; color: var(--text-color); }
  </style>
</head>
<body>
  <div class="bar">
    <div>
      <h1 style="margin:0">人員對照</h1>
      <div class="small" id="site_line">讀取中…</div>
      <div class="small" id="dbg" style="margin-top:6px"></div>
    </div>
  </div>

  <section class="card">
    <div class="small">
      目的：把「班表姓名」連到「系統帳號」。完成後，可以用這張對照表把班表上的人，對應到 user_id (用於通知、統計等功能)。
    </div>
    <div class="small" style="margin-top:8px">
      顯示來源：目前場域的班表姓名（取近 30 天 + 未來 30 天，去重）。
    </div>
    <div id="msg" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th style="width:34%">班表姓名</th>
          <th style="width:46%">對應帳號（同場域成員）</th>
          <th style="width:20%">操作</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    function setMsg(t, ok=false){ const el=$("msg"); el.textContent=t||""; el.className = ok ? "msg ok" : "msg"; }
    function escapeHtml(s){ return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function isManagerRole(role){ return role === "engineer" || role === "supervisor"; }
    function toISODateLocal(d){
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tz).toISOString().slice(0,10);
    }

    // 從網址參數取得 site_id
    const params = new URLSearchParams(window.location.search);
    const currentSiteId = params.get("site_id");

    async function loadMe(){
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error || !session) { location.href = "./index.html"; return null; }
      const uid = session.user.id;

      // 檢查使用者在此場域的權限
      const m = await supabase.from("site_memberships")
        .select("role, is_active")
        .eq("user_id", uid)
        .eq("site_id", currentSiteId)
        .eq("is_active", true)
        .maybeSingle();

      if (!m) throw new Error("您不屬於此場域或帳號未啟用");
      return { uid, role: m.data.role };
    }

    async function getSiteInfo(siteId){
      const { data } = await supabase.from("sites").select("name, code").eq("id", siteId).single();
      return data;
    }

    async function getSitePeople(siteId){
      // 取得該場域所有成員
      const m = await supabase.from("site_memberships").select("user_id").eq("site_id", siteId).eq("is_active", true);
      const userIds = (m.data || []).map(x => x.user_id);
      if (!userIds.length) return [];

      const p = await supabase.from("profiles").select("user_id,username,display_name").in("user_id", userIds);
      const map = {};
      (p.data || []).forEach(it => { map[it.user_id] = (it.display_name || it.username || it.user_id); });
      return userIds.map(uid => ({ user_id: uid, label: map[uid] || uid }));
    }

    async function getScheduleNames(siteId){
      // 近 30 天 + 未來 30 天
      const today = new Date();
      const from = toISODateLocal(new Date(today.getTime() - 30*86400000));
      const to = toISODateLocal(new Date(today.getTime() + 30*86400000));

      const q = await supabase.from("site_schedules")
        .select("person_name")
        .eq("site_id", siteId)
        .gte("work_date", from)
        .lte("work_date", to);
        
      const set = new Set((q.data || []).map(x => String(x.person_name || "").trim()).filter(Boolean));
      return Array.from(set).sort((a,b) => a.localeCompare(b, "zh-Hant"));
    }

    async function getMappings(siteId){
      const q = await supabase.from("site_person_links").select("person_name,user_id").eq("site_id", siteId);
      const map = {};
      (q.data || []).forEach(r => map[r.person_name] = r.user_id);
      return map;
    }

    async function upsertMapping(siteId, personName, userId){
      const ins = await supabase.from("site_person_links")
        .upsert({ site_id: siteId, person_name: personName, user_id: userId }, { onConflict: "site_id,person_name" });
      if (ins.error) throw new Error(ins.error.message);
    }

    async function deleteMapping(siteId, personName){
      const del = await supabase.from("site_person_links").delete().eq("site_id", siteId).eq("person_name", personName);
      if (del.error) throw new Error(del.error.message);
    }

    async function render(){
      if (!currentSiteId) { setMsg("網址參數缺少 site_id"); return; }
      setMsg("讀取中…");
      const rowsEl = $("rows"); rowsEl.innerHTML = "";

      try {
          const { uid, role } = await loadMe(); // 權限檢查
          const siteInfo = await getSiteInfo(currentSiteId);
          $("site_line").textContent = `場域：${siteInfo?.name || currentSiteId} ｜ 您的身分：${role}`;

          const canEdit = isManagerRole(role);
          const people = await getSitePeople(currentSiteId);
          const nameList = await getScheduleNames(currentSiteId);
          const mapped = await getMappings(currentSiteId);

          if (!nameList.length){
            setMsg("近期班表無姓名資料（請先匯入班表）。");
            return;
          }

          for (const personName of nameList){
            const tr = document.createElement("tr");

            const tdName = document.createElement("td");
            tdName.innerHTML = `<strong>${escapeHtml(personName)}</strong>` + (mapped[personName] ? ` <span class="pill">已連結</span>` : "");
            tr.appendChild(tdName);

            const tdSel = document.createElement("td");
            const sel = document.createElement("select");
            sel.style.width = "100%";
            sel.disabled = !canEdit;

            const opt0 = document.createElement("option");
            opt0.value = ""; opt0.textContent = "（不連結）"; sel.appendChild(opt0);

            for (const p of people){
              const opt = document.createElement("option");
              opt.value = p.user_id; opt.textContent = p.label; sel.appendChild(opt);
            }

            sel.value = mapped[personName] || "";
            tdSel.appendChild(sel);
            tr.appendChild(tdSel);

            const tdAct = document.createElement("td");
            if (canEdit){
              const btnSave = document.createElement("button");
              btnSave.textContent = "儲存"; btnSave.style.marginRight = "8px"; btnSave.style.background = "#2196f3"; btnSave.style.color="white"; btnSave.style.border="none";

              const btnClear = document.createElement("button");
              btnClear.textContent = "清除";

              btnSave.onclick = async () => {
                try{
                  const uid = sel.value || null;
                  if (!uid) await deleteMapping(currentSiteId, personName);
                  else await upsertMapping(currentSiteId, personName, uid);
                  setMsg("已更新：" + personName, true);
                  await render();
                }catch(e){ setMsg("更新失敗：" + (e?.message || String(e))); }
              };

              btnClear.onclick = async () => {
                try{
                  sel.value = "";
                  await deleteMapping(currentSiteId, personName);
                  setMsg("已清除：" + personName, true);
                  await render();
                }catch(e){ setMsg("清除失敗：" + (e?.message || String(e))); }
              };

              tdAct.appendChild(btnSave); tdAct.appendChild(btnClear);
            } else {
              tdAct.innerHTML = `<span class="small">僅供檢視</span>`;
            }
            tr.appendChild(tdAct);
            rowsEl.appendChild(tr);
          }
          setMsg(canEdit ? "載入完成" : "唯讀模式", true);
      } catch(e) {
          setMsg("錯誤：" + e.message);
      }
    }

    render();
  </script>
</body>
</html>