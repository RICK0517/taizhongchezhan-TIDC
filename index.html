<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç™»å…¥</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial;max-width:880px;margin:28px auto;padding:0 14px; transition: background 0.3s;}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;background:#fff;position: relative;}
    label{display:block;margin-top:10px}
    input,select,button{width:100%;padding:10px;margin-top:6px;max-width:100%;font-size:16px;}
    button{font-weight:700;cursor:pointer}
    .msg{margin-top:10px;color:#b00020;white-space:pre-wrap}
    .small{opacity:.75;font-size:13px;line-height:1.4}
    .top{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}

    #hidden_card_input {
        position: absolute;
        top: -9999px;
        left: -9999px;
        opacity: 0;
    }

    #card_status_badge {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        opacity: 0.5;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 1000;
    }
    #card_status_badge.active { opacity: 1; background: #2e7d32; }
    #card_status_badge.error { opacity: 1; background: #c62828; }
  </style>
</head>
<body>
  <input type="password" id="hidden_card_input" autocomplete="off" />

  <div class="top">
    <div>
      <h1 style="margin:0">å ´åŸŸç³»çµ±</h1>
      <div class="small">æ”¯æ´éµç›¤è¼¸å…¥æˆ–ç›´æ¥åˆ·å¡</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <section class="card">
      <h2 style="margin:0">ç³»çµ±ç™»å…¥</h2>
      <label>å¸³è™Ÿ (Username)
        <input id="login_username" class="manual-input" placeholder="ä¾‹å¦‚ï¼šwangwei" autocomplete="username" />
      </label>
      <label>å¯†ç¢¼
        <input id="login_password" class="manual-input" type="password" autocomplete="current-password" />
      </label>
      <button id="btn_login" style="background-color:#2196f3; color:white; border:none;">ç™»å…¥</button>
      
      <div id="login_msg" class="msg"></div>
      
      <div class="small" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; color:#666;">
        ğŸ’¡ æç¤ºï¼šè‹¥ä¸è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œç›´æ¥æ„Ÿæ‡‰è­˜åˆ¥è­‰ä¹Ÿå¯ç™»å…¥ã€‚
      </div>
    </section>
  </div>

  <div id="card_status_badge">ğŸ’³ è®€å¡æ©Ÿå¾…å‘½æ¨¡å¼</div>

  <div id="video_overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; z-index:99999; cursor:pointer;">
    <video id="intro_video" style="width:100%; height:100%; object-fit:cover;" playsinline webkit-playsinline></video>
    <div style="position:absolute; bottom:20px; right:20px; color:white; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px; font-size:12px;">
      é»æ“Šè¢å¹•è·³é
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const AUTH_DOMAIN = "corp.local";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);
    const setMsg = (el, t) => { el.textContent = t||""; };
    const toEmail = (u) => `${u.trim().toLowerCase()}@${AUTH_DOMAIN}`;

    const { data: sess } = await supabase.auth.getSession();
    if (sess.session) location.href = "./app.html";

    // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ’­æ”¾å‡½å¼æ¥æ”¶ userId â˜…â˜…â˜…
    async function playIntroAndRedirect(userId) {
        const overlay = $("video_overlay");
        const video = $("intro_video");
        const targetUrl = "./app.html";
        
        // â˜… é‡é»ï¼šè·¯å¾‘æ”¹ç‚º userId/intro.mp4 â˜…
        const fileName = `${userId}/intro.mp4`;
        const { data } = supabase.storage.from("system_assets").getPublicUrl(fileName);
        const videoUrl = data.publicUrl;

        // æª¢æŸ¥è©²ä½¿ç”¨è€…æ˜¯å¦æœ‰è¨­å®šå½±ç‰‡
        try {
            const check = await fetch(videoUrl, { method: 'HEAD' });
            if(!check.ok) throw new Error("No personal video");
        } catch(e) {
            location.href = targetUrl; // æ²’è¨­å®šå°±ç›´æ¥è·³è½‰
            return;
        }

        // æœ‰å½±ç‰‡å‰‡æ’­æ”¾
        overlay.style.display = "block";
        video.src = videoUrl;
        
        let isDone = false;
        const finish = () => {
            if(isDone) return;
            isDone = true;
            video.pause();
            location.href = targetUrl;
        };

        overlay.onclick = finish;
        video.onended = finish;
        
        try {
            await video.play();
        } catch(err) {
            video.muted = true;
            try { await video.play(); } catch(e) { finish(); }
        }
    }

    // ===== 1. æ‰‹å‹•ç™»å…¥é‚è¼¯ =====
    $("btn_login").addEventListener("click", async () => {
        setMsg($("login_msg"), "ç™»å…¥ä¸­...");
        const u = $("login_username").value;
        const p = $("login_password").value;
        if (!u || !p) return setMsg($("login_msg"), "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

        const { data, error } = await supabase.auth.signInWithPassword({ email: toEmail(u), password: p });
        if (error) setMsg($("login_msg"), error.message);
        else {
            setMsg($("login_msg"), "ç™»å…¥æˆåŠŸï¼Œè¼‰å…¥ä¸­...");
            // â˜… å‚³å…¥ data.user.id
            playIntroAndRedirect(data.user.id); 
        }
    });

    // ===== 2. è‡ªå‹•åˆ·å¡ç›£è½é‚è¼¯ =====
    const cardInput = $("hidden_card_input");
    const badge = $("card_status_badge");
    const manualInputs = ["login_username", "login_password"];

    function focusGuard() {
        const activeId = document.activeElement ? document.activeElement.id : "";
        if (!manualInputs.includes(activeId)) {
            cardInput.focus({ preventScroll: true });
        }
    }

    setInterval(focusGuard, 500);
    document.addEventListener("click", (e) => { setTimeout(focusGuard, 100); });

    cardInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
            const code = cardInput.value.trim();
            if(!code) return; 

            badge.textContent = "ğŸ”„ è®€å–ä¸­...";
            badge.className = "active";
            setMsg($("login_msg"), "ğŸ’³ åµæ¸¬åˆ°å¡ç‰‡ï¼Œé©—è­‰èº«åˆ†ä¸­...");

            try {
                const { data: userData, error: dbError } = await supabase.from("card_logins").select("email, password").eq("card_uid", code).single();
                if (dbError || !userData) throw new Error("å¡ç‰‡æœªè¨»å†Šæˆ–ç„¡æ•ˆ");

                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ email: userData.email, password: userData.password });
                if (authError) throw authError;

                badge.textContent = "âœ… é©—è­‰æˆåŠŸ";
                setMsg($("login_msg"), "é©—è­‰æˆåŠŸï¼Œè·³è½‰ä¸­...");
                
                // â˜… å‚³å…¥ authData.user.id
                playIntroAndRedirect(authData.user.id);

            } catch (err) {
                console.error(err);
                badge.textContent = "âŒ éŒ¯èª¤";
                badge.className = "error";
                setMsg($("login_msg"), `åˆ·å¡ç™»å…¥å¤±æ•—ï¼š${err.message}`);
                cardInput.value = "";
                setTimeout(() => { badge.textContent = "ğŸ’³ è®€å¡æ©Ÿå¾…å‘½æ¨¡å¼"; badge.className = ""; }, 2000);
            }
        }
    });

    focusGuard();
  </script>
</body>
</html>