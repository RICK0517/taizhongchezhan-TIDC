<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å€‹äººè¨­å®š</title>
  <style>
    :root { var(--primary-color: #2196f3); }
    body{font-family:system-ui,-apple-system,"Segoe UI",Arial,sans-serif;max-width:800px;margin:20px auto;padding:0 14px;background:#f9f9f9;color:#333}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:25px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.02)}
    h2{margin-top:0;border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:20px;color:#444;font-size:1.5rem}
    label{display:block;margin-bottom:8px;font-weight:bold;color:#555}
    select, button, input[type="file"]{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;width:100%;max-width:100%;box-sizing:border-box;}
    
    .section-label { font-size: 14px; color: #666; margin-bottom: 12px; border-left: 4px solid var(--primary-color); padding-left: 8px; font-weight: bold; }
    .hint { font-size: 12px; color: #777; margin-top: 4px; line-height: 1.4; }

    /* é…è‰²é¸é …å¡ */
    .theme-group-title { font-size: 13px; color: #888; margin: 15px 0 10px; display: flex; align-items: center; gap: 8px; }
    .theme-group-title::after { content: ""; flex: 1; height: 1px; background: #eee; }
    .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .theme-card { border: 1px solid #eee; border-radius: 10px; padding: 12px; cursor: pointer; text-align: center; transition: all 0.2s; position: relative; background: #fff; }
    .theme-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); border-color: #ddd; }
    .theme-card.active { border-color: var(--primary-color); background-color: rgba(33, 150, 243, 0.05); border-width: 2px; }
    .color-preview { display: flex; justify-content: center; gap: 4px; margin-bottom: 8px; }
    .color-dot { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
    .theme-name { font-size: 13px; font-weight: 500; color: #444; }
    
    .btn-save { background:#2196f3; color:white; border:none; font-weight:bold; cursor:pointer; width:100%; padding:12px; margin-top: 10px; }
    .btn-save:hover { background:#1976d2; }
    
    /* å½±ç‰‡ä¸Šå‚³å€å¡Šæ¨£å¼ */
    .upload-box { background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom: 15px; border: 1px solid #eee; }
    .upload-title { font-weight: bold; margin-bottom: 10px; color: #333; display: flex; align-items: center; gap: 8px; }
    .btn-upload { background:#ff9800; color:white; border:none; font-weight:bold; cursor:pointer; width:auto; padding:8px 16px; margin-top: 8px; }
    .btn-upload:hover { background:#f57c00; }
    .btn-upload:disabled { background:#ccc; cursor:not-allowed; }

    .progress-bar { height: 6px; background: #ddd; margin-top: 10px; border-radius: 3px; overflow: hidden; display: none; }
    .progress-fill { height: 100%; background: #4caf50; width: 0%; transition: width 0.2s; }
    
    .preview-box { margin-top: 10px; display: none; background: #000; padding: 10px; border-radius: 8px; }
    video { width: 100%; max-height: 200px; display:block; margin:0 auto; }

    .msg { margin-top:15px; color:#2e7d32; font-weight:bold; display:none; padding: 10px; background: #e8f5e9; border-radius: 6px; text-align: center; }
    .err-msg { color: #d32f2f; font-size: 13px; margin-top: 5px; font-weight: bold; }
  </style>
</head>
<body>

  <div class="card">
    <h2>âš™ï¸ ç³»çµ±èˆ‡å€‹äººè¨­å®š</h2>
    
    <div style="margin-bottom:30px;">
      <div class="section-label">1. é è¨­ç™»å…¥å ´åŸŸ</div>
      <div class="hint" style="margin-bottom:10px;">è¨­å®šå¾Œï¼Œæ¯æ¬¡ç™»å…¥ç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨é¸å®šè©²å ´åŸŸã€‚</div>
      <select id="default_site_sel"><option value="">(ç„¡) è«‹é¸æ“‡...</option></select>
    </div>

    <div style="margin-bottom:30px;">
      <div class="section-label">2. ä»‹é¢é…è‰²é¢¨æ ¼</div>
      <div class="theme-group-title">â˜€ï¸ æ·ºè‰²æ¨¡å¼</div>
      <div class="theme-grid">
        <div class="theme-card" onclick="selectTheme('light')" id="th_light"><div class="color-preview"><div class="color-dot" style="background:#fff;"></div><div class="color-dot" style="background:#2196f3;"></div></div><div class="theme-name">ç¶“å…¸ç™½</div></div>
        <div class="theme-card" onclick="selectTheme('soft_blue')" id="th_soft_blue"><div class="color-preview"><div class="color-dot" style="background:#fff;"></div><div class="color-dot" style="background:#03a9f4;"></div></div><div class="theme-name">å¤©ç©ºè—</div></div>
        <div class="theme-card" onclick="selectTheme('rose')" id="th_rose"><div class="color-preview"><div class="color-dot" style="background:#fff;"></div><div class="color-dot" style="background:#e91e63;"></div></div><div class="theme-name">ç«ç‘°ç´…</div></div>
        <div class="theme-card" onclick="selectTheme('mint')" id="th_mint"><div class="color-preview"><div class="color-dot" style="background:#fff;"></div><div class="color-dot" style="background:#00bfa5;"></div></div><div class="theme-name">è–„è·ç¶ </div></div>
        <div class="theme-card" onclick="selectTheme('amber')" id="th_amber"><div class="color-preview"><div class="color-dot" style="background:#fff;"></div><div class="color-dot" style="background:#ff8f00;"></div></div><div class="theme-name">ç¥ç€æ©˜</div></div>
      </div>
      <div class="theme-group-title">ğŸŒ™ æ·±è‰²æ¨¡å¼</div>
      <div class="theme-grid">
        <div class="theme-card" onclick="selectTheme('dark')" id="th_dark"><div class="color-preview"><div class="color-dot" style="background:#1e1e1e;"></div><div class="color-dot" style="background:#90caf9;"></div></div><div class="theme-name">æ¨™æº–æ·±ç°</div></div>
        <div class="theme-card" onclick="selectTheme('midnight')" id="th_midnight"><div class="color-preview"><div class="color-dot" style="background:#0a0e14;"></div><div class="color-dot" style="background:#bb86fc;"></div></div><div class="theme-name">æ¥µè‡´é»‘</div></div>
        <div class="theme-card" onclick="selectTheme('forest_dark')" id="th_forest_dark"><div class="color-preview"><div class="color-dot" style="background:#1b2e1c;"></div><div class="color-dot" style="background:#81c784;"></div></div><div class="theme-name">æ·±æ—ç¶ </div></div>
        <div class="theme-card" onclick="selectTheme('lava')" id="th_lava"><div class="color-preview"><div class="color-dot" style="background:#210b05;"></div><div class="color-dot" style="background:#ff7043;"></div></div><div class="theme-name">å²©æ¼¿ç´…</div></div>
        <div class="theme-card" onclick="selectTheme('ocean_dark')" id="th_ocean_dark"><div class="color-preview"><div class="color-dot" style="background:#001a2c;"></div><div class="color-dot" style="background:#4fc3f7;"></div></div><div class="theme-name">æ·±æµ·è—</div></div>
      </div>
      <input type="hidden" id="selected_theme" value="light">
      <button class="btn-save" onclick="saveSettings()">å„²å­˜åå¥½è¨­å®š</button>
      <div id="msg" class="msg">âœ¨ è¨­å®šå·²å„²å­˜ï¼</div>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

    <div>
      <div class="section-label">3. ç™»å…¥/ç™»å‡º éå ´å‹•ç•«</div>
      <div class="hint" style="margin-bottom:15px;">é»æ“Šè¢å¹•å¯è·³éå½±ç‰‡ã€‚æª”æ¡ˆå¤§å°é™åˆ¶ 100MBã€‚</div>
      
      <div class="upload-box">
          <div class="upload-title">ğŸ¬ ç™»å…¥å½±ç‰‡ (Intro)</div>
          <input type="file" id="file_intro" accept="video/mp4,video/webm">
          
          <div class="progress-bar" id="p_bar_intro"><div class="progress-fill" id="p_fill_intro"></div></div>
          <div id="msg_intro" class="err-msg" style="color:#333;"></div>
          
          <button id="btn_intro" class="btn-upload" onclick="uploadVideo('intro')">â¬†ï¸ ä¸Šå‚³ç™»å…¥å½±ç‰‡</button>

          <div class="preview-box" id="preview_intro_box">
            <div style="color:#fff; font-size:12px; margin-bottom:5px;">ç›®å‰ç™»å…¥å½±ç‰‡ï¼š</div>
            <video id="vid_intro" controls playsinline></video>
          </div>
      </div>

      <div class="upload-box">
          <div class="upload-title">ğŸ‘‹ ç™»å‡ºå½±ç‰‡ (Outro)</div>
          <input type="file" id="file_outro" accept="video/mp4,video/webm">
          
          <div class="progress-bar" id="p_bar_outro"><div class="progress-fill" id="p_fill_outro"></div></div>
          <div id="msg_outro" class="err-msg" style="color:#333;"></div>
          
          <button id="btn_outro" class="btn-upload" onclick="uploadVideo('outro')">â¬†ï¸ ä¸Šå‚³ç™»å‡ºå½±ç‰‡</button>

          <div class="preview-box" id="preview_outro_box">
            <div style="color:#fff; font-size:12px; margin-bottom:5px;">ç›®å‰ç™»å‡ºå½±ç‰‡ï¼š</div>
            <video id="vid_outro" controls playsinline></video>
          </div>
      </div>

    </div>

  </div>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);

    // è¨­å®šèˆ‡åå¥½
    const STORAGE_KEY = "app_preferences";
    let prefs = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { default_site_id: "", theme: "light" };
    const BUCKET_NAME = "system_assets";

    async function init(){
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) { location.href="./index.html"; return; }
        const uid = session.user.id;

        // è¼‰å…¥å ´åŸŸ
        const { data: mems } = await supabase.from("site_memberships").select("site_id").eq("user_id", uid).eq("is_active", true);
        if(mems && mems.length > 0){
            const siteIds = mems.map(m => m.site_id);
            const { data: sites } = await supabase.from("sites").select("id, name").in("id", siteIds);
            const sel = $("default_site_sel");
            (sites||[]).forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.id; opt.textContent = s.name; sel.appendChild(opt);
            });
            sel.value = prefs.default_site_id || "";
        }
        
        // è¼‰å…¥ä¸»é¡Œ
        selectTheme(prefs.theme || "light");

        // æª¢æŸ¥ç¾æœ‰å½±ç‰‡
        checkVideo('intro');
        checkVideo('outro');
    }

    // --- ä¸»é¡Œèˆ‡å ´åŸŸ ---
    window.selectTheme = (theme) => {
        document.querySelectorAll(".theme-card").forEach(el => el.classList.remove("active"));
        const target = $("th_" + theme); if(target) target.classList.add("active");
        $("selected_theme").value = theme;
        window.parent.postMessage({ type: 'PREVIEW_THEME', theme: theme }, '*');
    };

    window.saveSettings = () => {
        const newPrefs = { default_site_id: $("default_site_sel").value, theme: $("selected_theme").value };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newPrefs));
        window.parent.postMessage({ type: 'UPDATE_THEME', theme: newPrefs.theme }, '*');
        $("msg").style.display = "block"; setTimeout(() => $("msg").style.display = "none", 3000);
    };

    // --- å½±ç‰‡ä¸Šå‚³é‚è¼¯ (é€šç”¨) ---
    async function checkVideo(type) {
        // type å‚³å…¥ 'intro' æˆ– 'outro'
        const fileName = type === 'intro' ? 'intro_video.mp4' : 'outro_video.mp4';
        const vidId = type === 'intro' ? 'vid_intro' : 'vid_outro';
        const boxId = type === 'intro' ? 'preview_intro_box' : 'preview_outro_box';

        const { data } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileName);
        const videoUrl = `${data.publicUrl}?t=${new Date().getTime()}`;
        
        try {
            const res = await fetch(videoUrl, { method: 'HEAD' });
            if(res.ok) {
                $(boxId).style.display = "block";
                $(vidId).src = videoUrl;
            }
        } catch(e) {}
    }

    window.uploadVideo = async function(type) {
        const fileName = type === 'intro' ? 'intro_video.mp4' : 'outro_video.mp4';
        const fileInput = $(type === 'intro' ? 'file_intro' : 'file_outro');
        const msg = $(type === 'intro' ? 'msg_intro' : 'msg_outro');
        const btn = $(type === 'intro' ? 'btn_intro' : 'btn_outro');
        const pBar = $(type === 'intro' ? 'p_bar_intro' : 'p_bar_outro');
        const pFill = $(type === 'intro' ? 'p_fill_intro' : 'p_fill_outro');

        const file = fileInput.files[0];
        msg.textContent = ""; msg.style.color = "#333";

        if (!file) { msg.textContent = "âŒ è«‹é¸æ“‡æª”æ¡ˆ"; msg.style.color = "#d32f2f"; return; }
        if (file.size > 100 * 1024 * 1024) { msg.textContent = "âŒ æª”æ¡ˆè¶…é 100MB"; msg.style.color = "#d32f2f"; return; }

        btn.disabled = true;
        msg.textContent = "ä¸Šå‚³ä¸­...";
        pBar.style.display = "block"; pFill.style.width = "10%";

        const { data, error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, file, { cacheControl: '3600', upsert: true });

        pFill.style.width = "100%";
        btn.disabled = false;

        if (error) {
            msg.textContent = "âŒ å¤±æ•—: " + error.message; msg.style.color = "#d32f2f"; pBar.style.display = "none";
        } else {
            msg.textContent = "âœ… æˆåŠŸï¼"; msg.style.color = "#2e7d32";
            setTimeout(() => { pBar.style.display = "none"; checkVideo(type); }, 1000);
        }
    };

    init();
</script>
</body>
</html>