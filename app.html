<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸»æ§å°</title>
  <style>
    /* ===== åŸºç¤é‡ç½®èˆ‡è®Šæ•¸ (æ”¯æ´æ›è‰²) ===== */
    :root {
      --sidebar-width: 180px; 
      --header-height: 50px;
      
      /* é è¨­å€¼ (Light) - JS æœƒå‹•æ…‹è¦†å¯«é€™äº›è®Šæ•¸ */
      --primary-color: #2196f3;
      --bg-color: #f4f6f8;
      --sidebar-bg: #fff;
      --sidebar-text: #333;
      --card-bg: #fff;
      --text-color: #333;
      --border-color: #e0e0e0;
      --nav-hover: #e3f2fd;
      --nav-active-text: #1565c0;
      --input-bg: #fff;
      --input-border: #ccc;
    }
    body { 
      font-family: system-ui, "Segoe UI", Arial, sans-serif; 
      margin: 0; padding: 0; 
      background: var(--bg-color); 
      color: var(--text-color);
      display: flex;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    *, *::before, *::after { box-sizing: border-box; }

    /* ===== å·¦å´å´é‚Šæ¬„æ¨£å¼ ===== */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0; 
      z-index: 100;
      height: 100vh;
      overflow: hidden;
      padding: 0;
      box-shadow: 2px 0 5px rgba(0,0,0,0.02);
      font-size: 0.9rem;
      color: var(--sidebar-text);
      transition: background 0.3s;
    }

    /* ä¸­é–“æ»¾å‹•å€åŸŸ */
    .sidebar-scroll-content {
      flex: 1; 
      overflow-y: scroll; 
      padding: 10px;
      scrollbar-width: thin; 
    }
    .sidebar-scroll-content::-webkit-scrollbar { width: 6px; }
    .sidebar-scroll-content::-webkit-scrollbar-thumb { background-color: #cfd8dc; border-radius: 10px; }

    /* åº•éƒ¨å›ºå®šå€åŸŸ */
    .sidebar-footer { 
      flex-shrink: 0;
      padding: 15px 10px;
      border-top: 1px solid var(--border-color); 
      background-color: var(--sidebar-bg);
      z-index: 101;
    }

    .brand {
      font-size: 1.1rem;
      font-weight: 800; color: var(--primary-color);
      margin-bottom: 15px; padding-left: 5px; 
      display: flex; align-items: center;
      cursor: pointer;
    }
    
    /* å€‹äººè³‡è¨Šæ¨£å¼ */
    .user-profile {
      background: rgba(33, 150, 243, 0.08); 
      border-radius: 6px; 
      padding: 8px 10px;
      margin-bottom: 10px; 
      border: 1px solid rgba(33, 150, 243, 0.15);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .profile-header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .user-name { font-weight: 800; font-size: 0.95rem; color: var(--primary-color); }
    .user-role { 
      font-size: 0.7rem; color: var(--sidebar-text); opacity: 0.8; background-color: rgba(128,128,128,0.1); 
      padding: 2px 6px; border-radius: 4px; white-space: nowrap; 
    }
    
    /* ç­è¡¨å°å¡ç‰‡ */
    .shift-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 10px;
      margin-top: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .shift-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .shift-label { font-size: 0.75rem; color: var(--sidebar-text); opacity: 0.7; }
    .shift-val-today { font-size: 1.2rem; font-weight: 800; color: var(--primary-color); }
    .shift-val-tmr { font-size: 0.9rem; font-weight: 600; color: var(--sidebar-text); }
    .leave-countdown-bar { margin-top: 6px; padding: 4px 0; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: bold; display: block; }
    .status-working { background-color: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; }
    .status-on-leave { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    /* å †ç–Šé¸å–® */
    .nav-category { margin-bottom: 8px; border-bottom: 1px solid var(--border-color); }
    .nav-header {
      width: 100%; text-align: left; background: none; border: none;
      padding: 8px 5px; font-weight: 700; color: var(--sidebar-text); cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: 4px; transition: background 0.2s; font-size: 0.85rem;
      position: relative; opacity: 0.9;
    }
    .nav-header:hover { background: rgba(0,0,0,0.05); opacity: 1; }
    .nav-arrow { font-size: 0.6em; transition: transform 0.3s; opacity: 0.5; }
    .nav-category.active .nav-arrow { transform: rotate(180deg); }
    
    .nav-items { 
      display: flex; flex-direction: column; gap: 2px; padding-left: 8px; 
      max-height: 0; opacity: 0; overflow: hidden; margin-bottom: 0;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-bottom 0.3s ease;
    }
    .nav-category.active .nav-items { max-height: 500px; opacity: 1; margin-bottom: 8px; }

    .nav-btn {
      text-align: left; background: transparent; border: none;
      padding: 6px 8px; font-size: 0.8rem; color: var(--sidebar-text);
      cursor: pointer; border-radius: 4px; position: relative;
      transition: all 0.2s; opacity: 0.8;
    }
    .nav-btn:hover { background: var(--nav-hover); color: var(--nav-active-text); opacity: 1; }
    .nav-btn.current { background: var(--nav-hover); color: var(--nav-active-text); font-weight: bold; opacity: 1; }
    
    .btn-logout { width: 100%; padding: 6px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    select.site-select { width: 100%; margin-bottom: 8px; padding: 4px; font-size: 0.8rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-color); }
    
    .badge-dot { display: inline-block; width: 6px; height: 6px; background-color: #d32f2f; border-radius: 50%; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); }
    .group-badge-dot { display: inline-block; width: 8px; height: 8px; background-color: #d32f2f; border-radius: 50%; margin-right: 6px; }

    /* ===== å³å´ä¸»è¦å…§å®¹å€ ===== */
    .main-wrapper {
      flex: 1; width: 100%; height: 100vh;
      overflow-y: auto; position: relative;
      background: var(--bg-color);
    }
    
    #dashboard_view, #tools_view { padding: 20px 30px; max-width: 1200px; margin: 0 auto; }
    #tools_view { display: none; }
    #main_frame { width: 100%; height: 100%; border: none; display: none; background: #fff; }

    /* å¡ç‰‡èˆ‡æ¨™é¡Œ - æ”¯æ´è®Šè‰² */
    .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); color: var(--text-color); }
    h1, h2, h3 { color: var(--text-color); }
    h2 { font-size: 1.1rem; margin-bottom: 12px; border-left: 4px solid var(--primary-color); padding-left: 8px; }
    
    input, select, textarea, button.action-btn { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); border-radius: 4px; font-size: 0.9rem; }
    button.action-btn { background: var(--primary-color); color: white; font-weight: bold; border: none; cursor: pointer; transition: opacity 0.2s; }
    button.action-btn:hover { opacity: 0.9; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    
    .small { font-size: 12px; color: var(--text-color); opacity: 0.7; }
    .msg { margin-top: 8px; white-space: pre-wrap; color: #b00020; font-size: 0.85rem; }
    .task { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; transition: transform 0.2s; }
    .task:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* RWD */
    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; padding: 10px; }
      .main-wrapper { height: auto; overflow: visible; }
      #main_frame { height: 800px; }
      .nav-items { display: none; }
      .nav-category.active .nav-items { display: flex; }
    }

    /* å…¶ä»–æ¨™ç±¤ */
    .tag-event { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; }
    .tag-construction { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .tag-maintenance { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .tag-major { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
    .tag-other { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
    .days-left { float: right; font-weight: bold; color: #00695c; font-size: 0.85rem; }
    .days-urgent { color: #d32f2f; }
    .btn-group-right { float: right; display: flex; gap: 4px; margin-left: 8px; }
    .btn-icon { border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 12px; color: #fff; }
    .btn-edit { background-color: #1976d2; } 
    .btn-history { background-color: #607d8b; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }

    /* Modal */
    dialog { border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 95%; max-width: 800px; padding: 15px; background: var(--card-bg); color: var(--text-color); }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 10px; }
    .modal-close { background: transparent; border: none; font-size: 18px; cursor: pointer; color: #666; }
    .cal-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid var(--border-color); }
    .cal-head { background: rgba(0,0,0,0.05); padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
    .cal-day { min-height: 80px; padding: 2px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); background: var(--card-bg); }
    .cal-event-bar { font-size: 10px; padding: 1px 3px; margin-bottom: 1px; border-radius: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid rgba(0,0,0,0.1); }
    .ce-construction { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .ce-maintenance { background: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
    .ce-major { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
    .ce-other { background: #f5f5f5; color: #616161; border-color: #e0e0e0; }
  </style>
</head>
<body>

<nav class="sidebar">
    <div class="sidebar-scroll-content">
        <div class="brand" onclick="showDashboard()">ğŸ“… æ’ç­ç³»çµ±</div>
        <div class="user-profile">
          <div class="profile-header">
            <div id="me_name" class="user-name">è®€å–ä¸­...</div>
            <div id="me_role" class="user-role"></div>
          </div>
          <div id="my_shift_text" class="shift-text"></div>
        </div>

        <div class="nav-category active" onclick="toggleNav(this)">
            <button class="nav-header">ä¸€èˆ¬åŠŸèƒ½<span class="nav-arrow">â–¼</span></button>
            <div class="nav-items" onclick="event.stopPropagation()">
                <button class="nav-btn current" id="btn_home" onclick="showDashboard()">ğŸ  ä¸»æ§å°</button>
            </div>
        </div>
        
        <div class="nav-category active" onclick="toggleNav(this)">
          <button class="nav-header">å°å·¥å…·<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="showTool('calc', this)">ğŸ§® è¨ˆç®—æ©Ÿ</button>
            <button class="nav-btn" onclick="showTool('fee', this)">ğŸ’° é‡‘é¡è©¦ç®—</button>
          </div>
        </div>

        <div class="nav-category active" onclick="toggleNav(this)">
          <button class="nav-header">å€‹äººè³‡æ–™<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./schedule_view.html')">ğŸ“… æŸ¥çœ‹ç­è¡¨</button>
            <button class="nav-btn" onclick="loadPage('./staff_info.html')">ğŸ‘¤ äººäº‹è³‡æ–™</button>
            <button class="nav-btn" onclick="loadPage('./settings.html')">âš™ï¸ å€‹äººè¨­å®š</button>
          </div>
        </div>

        <div class="nav-category" onclick="toggleNav(this)">
          <button class="nav-header">ä¼‘å‡ç”³è«‹<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./leave_apply.html')">ğŸ“ ç”³è«‹ä¼‘å‡</button>
            <button class="nav-btn" onclick="loadPage('./stats.html')">ğŸ“Š å‡åˆ¥çµ±è¨ˆ</button>
          </div>
        </div>

        <div class="nav-category" id="group_manager" style="display:none;" onclick="toggleNav(this)">
          <button class="nav-header">
            ä¸»ç®¡ç®¡ç†
            <div style="display:flex; align-items:center;">
              <span id="group_badge" class="group-badge-dot" style="display:none;"></span>
              <span class="nav-arrow">â–¼</span>
            </div>
          </button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./mapping.html')">ğŸ‘¥ äººå“¡å°ç…§</button>
            <button class="nav-btn" onclick="loadPage('./schedule_import.html')">ğŸ“¥ åŒ¯å…¥ç­è¡¨</button>
            <button class="nav-btn" onclick="loadPage('./overtime_mgt.html')">â° åŠ ç­ç®¡ç†</button>
            <button id="btn_leave_review" class="nav-btn" onclick="loadPage('./leave_review.html')">
              âœ… å¯©æ ¸è«‹å‡
              <span id="leave_badge" class="badge-dot" style="display:none;"></span>
            </button>
          </div>
        </div>
    </div> 
    <div class="sidebar-footer">
      <label class="small" style="display:block; margin-bottom:2px;">åˆ‡æ›å ´åŸŸ</label>
      <select id="site_sel" class="site-select"></select>
      <button id="btn_logout" class="btn-logout">ç™»å‡º</button>
      <div id="dbg" class="small" style="margin-top:6px; word-break:break-all; font-size:10px;"></div>
    </div>
  </nav>

  <main class="main-wrapper">
    <iframe id="main_frame" src=""></iframe>
    <div id="tools_view">
        <h1 style="margin-bottom:15px; font-size:1.4rem;">å°å·¥å…·</h1>
        
        <section id="tool_ui_calc" class="card" style="display:none;">
            <h2 style="text-align:center;border:none;">ç°¡æ˜“è¨ˆç®—æ©Ÿ</h2>
            <div style="width:100%;max-width:320px;margin:0 auto;background:#333;padding:15px;border-radius:12px;">
                <input type="text" id="calc_display" style="width:100%;height:60px;background:#444;color:white;text-align:right;font-size:2rem;margin-bottom:10px;border:none;" readonly value="0">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                    <button onclick="calcClear()" style="background:#d32f2f;color:white;padding:15px;border:none;">C</button>
                    <button onclick="calcAppend('/')" style="background:#f39c12;color:white;border:none;">Ã·</button>
                    <button onclick="calcAppend('*')" style="background:#f39c12;color:white;border:none;">Ã—</button>
                    <button onclick="calcDel()" style="background:#f39c12;color:white;border:none;">â†</button>
                    <button onclick="calcAppend('7')" style="padding:15px;">7</button>
                    <button onclick="calcAppend('8')" style="padding:15px;">8</button>
                    <button onclick="calcAppend('9')" style="padding:15px;">9</button>
                    <button onclick="calcAppend('-')" style="background:#f39c12;color:white;border:none;">-</button>
                    <button onclick="calcAppend('4')" style="padding:15px;">4</button>
                    <button onclick="calcAppend('5')" style="padding:15px;">5</button>
                    <button onclick="calcAppend('6')" style="padding:15px;">6</button>
                    <button onclick="calcAppend('+')" style="background:#f39c12;color:white;border:none;">+</button>
                    <button onclick="calcAppend('1')" style="padding:15px;">1</button>
                    <button onclick="calcAppend('2')" style="padding:15px;">2</button>
                    <button onclick="calcAppend('3')" style="padding:15px;">3</button>
                    <button onclick="calcResult()" style="background:#2196f3;color:white;grid-column:span 2;border:none;">=</button>
                    <button onclick="calcAppend('0')" style="padding:15px;">0</button>
                    <button onclick="calcAppend('.')" style="padding:15px;">.</button>
                </div>
   </div>
        </section>
        <section id="tool_ui_fee" class="card" style="display:none;">
            <h2 style="border:none;">é‡‘é¡è¨ˆç®—</h2>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <button id="mode_btn_count" class="switch-mode-btn active" onclick="switchFeeMode('count')">1. è¨ˆæ¬¡æ¨¡å¼</button>
                <button id="mode_btn_time" class="switch-mode-btn" onclick="switchFeeMode('time')">2. è¨ˆæ™‚æ¨¡å¼</button>
            </div>
            <div class="fee-form">
                <div id="fee_input_group_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ“… æ—¥æœŸå€é–“ (è¨ˆæ¬¡)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ—¥æœŸ <input type="date" id="fee_date_start"></label>
                             <label class="small">çµæŸæ—¥æœŸ <input type="date" id="fee_date_end"></label>
                        </div>
                        <div class="small" style="margin-top:6px; color:#666;">ç³»çµ±å°‡è‡ªå‹•åˆ¤æ–·å€é–“å…§çš„åœ‹å®šå‡æ—¥(ä¾æ“š2025-2026æ³•è¦)èˆ‡é€±æœ«ã€‚</div>
                    </div>
                </div>
                <div id="fee_input_group_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">â° ç²¾æº–å€é–“ (è¨ˆæ™‚)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ™‚é–“ <input type="datetime-local" id="fee_datetime_start"></label>
                             <label class="small">çµæŸæ™‚é–“ <input type="datetime-local" id="fee_datetime_end"></label>
                        </div>
                    </div>
                </div>
                <div id="fee_setting_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ¬¡)</span>
                        <div class="grid">
                            <label class="small">å¹³æ—¥è²»ç”¨ <input type="number" id="fee_count_normal" value="30"></label>
                            <label class="small">å‡æ—¥è²»ç”¨ <input type="number" id="fee_count_holiday" value="50"></label>
                        </div>
                    </div>
                </div>
                <div id="fee_setting_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ™‚)</span>
                        <div class="grid">
                            <label class="small">æ™‚é–“å–®ä½(åˆ†é˜) <input type="number" id="fee_time_unit" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å¹³æ—¥) <input type="number" id="fee_time_rate_normal" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å‡æ—¥) <input type="number" id="fee_time_rate_holiday" value="50"></label>
                        </div>
                    </div>
                </div>
                <div class="fee-group">
                    <span class="fee-label">âš™ï¸ é€²éšè¦å‰‡</span>
                    <label style="cursor:pointer; display:block; margin-bottom:4px;">
                        <input type="radio" name="holiday_rule" value="weekend" checked style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå‡æ—¥ã€
                    </label>
                    <label style="cursor:pointer; display:block; margin-bottom:8px;">
                        <input type="radio" name="holiday_rule" value="weekday" style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå¹³æ—¥ã€
                    </label>
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px; color:#d32f2f;">
                            <input type="checkbox" id="fee_manual_holiday" style="width:auto;"> 
                            (æ‰‹å‹•) å¼·åˆ¶è¦–ç‚ºå‡æ—¥
                        </label>
                    </div>
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" id="fee_has_cap" style="width:auto;" onchange="toggleCapInput()"> å•Ÿç”¨é‡‘é¡ä¸Šé™
                        </label>
                        <input type="number" id="fee_cap_amount" placeholder="è¼¸å…¥ä¸Šé™é‡‘é¡" disabled style="display:none;">
                    </div>
                </div>
                <button class="action-btn" onclick="calculateFee()">é–‹å§‹è¨ˆç®—</button>
                <div class="fee-result-box" id="fee_result_area" style="display:none;">
                    <div class="small">è¨ˆç®—çµæœ</div>
                    <div id="fee_final_amount" class="fee-total">$0</div>
                    <div id="fee_detail_msg" class="small" style="color:#666; white-space: pre-line;"></div>
                </div>
            </div>
        </section>
    </div>


    <div id="dashboard_view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div>
            <h1 id="page_title" style="margin:0; font-size:1.4rem;">ä¸»æ§å°</h1>
            <div class="small" id="header_date_line"></div>
        </div>
        </div>
        <section class="card" id="events_card" style="border-left: 4px solid var(--primary-color);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; border:none; padding:0;">ğŸ“† è¿‘æœŸé‡è¦è¡Œäº‹æ›†</h2>
            <div id="mgr_event_btns" style="display:none; gap:6px;">
                <button id="btn_history" class="btn-history">ğŸ“… æŸ¥è©¢</button>
                <button id="btn_toggle_event_add" class="btn-history" style="background:var(--primary-color);">+ æ–°å¢</button>
            </div>
        </div>
        <div id="event_add_box" style="display:none; margin-top:10px; padding:10px; background:#f9f9f9; border-radius:6px; border:1px solid #eee;">
            <input type="hidden" id="evt_id_edit" value="">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                <div style="display:flex; gap:6px;">
                    <label class="small" style="display:block">é–‹å§‹ <input type="date" id="evt_date_start"></label>
                    <label class="small" style="display:block">çµæŸ <input type="date" id="evt_date_end"></label>
                </div>
                <div style="flex:1; min-width:100px;">
                    <label class="small">é¡å‹
                        <select id="evt_type">
                            <option value="æ–½å·¥">æ–½å·¥</option>
                            <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                            <option value="é‡å¤§äº‹ä»¶">é‡å¤§äº‹ä»¶</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </label>
                </div>
                <div style="flex:2; min-width:180px;">
                    <label class="small">å…§å®¹ <input type="text" id="evt_content" placeholder="ä¾‹å¦‚ï¼šäºŒå» å€é›»åŠ›æ­²ä¿®"></label>
                </div>
                <div style="display:flex; gap:4px;">
                    <button id="btn_save_event" class="action-btn" style="width:auto; padding:8px 12px;">å„²å­˜</button>
                    <button id="btn_del_event_form" class="action-btn" style="width:auto; padding:8px 10px; background:#d32f2f; display:none;">åˆªé™¤</button>
                    <button id="btn_cancel_event" class="action-btn" style="width:auto; padding:8px 10px; background:#ccc; color:#333;">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="evt_msg" class="small" style="color:#d10000; margin-top:4px;"></div>
        </div>
        <div id="events_list" style="margin-top:10px; display:grid; gap:6px;">
            <div class="small">è¼‰å…¥ä¸­...</div>
        </div>
        </section>

        <dialog id="history_modal">
            <div class="modal-header">
                <h3 style="margin:0">æ­·å²è¡Œäº‹æ›†</h3>
                <button class="modal-close" id="btn_close_history">âœ•</button>
            </div>
            <div class="cal-controls">
                <button class="action-btn" style="width:36px;" id="cal_prev">&lt;</button>
                <span class="cal-title" id="cal_title" style="font-size:1.1rem; font-weight:bold; padding-top:6px;"></span>
                <button class="action-btn" style="width:36px;" id="cal_next">&gt;</button>
            </div>
            <div class="cal-grid" id="cal_grid"></div>
        </dialog>

        <div style="display:flex; gap:12px; align-items:flex-start; margin-top:15px; flex-wrap:wrap;">
        <section class="card" id="today_card" style="flex:1; min-width:240px;">
            <h2 style="margin:0; border:none; padding:0;">ä»Šå¤©ç­è¡¨</h2>
            <div class="small" id="today_date_line" style="margin-top:4px"></div>
            <div id="today_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="today_msg" class="small" style="margin-top:8px"></div>
        </section>
        <section class="card" id="mytasks_card" style="flex:2; min-width:280px;">
            <h2 style="margin:0; border:none; padding:0;">æˆ‘çš„ä»»å‹™ï¼ˆæœ€è¿‘ 5 ç­†ï¼‰</h2>
            <div id="mytasks_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="mytasks_msg" class="small" style="margin-top:8px"></div>
        </section>
        </div>

        <section class="card" style="margin-top:15px;">
            <h2 style="margin:0; border:none; padding:0;">æ–°å¢ä»»å‹™</h2>
            <div class="grid" style="margin-top:8px">
                <div><label class="small">æ¨™é¡Œ<input id="task_title" placeholder="ä¾‹å¦‚ï¼šå·¡æª¢æ¸…å–®æ›´æ–°" /></label></div>
                <div>
                    <label class="small">ç‹€æ…‹
                        <select id="task_status">
                            <option value="open" selected>open</option>
                            <option value="doing">doing</option>
                            <option value="done">done</option>
                        </select>
                    </label>
                </div>
                <div><label class="small">æŒ‡æ´¾çµ¦ï¼ˆåŒå ´åŸŸï¼Œå¯è¤‡é¸ï¼‰<select id="task_assignees" multiple size="4" style="height:80px;"></select></label></div>
                <div style="display:flex; align-items:center; padding-top:20px">
                    <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:0.9rem;">
                        <input type="checkbox" id="task_assign_all" style="width:auto; margin:0"> æŒ‡æ´¾çµ¦å…¨é«”
                    </label>
                </div>
            </div>
            <label class="small" style="display:block; margin-top:8px;">å…§å®¹<textarea id="task_body" placeholder="å¯ç©º" style="min-height:60px;"></textarea></label>
            <button id="btn_create" class="action-btn" style="width:auto; padding:6px 16px; margin-top:8px;">å»ºç«‹ä»»å‹™</button>
            <div id="create_msg" class="msg"></div>
        </section>
        
        <section class="card">
            <h2 style="margin:0; border:none; padding:0;">ä»»å‹™åˆ—è¡¨</h2>
            <div id="tasks_box" style="display:grid; gap:8px; margin-top:10px"></div>
            <div id="tasks_msg" class="small" style="margin-top:8px"></div>
        </section>
    </div>
  </main>

<script>
// ===== 1. é…è‰²ç®¡ç†ç³»çµ± (æ–°å¢ 5 æ·º 5 æ·±) =====
const themes = {
    // --- æ·ºè‰²ç³» (Light Modes) ---
    light: { p: '#2196f3', bg: '#f4f6f8', sbg: '#fff', stxt: '#333', cbg: '#fff', txt: '#333', border: '#e0e0e0', navh: '#e3f2fd', nava: '#1565c0', inbg:'#fff', inbd:'#ccc' },
    soft_blue: { p: '#03a9f4', bg: '#e1f5fe', sbg: '#fff', stxt: '#01579b', cbg: '#fff', txt: '#333', border: '#b3e5fc', navh: '#e1f5fe', nava: '#0288d1', inbg:'#fff', inbd:'#b3e5fc' },
    rose: { p: '#e91e63', bg: '#fdf2f5', sbg: '#fff', stxt: '#880e4f', cbg: '#fff', txt: '#333', border: '#f8bbd0', navh: '#fce4ec', nava: '#c2185b', inbg:'#fff', inbd:'#f8bbd0' },
    mint: { p: '#00bfa5', bg: '#e0f2f1', sbg: '#fff', stxt: '#004d40', cbg: '#fff', txt: '#333', border: '#b2dfdb', navh: '#e0f2f1', nava: '#00897b', inbg:'#fff', inbd:'#b2dfdb' },
    amber: { p: '#ff8f00', bg: '#fff8e1', sbg: '#fff', stxt: '#795548', cbg: '#fff', txt: '#333', border: '#ffecb3', navh: '#fff8e1', nava: '#ef6c00', inbg:'#fff', inbd:'#ffecb3' },

    // --- æ·±è‰²ç³» (Dark Modes) ---
    dark:  { p: '#90caf9', bg: '#121212', sbg: '#1e1e1e', stxt: '#e0e0e0', cbg: '#2c2c2c', txt: '#e0e0e0', border: '#444', navh: '#333', nava: '#90caf9', inbg:'#424242', inbd:'#555' },
    midnight: { p: '#bb86fc', bg: '#0a0e14', sbg: '#161b22', stxt: '#c9d1d9', cbg: '#161b22', txt: '#c9d1d9', border: '#30363d', navh: '#21262d', nava: '#bb86fc', inbg:'#0d1117', inbd:'#30363d' },
    forest_dark: { p: '#81c784', bg: '#1b2e1c', sbg: '#253b26', stxt: '#e8f5e9', cbg: '#253b26', txt: '#e8f5e9', border: '#385239', navh: '#2e4a2f', nava: '#a5d6a7', inbg:'#1b2e1c', inbd:'#385239' },
    lava: { p: '#ff7043', bg: '#210b05', sbg: '#2d140e', stxt: '#fbe9e7', cbg: '#2d140e', txt: '#fbe9e7', border: '#4e261c', navh: '#3e1d15', nava: '#ff8a65', inbg:'#210b05', inbd:'#4e261c' },
    ocean_dark: { p: '#4fc3f7', bg: '#001a2c', sbg: '#00253d', stxt: '#e1f5fe', cbg: '#00253d', txt: '#e1f5fe', border: '#00375a', navh: '#002b46', nava: '#81d4fa', inbg:'#001a2c', inbd:'#00375a' }
};
    function applyTheme(tName) {
        const t = themes[tName] || themes.light;
        const r = document.documentElement.style;
        r.setProperty('--primary-color', t.p);
        r.setProperty('--bg-color', t.bg);
        r.setProperty('--sidebar-bg', t.sbg);
        r.setProperty('--sidebar-text', t.stxt);
        r.setProperty('--card-bg', t.cbg);
        r.setProperty('--text-color', t.txt);
        r.setProperty('--border-color', t.border);
        r.setProperty('--nav-hover', t.navh);
        r.setProperty('--nav-active-text', t.nava);
        r.setProperty('--input-bg', t.inbg);
        r.setProperty('--input-border', t.inbd);
    }
    // ç›£è½ä¾†è‡ª settings.html çš„è®Šè‰²è«‹æ±‚
    window.addEventListener('message', (event) => {
        if (event.data.type === 'PREVIEW_THEME' || event.data.type === 'UPDATE_THEME') {
            applyTheme(event.data.theme);
            // é€šçŸ¥ iframe è®Šè‰²
            const iframe = document.getElementById('main_frame');
            if(iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: event.data.type, theme: event.data.theme }, '*');
            }
        }
    });

    // ===== 2. å°èˆªèˆ‡è¦–åœ–æ§åˆ¶ =====
    function toggleNav(element) {
      const wasActive = element.classList.contains('active');
      document.querySelectorAll('.nav-category').forEach(cat => cat.classList.remove('active'));
      if (!wasActive) element.classList.add('active');
    }
    window.showDashboard = function() {
        document.getElementById('dashboard_view').style.display = 'block';
        document.getElementById('tools_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        document.getElementById('btn_home').classList.add('current');
    }
    window.showTool = function(toolType, btnElement) {
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        document.getElementById('tools_view').style.display = 'block';
        
        // åˆ‡æ›å·¥å…·é¡¯ç¤º
        document.getElementById('tool_ui_calc').style.display = (toolType === 'calc') ? 'block' : 'none';
        document.getElementById('tool_ui_fee').style.display = (toolType === 'fee') ? 'block' : 'none';
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(btnElement) btnElement.classList.add('current');
    }
    window.loadPage = function(pageUrl) {
        const siteId = document.getElementById('site_sel').value;
        if(!siteId && !pageUrl.includes('settings.html')) { alert("è«‹å…ˆé¸æ“‡å ´åŸŸ"); return; }
        
        let fullUrl = pageUrl;
        if(siteId && !pageUrl.includes('?')) fullUrl = `${pageUrl}?site_id=${encodeURIComponent(siteId)}`;
        else if(siteId) fullUrl = `${pageUrl}&site_id=${encodeURIComponent(siteId)}`;

        const frame = document.getElementById('main_frame');
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('tools_view').style.display = 'none';
        frame.style.display = 'block';
        frame.src = fullUrl;
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(event && event.currentTarget) event.currentTarget.classList.add('current');
    }

    // ===== 3. è¨ˆç®—æ©ŸåŠŸèƒ½ =====
    let calcVal = "0";
    function updateCalc(){ document.getElementById('calc_display').value = calcVal; }
    window.calcAppend = function(v) { if(calcVal==="0" && v!==".") calcVal=""; calcVal+=v; updateCalc(); }
    window.calcDel = function() { calcVal=calcVal.slice(0,-1); if(calcVal==="") calcVal="0"; updateCalc(); }
    window.calcClear = function() { calcVal="0"; updateCalc(); }
    window.calcResult = function() { try{ if(/[^0-9+\-*/.]/.test(calcVal)) throw new Error(); calcVal=String(eval(calcVal)); }catch(e){ calcVal="Error"; } updateCalc(); }

// ===== 5. é‡‘é¡è©¦ç®—å·¥å…· (è£œä¸Šçš„éºå¤±åŠŸèƒ½) =====
    
    // åˆ‡æ›è¨ˆæ¬¡/è¨ˆæ™‚æ¨¡å¼
    window.switchFeeMode = function(mode) {
        // è™•ç†æŒ‰éˆ•æ¨£å¼
        const btnCount = document.getElementById('mode_btn_count');
        const btnTime = document.getElementById('mode_btn_time');
        
        if(mode === 'count') {
            btnCount.classList.add('active');
            btnTime.classList.remove('active');
            
            // åˆ‡æ›é¡¯ç¤ºå€åŸŸ
            document.getElementById('fee_input_group_count').style.display = 'block';
            document.getElementById('fee_input_group_time').style.display = 'none';
            document.getElementById('fee_setting_count').style.display = 'block';
            document.getElementById('fee_setting_time').style.display = 'none';
        } else {
            btnCount.classList.remove('active');
            btnTime.classList.add('active');
            
            document.getElementById('fee_input_group_count').style.display = 'none';
            document.getElementById('fee_input_group_time').style.display = 'block';
            document.getElementById('fee_setting_count').style.display = 'none';
            document.getElementById('fee_setting_time').style.display = 'block';
        }
        
        // éš±è—èˆŠçš„çµæœ
        document.getElementById('fee_result_area').style.display = 'none';
    };

    // åˆ‡æ›é‡‘é¡ä¸Šé™è¼¸å…¥æ¡†çš„å•Ÿç”¨ç‹€æ…‹
    window.toggleCapInput = function() {
        const isChecked = document.getElementById('fee_has_cap').checked;
        const input = document.getElementById('fee_cap_amount');
        if(isChecked) {
            input.disabled = false;
            input.style.display = 'block';
        } else {
            input.disabled = true;
            input.style.display = 'none';
        }
    };

    // åŸ·è¡Œé‡‘é¡è¨ˆç®— (å°æ‡‰æ–°çš„ UI)
    window.calculateFee = function() {
        const mode = document.getElementById('mode_btn_count').classList.contains('active') ? 'count' : 'time';
        let total = 0;
        let detail = "";

        if (mode === 'count') {
            const startStr = document.getElementById('fee_date_start').value;
            const endStr = document.getElementById('fee_date_end').value;
            const priceNormal = parseFloat(document.getElementById('fee_count_normal').value) || 0;
            const priceHoliday = parseFloat(document.getElementById('fee_count_holiday').value) || 0;

            if(!startStr || !endStr) { alert("è«‹è¼¸å…¥æ—¥æœŸå€é–“"); return; }
            
            const start = new Date(startStr);
            const end = new Date(endStr);
            
            // ç°¡å–®è¨ˆç®—å¤©æ•¸è¿´åœˆ
            for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const day = d.getDay();
                // ç°¡æ˜“åˆ¤æ–·ï¼šé€±å…­(6) é€±æ—¥(0) ç‚ºå‡æ—¥
                const isWeekend = (day === 0 || day === 6);
                // é€™è£¡åƒ…åšç°¡å–®åˆ¤æ–·ï¼Œè‹¥éœ€åœ‹å®šå‡æ—¥éœ€é¡å¤–é‚è¼¯
                if(isWeekend) total += priceHoliday;
                else total += priceNormal;
            }
            detail = `å¾ ${startStr} åˆ° ${endStr} (ä¾æ“šç°¡æ˜“å¹³å‡æ—¥è¨ˆç®—)`;

        } else {
            // è¨ˆæ™‚æ¨¡å¼é‚è¼¯
            const startStr = document.getElementById('fee_datetime_start').value;
            const endStr = document.getElementById('fee_datetime_end').value;
            const unitMins = parseFloat(document.getElementById('fee_time_unit').value) || 30;
            const rateNormal = parseFloat(document.getElementById('fee_time_rate_normal').value) || 0;
            
            if(!startStr || !endStr) { alert("è«‹è¼¸å…¥æ™‚é–“å€é–“"); return; }
            
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffMs = end - start;
            if(diffMs < 0) { alert("çµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹"); return; }
            
            const diffMins = diffMs / 1000 / 60;
            const units = Math.ceil(diffMins / unitMins);
            total = units * rateNormal; // é€™è£¡åƒ…ç¤ºç¯„çµ±ä¸€è²»ç‡ï¼Œå¯¦éš›å¯æ“´å……
            
            detail = `å…± ${diffMins.toFixed(1)} åˆ†é˜ï¼Œä»¥ ${unitMins} åˆ†é˜ç‚ºä¸€å–®ä½ï¼Œå…± ${units} å–®ä½`;
        }

        // è™•ç†é‡‘é¡ä¸Šé™
        if(document.getElementById('fee_has_cap').checked) {
            const cap = parseFloat(document.getElementById('fee_cap_amount').value) || 999999;
            if(total > cap) {
                total = cap;
                detail += `\n(å·²è§¸ç™¼é‡‘é¡ä¸Šé™ ${cap})`;
            }
        }

        // é¡¯ç¤ºçµæœ
        const resBox = document.getElementById('fee_result_area');
        resBox.style.display = 'block';
        document.getElementById('fee_final_amount').textContent = `$${total}`;
        document.getElementById('fee_detail_msg').textContent = detail;
    };
</script>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);
    function setText(el, t){ if(el) el.textContent = t||""; }
    function setMsg(el, t){ if(el) el.textContent = t||""; }
    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function toISODateLocal(d){ const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }

    $("header_date_line").textContent = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'long', day:'numeric', weekday:'long' });

    // è¼”åŠ©å‡½å¼
    function getTagClass(t){ return t==='æ–½å·¥'?'tag-construction':t==='ç¶­ä¿®'?'tag-maintenance':t==='é‡å¤§äº‹ä»¶'?'tag-major':'tag-other'; }
    function getCalEventClass(t){ return t==='æ–½å·¥'?'ce-construction':t==='ç¶­ä¿®'?'ce-maintenance':t==='é‡å¤§äº‹ä»¶'?'ce-major':'ce-other'; }
    function diffDays(d1, d2) { return Math.round((new Date(d1).setHours(0,0,0,0) - new Date(d2).setHours(0,0,0,0)) / 86400000); }
    function isManagerRole(r){ return r==="engineer"||r==="supervisor"; }
    function roleLabel(r){ return r==="engineer"?"å·¥ç¨‹å¸«":r==="supervisor"?"ä¸»ç®¡":"å“¡å·¥"; }

    // ===== æ¥­å‹™é‚è¼¯å‡½å¼ =====
    window.startEditEvent = function(id, s, e, t, c) {
        $("history_modal").close(); $("evt_id_edit").value=id; $("evt_date_start").value=s; $("evt_date_end").value=e; $("evt_type").value=t; $("evt_content").value=c;
        $("event_add_box").style.display="block"; $("btn_save_event").textContent="æ›´æ–°";
        $("btn_del_event_form").style.display="block"; $("btn_del_event_form").onclick=()=>window.deleteEvent(id);
        $("events_card").scrollIntoView({ behavior:'smooth' });
    };
    window.deleteEvent = async function(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const { error } = await supabase.from("site_events").delete().eq("id", id);
        if(error) alert(error.message); else location.reload();
    };

    async function refreshSiteEvents(siteId, isManager){
        const listEl=$("events_list"); listEl.innerHTML='<div class="small">è¼‰å…¥ä¸­...</div>';
        const today=toISODateLocal(new Date());
        const { data, error } = await supabase.from("site_events").select("*").eq("site_id", siteId).gte("event_end_date", today).order("event_date", { ascending: true }).limit(5);
        if(error || !data.length){ listEl.innerHTML='<div class="small" style="color:#888;">è¿‘æœŸç„¡é‡å¤§äº‹ä»¶</div>'; return; }
        listEl.innerHTML="";
        const todayObj = new Date(today);
        data.forEach(evt => {
            const startDiff = diffDays(evt.event_date, todayObj);
            const endDiff = diffDays(evt.event_end_date, todayObj);
            let daysText="", daysClass="days-left", rowStyle="";
            if(startDiff>0){ daysText=(startDiff===1)?"æ˜å¤©é–‹å§‹":`é‚„æœ‰ ${startDiff} å¤©`; if(startDiff===1) daysClass+=" days-urgent"; }
            else { if(endDiff>=0){ daysText="ğŸ”¥ é€²è¡Œä¸­"; daysClass="days-urgent"; rowStyle="background-color:rgba(255,0,0,0.05);"; } else { daysText="å·²çµæŸ"; daysClass="days-ended"; rowStyle="opacity:0.8;"; } }
            const dDisplay = (evt.event_date!==evt.event_end_date) ? `${evt.event_date} ~ ${evt.event_end_date}` : evt.event_date;
            const actions = isManager ? `<div class="btn-group-right"><button class="btn-icon btn-edit" onclick="startEditEvent('${evt.id}', '${evt.event_date}', '${evt.event_end_date}', '${evt.category}', '${escapeHtml(evt.content).replace(/'/g,"&apos;")}')">âœï¸</button></div>` : "";
            const div=document.createElement("div");
            div.style.cssText=`padding:6px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; ${rowStyle}`;
            div.innerHTML=`<div style="flex:1;"><span class="tag-event ${getTagClass(evt.category)}">${escapeHtml(evt.category)}</span><span style="font-weight:600;margin-right:6px;">${escapeHtml(evt.content)}</span><span class="small">(${dDisplay})</span></div><div style="display:flex;align-items:center;"><div class="${daysClass}">${daysText}</div>${actions}</div>`;
            listEl.appendChild(div);
        });
    }

    let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), cachedEvents=[];
    async function loadCalendarEvents(siteId){
        const {data} = await supabase.from("site_events").select("*").eq("site_id", siteId);
        if(data) cachedEvents=data; renderCalendar();
    }
    function renderCalendar() {
        const grid=$("cal_grid"), title=$("cal_title"); title.textContent=`${calYear} å¹´ ${calMonth+1} æœˆ`; grid.innerHTML="";
        ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(w => { const d=document.createElement("div"); d.className="cal-head"; d.textContent=w; grid.appendChild(d); });
        const firstDay=new Date(calYear, calMonth, 1).getDay(), daysInMonth=new Date(calYear, calMonth+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(Object.assign(document.createElement("div"), {className:"cal-day other-month"}));
        for(let d=1; d<=daysInMonth; d++){
            const div=document.createElement("div"); div.className="cal-day";
            if(new Date().toDateString()===new Date(calYear,calMonth,d).toDateString()) div.classList.add("cal-today");
            div.innerHTML=`<span class="cal-date-num">${d}</span>`;
            const cur=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cachedEvents.filter(e => e.event_date<=cur && e.event_end_date>=cur).forEach(e => {
                const bar=document.createElement("div"); bar.className=`cal-event-bar ${getCalEventClass(e.category)}`; bar.textContent=e.content;
                bar.onclick=(ev)=>{ ev.stopPropagation(); startEditEvent(e.id, e.event_date, e.event_end_date, e.category, escapeHtml(e.content).replace(/'/g,"&apos;")); };
                div.appendChild(bar);
            });
            grid.appendChild(div);
        }
    }

    async function saveSiteEvent(siteId, uid){
        const id=$("evt_id_edit").value, s=$("evt_date_start").value, e=$("evt_date_end").value, t=$("evt_type").value, c=$("evt_content").value.trim();
        if(!s||!e||!c) return setMsg($("evt_msg"), "è«‹å¡«å¯«å®Œæ•´");
        if(s>e) return setMsg($("evt_msg"), "æ—¥æœŸéŒ¯èª¤");
        setMsg($("evt_msg"), "è™•ç†ä¸­...");
        const payload = { site_id:siteId, event_date:s, event_end_date:e, category:t, content:c, created_by:uid };
        const q = id ? supabase.from("site_events").update(payload).eq("id",id) : supabase.from("site_events").insert(payload);
        const {error} = await q;
        if(error) setMsg($("evt_msg"), error.message); else location.reload();
    }

    async function getSitePeople(siteId){
        const r = await supabase.rpc("get_site_people", { p_site_id: siteId });
        return { error: r.error, people: (r.data||[]).map(x=>({user_id:x.user_id, name:x.display_name||x.user_id})) };
    }
    async function loadAssignees(siteId){
        const sel=$("task_assignees"); sel.innerHTML="";
        const {people} = await getSitePeople(siteId);
        people.forEach(p => { const o=document.createElement("option"); o.value=p.user_id; o.textContent=p.name; sel.appendChild(o); });
    }

    async function refreshTasks(siteId, uid){
        const box=$("tasks_box"); box.innerHTML=""; setText($("tasks_msg"),"è®€å–ä¸­...");
        const {data:rows} = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at",{ascending:false});
        if(!rows || !rows.length){ setText($("tasks_msg"),"ç„¡ä»»å‹™"); return; }
        setText($("tasks_msg"), `å…± ${rows.length} ç­†`);
        const {people} = await getSitePeople(siteId); const nameMap={}; people.forEach(p=>nameMap[p.user_id]=p.name);
        const tIds=rows.map(r=>r.id);
        const {data:assData} = await supabase.from("task_assignees").select("*").in("task_id", tIds);
        const {data:compData} = await supabase.from("task_completions").select("*").in("task_id", tIds);
        const assMap={}, compMap={};
        (assData||[]).forEach(a => { if(!assMap[a.task_id])assMap[a.task_id]=[]; assMap[a.task_id].push(a.user_id); });
        (compData||[]).forEach(c => { if(!compMap[c.task_id])compMap[c.task_id]=[]; compMap[c.task_id].push(c); });
        
        rows.forEach(r => {
            const explicit = assMap[r.id] || [];
            const assNames = r.assign_all ? "å…¨é«”" : (explicit.length ? explicit.map(u=>nameMap[u]||u).join("ã€") : "æœªæŒ‡æ´¾");
            const doneLine = (compMap[r.id]||[]).slice(0,3).map(x=>(nameMap[x.user_id]||x.user_id)).join(", ");
            const canComp = (r.assign_all || explicit.includes(uid)) && !(compMap[r.id]||[]).some(x=>x.user_id===uid) && r.status!=="done";
            
            const div=document.createElement("div"); div.className="task";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.title)}</strong><span class="small">${new Date(r.created_at).toLocaleDateString()}</span></div>
            ${r.body?`<div style="margin-top:4px;white-space:pre-wrap">${escapeHtml(r.body)}</div>`:""}
            <div class="small" style="margin-top:6px">æŒ‡æ´¾ï¼š${escapeHtml(assNames)}ï½œç‹€æ…‹ï¼š${r.status}</div>
            ${doneLine?`<div class="small" style="color:#2e7d32">å·²å®Œæˆï¼š${doneLine}</div>`:""}
            ${canComp?`<button class="action-btn" style="width:auto;padding:2px 8px;font-size:12px;margin-top:6px;">æ¨™è¨˜å®Œæˆ</button>`:""}`;
            if(canComp) div.querySelector("button").onclick = async () => {
                await supabase.from("task_completions").insert({task_id:r.id, user_id:uid});
                refreshTasks(siteId, uid);
            };
            box.appendChild(div);
        });
    }

    async function refreshMyTasksPanel(siteId, uid){
        const box=$("mytasks_box"); box.innerHTML="";
        const {data:rows} = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at",{ascending:false}).limit(20);
        if(!rows || !rows.length) return setText($("mytasks_msg"),"ç„¡");
        const {data:ass} = await supabase.from("task_assignees").select("task_id").eq("user_id", uid);
        const myTIds = new Set((ass||[]).map(x=>x.task_id));
        const mine = rows.filter(r => r.created_by===uid || r.assign_all || myTIds.has(r.id)).slice(0,5);
        if(!mine.length) return setText($("mytasks_msg"),"ç„¡è¿‘æœŸä»»å‹™");
        setText($("mytasks_msg"),"");
        mine.forEach(r => {
            const div=document.createElement("div"); div.className="task";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.title)}</strong><span class="small">${r.status}</span></div>`;
            box.appendChild(div);
        });
    }

    async function refreshLeaveBadge(siteId, roleCur){
        const btnGroup = $("group_manager");
        const badge = $("leave_badge");
        const groupBadge = $("group_badge");
        if(isManagerRole(roleCur)){
            btnGroup.style.display = "block";
            const { count } = await supabase.from("leave_requests").select("id", { count: "exact", head: true }).eq("site_id", siteId).eq("status", "pending");
            if(count > 0){
                badge.style.display = "inline-block"; groupBadge.style.display = "inline-block";
            } else {
                badge.style.display = "none"; groupBadge.style.display = "none";
            }
        } else {
            btnGroup.style.display = "none";
        }
    }

    async function refreshTodaySchedule(siteId){
        const box=$("today_box"); box.innerHTML=""; $("today_msg").textContent="è®€å–ä¸­...";
        const today=toISODateLocal(new Date()); $("today_date_line").textContent=today;
        const {data} = await supabase.from("site_schedules").select("person_name,shift").eq("site_id",siteId).eq("work_date",today);
        if(!data||!data.length) return $("today_msg").textContent="ç„¡ç­è¡¨";
        $("today_msg").textContent=`å…± ${data.length} äºº`;
        data.forEach(r => {
            const div=document.createElement("div"); div.className="task"; div.style.padding="6px";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.person_name)}</strong><span>${escapeHtml(r.shift)}</span></div>`;
            box.appendChild(div);
        });
    }

    async function refreshMyScheduleLine(siteId, uid){
        const el=$("my_shift_text"); if(!el) return;
        const {data:links} = await supabase.from("site_person_links").select("person_name").eq("site_id", siteId).eq("user_id", uid);
        if(!links || !links.length) return el.innerHTML=`<span class="small" style="color:var(--text-color);opacity:0.6;">æœªé€£çµç­è¡¨</span>`;
        const name = links[0].person_name;
        
        const today=new Date();
        const start=toISODateLocal(today);
        const endDt=new Date(); endDt.setDate(today.getDate()+30); const end=toISODateLocal(endDt);
        const tmrDt=new Date(); tmrDt.setDate(today.getDate()+1); const tmrStr=toISODateLocal(tmrDt);

        const {data:rows} = await supabase.from("site_schedules").select("work_date,shift").eq("site_id",siteId).eq("person_name",name).gte("work_date",start).lte("work_date",end).order("work_date");
        const list = rows || [];
        const todayShift = list.find(r=>r.work_date===start)?.shift || "ç„¡";
        const tmrShift = list.find(r=>r.work_date===tmrStr)?.shift || "ç„¡";
        
        const keywords=["ä¼‘","å‡"];
        const isTodayLeave = keywords.some(k=>todayShift.includes(k));
        let statusHtml = "";
        
        if(isTodayLeave) {
            statusHtml = `<div class="leave-countdown-bar status-on-leave">ğŸ–ï¸ ä¼‘å‡ä¸­ Enjoy!</div>`;
        } else {
            const nextLeave = list.find(r => r.work_date > start && keywords.some(k=>(r.shift||"").includes(k)));
            if(nextLeave){
                const diff = diffDays(nextLeave.work_date, start);
                statusHtml = `<div class="leave-countdown-bar status-working">ğŸ’ª ${diff===1?"æ˜å¤©":diff+" å¤©å¾Œ"} æ”¾å‡</div>`;
            } else {
                statusHtml = `<div class="leave-countdown-bar" style="background:var(--bg-color);color:var(--text-color);opacity:0.6;">ğŸ“… è¿‘æœŸç„¡ä¼‘å‡</div>`;
            }
        }
        el.innerHTML = `<div class="shift-card"><div class="shift-row"><span class="shift-label">ä»Šæ—¥</span><span class="shift-val-today">${escapeHtml(todayShift)}</span></div><div class="shift-row" style="border-bottom:1px dashed var(--border-color);padding-bottom:4px;margin-bottom:4px;"><span class="shift-label">æ˜æ—¥</span><span class="shift-val-tmr">${escapeHtml(tmrShift)}</span></div>${statusHtml}</div>`;
    }

    // â˜…â˜…â˜… ä¸»ç¨‹å¼ä¿®æ­£ â˜…â˜…â˜…
    async function main(){
        $("btn_logout").onclick = async () => { await supabase.auth.signOut(); location.href="./index.html"; };
        const {data:{session}} = await supabase.auth.getSession();
        if(!session) return location.href="./index.html";
        const uid = session.user.id;
        
        // 1. è®€å–ä¸¦å¥—ç”¨ä½¿ç”¨è€…è¨­å®š (LocalStorage)
        const prefs = JSON.parse(localStorage.getItem("app_preferences")) || {};
        if(prefs.theme) {
            applyTheme(prefs.theme);
        }

        // è¼‰å…¥å€‹äºº
        const {data:profile} = await supabase.from("profiles").select("display_name,username").eq("user_id", uid).single();
        const {data:mems} = await supabase.from("site_memberships").select("site_id,role").eq("user_id", uid).eq("is_active", true);
        if(!profile || !mems){ alert("è®€å–å¤±æ•—"); return; }
        setText($("me_name"), profile.display_name || profile.username);

        // è¼‰å…¥å ´åŸŸ
        const {data:sites} = await supabase.from("sites").select("id,name").in("id", mems.map(m=>m.site_id));
        const sel = $("site_sel");
        sites.forEach(s => { const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });
        
        const refreshAll = async () => {
            const siteId = sel.value;
            const role = mems.find(m=>m.site_id===siteId)?.role || "";
            setText($("me_role"), roleLabel(role));
            $("page_title").textContent = `${sites.find(s=>s.id===siteId)?.name} ä¸»æ§å°`;

            // åŸ·è¡Œè³‡æ–™è¼‰å…¥
            await refreshLeaveBadge(siteId, role);
            refreshTodaySchedule(siteId);
            refreshMyScheduleLine(siteId, uid);
            loadAssignees(siteId);
            refreshTasks(siteId, uid);
            refreshMyTasksPanel(siteId, uid);
            refreshSiteEvents(siteId, isManagerRole(role));
            
            // Iframe é€£å‹• (å¦‚æœ iframe é–‹è‘—ä¸”ä¸æ˜¯è¨­å®šé ï¼Œæ›å ´åŸŸæ™‚ä¹Ÿæ›´æ–°å®ƒ)
            const frame = $("main_frame");
            if(frame.style.display!=="none" && frame.src.indexOf('settings.html') === -1) {
                const currentPath = frame.src.split('?')[0]; 
                if(currentPath) frame.src = `${currentPath}?site_id=${siteId}`;
            }
            
            $("mgr_event_btns").style.display = isManagerRole(role) ? "flex" : "none";
        };

        if(sites.length) {
            // 2. åˆ¤æ–·é è¨­å ´åŸŸ
            if(prefs.default_site_id && sites.some(s => s.id === prefs.default_site_id)) {
                sel.value = prefs.default_site_id;
            } else {
                sel.value = sites[0].id;
            }
            refreshAll(); 
        }
        sel.onchange = refreshAll;
        
        // å®šæœŸæª¢æŸ¥ç´…é» (éœé»˜åŸ·è¡Œ)
        setInterval(async()=>{
            const siteId=sel.value; const role=mems.find(m=>m.site_id===siteId)?.role||"";
            if(siteId) refreshLeaveBadge(siteId, role);
        }, 30000);

        // åˆå§‹åŒ–å…¶ä»–UIäº‹ä»¶
        $("cal_prev").onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();};
        $("cal_next").onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();};
        $("btn_history").onclick=async()=>{await loadCalendarEvents(sel.value);$("history_modal").showModal();};
        $("btn_close_history").onclick=()=>$("history_modal").close();
        $("btn_toggle_event_add").onclick=()=>{ 
            const b=$("event_add_box"); 
            if(b.style.display==="none"){ 
                $("evt_id_edit").value=""; $("evt_content").value=""; $("btn_save_event").textContent="å„²å­˜"; 
                $("btn_del_event_form").style.display="none"; 
                const t=new Date(); t.setDate(t.getDate()+1); const ts=toISODateLocal(t);
                $("evt_date_start").value=ts; $("evt_date_end").value=ts;
                b.style.display="block"; 
            } else b.style.display="none";
        };
        $("btn_cancel_event").onclick=()=>$("event_add_box").style.display="none";
        $("btn_save_event").onclick=()=>saveSiteEvent(sel.value, uid);
        
        $("btn_create").onclick=async()=>{
            const t=$("task_title").value, b=$("task_body").value, st=$("task_status").value;
            const all=$("task_assign_all").checked, selAss=$("task_assignees");
            const uids=Array.from(selAss.selectedOptions).map(o=>o.value);
            if(!t) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
            const {data, error} = await supabase.from("tasks").insert({site_id:sel.value, title:t, body:b, status:st, created_by:uid, assign_all:all}).select().single();
            if(error) return alert(error.message);
            if(!all && uids.length) await supabase.from("task_assignees").insert(uids.map(u=>({task_id:data.id, user_id:u})));
            $("task_title").value=""; $("task_body").value=""; refreshTasks(sel.value, uid); refreshMyTasksPanel(sel.value, uid);
        };
    }
    main();
</script>
</body>
</html>