<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸»æ§å°</title>
  <style>
    /* ===== åŸºç¤é‡ç½®èˆ‡è®Šæ•¸ ===== */
    :root {
      --sidebar-width: 180px; 
      --header-height: 50px;
      --primary-color: #2196f3;
      --bg-color: #f4f6f8;
    }
    body { 
      font-family: system-ui, "Segoe UI", Arial, sans-serif; 
      margin: 0; padding: 0; 
      background: var(--bg-color); 
      color: #333;
      display: flex;
      height: 100vh; /* å›ºå®šé«˜åº¦ï¼Œè®“å…§éƒ¨æ»¾å‹• */
      overflow: hidden; /* é˜²æ­¢æ•´é æ»¾å‹• */
    }
    *, *::before, *::after { box-sizing: border-box; }

    /* ===== å·¦å´å´é‚Šæ¬„æ¨£å¼ ===== */
    .sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0; 
      z-index: 100;
      height: 100vh;
      overflow: hidden;
      padding: 0;
      box-shadow: 2px 0 5px rgba(0,0,0,0.02);
      font-size: 0.9rem;
    }

    /* ä¸­é–“æ»¾å‹•å€åŸŸ */
    .sidebar-scroll-content {
      flex: 1; 
      overflow-y: scroll; 
      padding: 10px;
      scrollbar-width: thin; 
      scrollbar-color: #cfd8dc transparent;
    }
    .sidebar-scroll-content::-webkit-scrollbar { width: 6px; }
    .sidebar-scroll-content::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll-content::-webkit-scrollbar-thumb { background-color: #cfd8dc; border-radius: 10px; }
    .sidebar-scroll-content::-webkit-scrollbar-thumb:hover { background-color: #b0bec5; }

    /* åº•éƒ¨å›ºå®šå€åŸŸ */
    .sidebar-footer { 
      flex-shrink: 0;
      padding: 15px 10px;
      border-top: 1px solid #eee; 
      background-color: #fcfcfc;
      z-index: 101;
    }

    .brand {
      font-size: 1.1rem;
      font-weight: 800; color: #1565c0;
      margin-bottom: 15px; padding-left: 5px; 
      display: flex; align-items: center;
      cursor: pointer;
    }
    
    /* å€‹äººè³‡è¨Šæ¨£å¼ */
    .user-profile {
      background: #f5f9ff; 
      border-radius: 6px; 
      padding: 8px 10px;
      margin-bottom: 10px; 
      border: 1px solid #e3f2fd;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .profile-header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .user-name { font-weight: 800; font-size: 0.95rem; color: #1565c0; }
    .user-role { 
      font-size: 0.7rem; color: #555; background-color: #e3f2fd; 
      padding: 2px 6px; border-radius: 4px; white-space: nowrap; 
    }
    
    /* ç­è¡¨å°å¡ç‰‡ */
    .shift-card {
      background-color: #fff;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 8px 10px;
      margin-top: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .shift-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .shift-label { font-size: 0.75rem; color: #78909c; }
    .shift-val-today { font-size: 1.2rem; font-weight: 800; color: #1565c0; }
    .shift-val-tmr { font-size: 0.9rem; font-weight: 600; color: #555; }
    .leave-countdown-bar { margin-top: 6px; padding: 4px 0; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: bold; display: block; }
    .status-working { background-color: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; }
    .status-on-leave { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    /* å †ç–Šé¸å–® */
    .nav-category { margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
    .nav-header {
      width: 100%; text-align: left; background: none; border: none;
      padding: 8px 5px; font-weight: 700; color: #555; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: 4px; transition: background 0.2s; font-size: 0.85rem;
      position: relative;
    }
    .nav-header:hover { background: #f8f8f8; color: #000; }
    .nav-arrow { font-size: 0.6em; transition: transform 0.3s; opacity: 0.5; }
    .nav-category.active .nav-arrow { transform: rotate(180deg); }
    
    .nav-items { 
      display: flex; flex-direction: column; gap: 2px; padding-left: 8px; 
      max-height: 0; opacity: 0; overflow: hidden; margin-bottom: 0;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-bottom 0.3s ease;
    }
    .nav-category.active .nav-items { max-height: 500px; opacity: 1; margin-bottom: 8px; }

    .nav-btn {
      text-align: left; background: transparent; border: none;
      padding: 6px 8px; font-size: 0.8rem; color: #666;
      cursor: pointer; border-radius: 4px; position: relative;
      transition: all 0.2s;
    }
    .nav-btn:hover { background: #e3f2fd; color: #1565c0; }
    .nav-btn.current { background: #e3f2fd; color: #1565c0; font-weight: bold; }
    
    .btn-logout { width: 100%; padding: 6px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    select.site-select { width: 100%; margin-bottom: 8px; padding: 4px; font-size: 0.8rem; }
    
    .badge-dot { display: inline-block; width: 6px; height: 6px; background-color: #d32f2f; border-radius: 50%; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); }
    .group-badge-dot { display: inline-block; width: 8px; height: 8px; background-color: #d32f2f; border-radius: 50%; margin-right: 6px; }

    /* ===== å³å´ä¸»è¦å…§å®¹å€ ===== */
    .main-wrapper {
      flex: 1; width: 100%; height: 100vh;
      overflow-y: auto; position: relative;
      background: var(--bg-color);
    }
    
    #dashboard_view, #tools_view { padding: 20px 30px; max-width: 1200px; margin: 0 auto; }
    #tools_view { display: none; }
    #main_frame { width: 100%; height: 100%; border: none; display: none; background: #fff; }

    .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
    h2 { font-size: 1.1rem; color: #333; margin-bottom: 12px; border-left: 4px solid var(--primary-color); padding-left: 8px; }
    
    input, select, textarea, button.action-btn { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
    button.action-btn { background: #2196f3; color: white; font-weight: bold; border: none; cursor: pointer; transition: opacity 0.2s; }
    button.action-btn:hover { opacity: 0.9; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    
    .small { font-size: 12px; color: #666; }
    .msg { margin-top: 8px; white-space: pre-wrap; color: #b00020; font-size: 0.85rem; }
    .task { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px; transition: transform 0.2s; }
    .task:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* RWD */
    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; padding: 10px; }
      .main-wrapper { height: auto; overflow: visible; }
      #main_frame { height: 800px; }
      .nav-items { display: none; }
      .nav-category.active .nav-items { display: flex; }
    }

    /* å…¶ä»– */
    .shift-red{ color:#d10000; font-weight:700; }
    .shift-orange{ color:#e67e00; font-weight:700; }
    .tag-event { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; }
    .tag-construction { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .tag-maintenance { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .tag-major { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
    .tag-other { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
    .days-left { float: right; font-weight: bold; color: #00695c; font-size: 0.85rem; }
    .days-urgent { color: #d32f2f; }
    .btn-group-right { float: right; display: flex; gap: 4px; margin-left: 8px; }
    .btn-icon { border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 12px; color: #fff; }
    .btn-edit { background-color: #1976d2; } 
    .btn-history { background-color: #607d8b; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }

    /* Modal */
    dialog { border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 95%; max-width: 800px; padding: 15px; background: #fff; }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
    .modal-close { background: transparent; border: none; font-size: 18px; cursor: pointer; color: #666; }
    .cal-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
    .cal-head { background: #f5f5f5; padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; font-size: 0.8rem; }
    .cal-day { min-height: 80px; padding: 2px; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; background: #fff; }
    .cal-event-bar { font-size: 10px; padding: 1px 3px; margin-bottom: 1px; border-radius: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid rgba(0,0,0,0.1); }
    .ce-construction { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .ce-maintenance { background: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
    .ce-major { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
    .ce-other { background: #f5f5f5; color: #616161; border-color: #e0e0e0; }

    /* å·¥å…·èˆ‡è¨ˆç®—æ©Ÿ CSS */
    .tool-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
    .tool-tab-btn { background: none; border: none; border-bottom: 3px solid transparent; padding: 8px 16px; font-weight: bold; color: #666; cursor: pointer; font-size: 1rem; }
    .tool-tab-btn.active { border-bottom-color: #2196f3; color: #2196f3; }
    .calc-container { width: 100%; max-width: 320px; margin: 0 auto; background: #333; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .calc-display { width: 100%; height: 60px; background: #444; color: white; text-align: right; font-size: 2rem; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: none; outline: none; }
    .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .calc-btn { width: 100%; padding: 15px 0; font-size: 1.2rem; border-radius: 8px; border: none; cursor: pointer; background: #555; color: white; transition: background 0.1s; }
    .calc-btn:active { background: #777; }
    .calc-btn.op { background: #f39c12; color: white; }
    .calc-btn.eq { background: #2196f3; color: white; grid-column: span 2; }
    .calc-btn.clr { background: #d32f2f; }
    .fee-form { max-width: 600px; margin: 0 auto; }
    .fee-group { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
    .fee-label { display: block; font-weight: bold; margin-bottom: 4px; color: #555; }
    .fee-result-box { margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb; text-align: center; }
    .fee-total { font-size: 1.8rem; font-weight: bold; color: #1565c0; margin: 5px 0; }
    .switch-mode-btn { margin-right: 10px; padding: 6px 12px; background: #eee; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; }
    .switch-mode-btn.active { background: #2196f3; color: white; border-color: #2196f3; }
  </style>
</head>
<body>

<nav class="sidebar">
    <div class="sidebar-scroll-content">
        <div class="brand" onclick="showDashboard()">ğŸ“… æ’ç­ç³»çµ±</div>
        <div class="user-profile">
          <div class="profile-header">
            <div id="me_name" class="user-name">è®€å–ä¸­...</div>
            <div id="me_role" class="user-role"></div>
          </div>
          <div id="my_shift_text" class="shift-text"></div>
        </div>

        <div class="nav-category active" onclick="toggleNav(this)">
            <button class="nav-header">ä¸€èˆ¬åŠŸèƒ½<span class="nav-arrow">â–¼</span></button>
            <div class="nav-items" onclick="event.stopPropagation()">
                <button class="nav-btn current" id="btn_home" onclick="showDashboard()">ğŸ  ä¸»æ§å°</button>
            </div>
        </div>
        
        <div class="nav-category active" onclick="toggleNav(this)">
          <button class="nav-header">å°å·¥å…·<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="showTool('calc', this)">ğŸ§® è¨ˆç®—æ©Ÿ</button>
            <button class="nav-btn" onclick="showTool('fee', this)">ğŸ’° é‡‘é¡è©¦ç®—</button>
          </div>
        </div>

        <div class="nav-category" onclick="toggleNav(this)">
          <button class="nav-header">å€‹äººè³‡æ–™<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./schedule_view.html')">ğŸ“… æŸ¥çœ‹ç­è¡¨</button>
            <button class="nav-btn" onclick="loadPage('./staff_info.html')">ğŸ‘¤ äººäº‹è³‡æ–™</button>
          </div>
        </div>

        <div class="nav-category" onclick="toggleNav(this)">
          <button class="nav-header">ä¼‘å‡ç”³è«‹<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./leave_apply.html')">ğŸ“ ç”³è«‹ä¼‘å‡</button>
            <button class="nav-btn" onclick="loadPage('./stats.html')">ğŸ“Š å‡åˆ¥çµ±è¨ˆ</button>
          </div>
        </div>

        <div class="nav-category" id="group_manager" style="display:none;" onclick="toggleNav(this)">
          <button class="nav-header">
            ä¸»ç®¡ç®¡ç†
            <div style="display:flex; align-items:center;">
              <span id="group_badge" class="group-badge-dot" style="display:none;"></span>
              <span class="nav-arrow">â–¼</span>
            </div>
          </button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./mapping.html')">ğŸ‘¥ äººå“¡å°ç…§</button>
            <button class="nav-btn" onclick="loadPage('./schedule_import.html')">ğŸ“¥ åŒ¯å…¥ç­è¡¨</button>
            <button class="nav-btn" onclick="loadPage('./overtime_mgt.html')">â° åŠ ç­ç®¡ç†</button>
            <button id="btn_leave_review" class="nav-btn" onclick="loadPage('./leave_review.html')">
              âœ… å¯©æ ¸è«‹å‡
              <span id="leave_badge" class="badge-dot" style="display:none;"></span>
            </button>
          </div>
        </div>
    </div> 
    <div class="sidebar-footer">
      <label class="small" style="display:block; margin-bottom:2px;">åˆ‡æ›å ´åŸŸ</label>
      <select id="site_sel" class="site-select"></select>
      <button id="btn_logout" class="btn-logout">ç™»å‡º</button>
      <div id="dbg" class="small" style="margin-top:6px; word-break:break-all; font-size:10px;"></div>
    </div>
  </nav>

  <main class="main-wrapper">
    <iframe id="main_frame" src=""></iframe>
    <div id="tools_view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 id="tool_page_title" style="margin:0; font-size:1.4rem;">å°å·¥å…·</h1>
        </div>
        <section id="tool_ui_calc" class="card" style="display:none;">
            <h2 style="text-align:center; border:none;">ç°¡æ˜“è¨ˆç®—æ©Ÿ</h2>
            <div class="calc-container">
                <input type="text" id="calc_display" class="calc-display" readonly value="0">
                <div class="calc-keys">
                    <button class="calc-btn clr" onclick="calcClear()">C</button>
                    <button class="calc-btn op" onclick="calcAppend('/')">Ã·</button>
                    <button class="calc-btn op" onclick="calcAppend('*')">Ã—</button>
                    <button class="calc-btn op" onclick="calcDel()">â†</button>
                    <button class="calc-btn" onclick="calcAppend('7')">7</button>
                    <button class="calc-btn" onclick="calcAppend('8')">8</button>
                    <button class="calc-btn" onclick="calcAppend('9')">9</button>
                    <button class="calc-btn op" onclick="calcAppend('-')">-</button>
                    <button class="calc-btn" onclick="calcAppend('4')">4</button>
                    <button class="calc-btn" onclick="calcAppend('5')">5</button>
                    <button class="calc-btn" onclick="calcAppend('6')">6</button>
                    <button class="calc-btn op" onclick="calcAppend('+')">+</button>
                    <button class="calc-btn" onclick="calcAppend('1')">1</button>
                    <button class="calc-btn" onclick="calcAppend('2')">2</button>
                    <button class="calc-btn" onclick="calcAppend('3')">3</button>
                    <button class="calc-btn eq" onclick="calcResult()">=</button>
                    <button class="calc-btn" style="grid-column: span 2;" onclick="calcAppend('0')">0</button>
                    <button class="calc-btn" onclick="calcAppend('.')">.</button>
                </div>
            </div>
        </section>
        <section id="tool_ui_fee" class="card" style="display:none;">
            <h2 style="border:none;">é‡‘é¡è¨ˆç®—</h2>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <button id="mode_btn_count" class="switch-mode-btn active" onclick="switchFeeMode('count')">1. è¨ˆæ¬¡æ¨¡å¼</button>
                <button id="mode_btn_time" class="switch-mode-btn" onclick="switchFeeMode('time')">2. è¨ˆæ™‚æ¨¡å¼</button>
            </div>
            <div class="fee-form">
                <div id="fee_input_group_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ“… æ—¥æœŸå€é–“ (è¨ˆæ¬¡)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ—¥æœŸ <input type="date" id="fee_date_start"></label>
                             <label class="small">çµæŸæ—¥æœŸ <input type="date" id="fee_date_end"></label>
                        </div>
                        <div class="small" style="margin-top:6px; color:#666;">ç³»çµ±å°‡è‡ªå‹•åˆ¤æ–·å€é–“å…§çš„åœ‹å®šå‡æ—¥(ä¾æ“š2025-2026æ³•è¦)èˆ‡é€±æœ«ã€‚</div>
                    </div>
                </div>
                <div id="fee_input_group_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">â° ç²¾æº–å€é–“ (è¨ˆæ™‚)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ™‚é–“ <input type="datetime-local" id="fee_datetime_start"></label>
                             <label class="small">çµæŸæ™‚é–“ <input type="datetime-local" id="fee_datetime_end"></label>
                        </div>
                    </div>
                </div>
                <div id="fee_setting_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ¬¡)</span>
                        <div class="grid">
                            <label class="small">å¹³æ—¥è²»ç”¨ <input type="number" id="fee_count_normal" value="30"></label>
                            <label class="small">å‡æ—¥è²»ç”¨ <input type="number" id="fee_count_holiday" value="50"></label>
                        </div>
                    </div>
                </div>
                <div id="fee_setting_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ™‚)</span>
                        <div class="grid">
                            <label class="small">æ™‚é–“å–®ä½(åˆ†é˜) <input type="number" id="fee_time_unit" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å¹³æ—¥) <input type="number" id="fee_time_rate_normal" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å‡æ—¥) <input type="number" id="fee_time_rate_holiday" value="50"></label>
                        </div>
                    </div>
                </div>
                <div class="fee-group">
                    <span class="fee-label">âš™ï¸ é€²éšè¦å‰‡</span>
                    <label style="cursor:pointer; display:block; margin-bottom:4px;">
                        <input type="radio" name="holiday_rule" value="weekend" checked style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå‡æ—¥ã€
                    </label>
                    <label style="cursor:pointer; display:block; margin-bottom:8px;">
                        <input type="radio" name="holiday_rule" value="weekday" style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå¹³æ—¥ã€
                    </label>
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px; color:#d32f2f;">
                            <input type="checkbox" id="fee_manual_holiday" style="width:auto;"> 
                            (æ‰‹å‹•) å¼·åˆ¶è¦–ç‚ºå‡æ—¥
                        </label>
                    </div>
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" id="fee_has_cap" style="width:auto;" onchange="toggleCapInput()"> å•Ÿç”¨é‡‘é¡ä¸Šé™
                        </label>
                        <input type="number" id="fee_cap_amount" placeholder="è¼¸å…¥ä¸Šé™é‡‘é¡" disabled style="display:none;">
                    </div>
                </div>
                <button class="action-btn" onclick="calculateFee()">é–‹å§‹è¨ˆç®—</button>
                <div class="fee-result-box" id="fee_result_area" style="display:none;">
                    <div class="small">è¨ˆç®—çµæœ</div>
                    <div id="fee_final_amount" class="fee-total">$0</div>
                    <div id="fee_detail_msg" class="small" style="color:#666; white-space: pre-line;"></div>
                </div>
            </div>
        </section>
    </div>

    <div id="dashboard_view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div>
            <h1 id="page_title" style="margin:0; font-size:1.4rem;">ä¸»æ§å°</h1>
            <div class="small" id="header_date_line"></div>
        </div>
        </div>
        <section class="card" id="events_card" style="border-left: 4px solid #2196f3;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; border:none; padding:0;">ğŸ“† è¿‘æœŸé‡è¦è¡Œäº‹æ›†</h2>
            <div id="mgr_event_btns" style="display:none; gap:6px;">
                <button id="btn_history" class="btn-history">ğŸ“… æŸ¥è©¢</button>
                <button id="btn_toggle_event_add" class="btn-history" style="background:#2196f3;">+ æ–°å¢</button>
            </div>
        </div>
        <div id="event_add_box" style="display:none; margin-top:10px; padding:10px; background:#f9f9f9; border-radius:6px; border:1px solid #eee;">
            <input type="hidden" id="evt_id_edit" value="">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                <div style="display:flex; gap:6px;">
                    <label class="small" style="display:block">é–‹å§‹ <input type="date" id="evt_date_start"></label>
                    <label class="small" style="display:block">çµæŸ <input type="date" id="evt_date_end"></label>
                </div>
                <div style="flex:1; min-width:100px;">
                    <label class="small">é¡å‹
                        <select id="evt_type">
                            <option value="æ–½å·¥">æ–½å·¥</option>
                            <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                            <option value="é‡å¤§äº‹ä»¶">é‡å¤§äº‹ä»¶</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </label>
                </div>
                <div style="flex:2; min-width:180px;">
                    <label class="small">å…§å®¹ <input type="text" id="evt_content" placeholder="ä¾‹å¦‚ï¼šäºŒå» å€é›»åŠ›æ­²ä¿®"></label>
                </div>
                <div style="display:flex; gap:4px;">
                    <button id="btn_save_event" class="action-btn" style="width:auto; padding:8px 12px;">å„²å­˜</button>
                    <button id="btn_del_event_form" class="action-btn" style="width:auto; padding:8px 10px; background:#d32f2f; display:none;">åˆªé™¤</button>
                    <button id="btn_cancel_event" class="action-btn" style="width:auto; padding:8px 10px; background:#ccc; color:#333;">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="evt_msg" class="small" style="color:#d10000; margin-top:4px;"></div>
        </div>
        <div id="events_list" style="margin-top:10px; display:grid; gap:6px;">
            <div class="small">è¼‰å…¥ä¸­...</div>
        </div>
        </section>

        <dialog id="history_modal">
            <div class="modal-header">
                <h3 style="margin:0">æ­·å²è¡Œäº‹æ›†</h3>
                <button class="modal-close" id="btn_close_history">âœ•</button>
            </div>
            <div class="cal-controls">
                <button class="action-btn" style="width:36px;" id="cal_prev">&lt;</button>
                <span class="cal-title" id="cal_title" style="font-size:1.1rem; font-weight:bold; padding-top:6px;"></span>
                <button class="action-btn" style="width:36px;" id="cal_next">&gt;</button>
            </div>
            <div class="cal-grid" id="cal_grid"></div>
        </dialog>

        <div style="display:flex; gap:12px; align-items:flex-start; margin-top:15px; flex-wrap:wrap;">
        <section class="card" id="today_card" style="flex:1; min-width:240px;">
            <h2 style="margin:0; border:none; padding:0;">ä»Šå¤©ç­è¡¨</h2>
            <div class="small" id="today_date_line" style="margin-top:4px"></div>
            <div id="today_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="today_msg" class="small" style="margin-top:8px"></div>
        </section>
        <section class="card" id="mytasks_card" style="flex:2; min-width:280px;">
            <h2 style="margin:0; border:none; padding:0;">æˆ‘çš„ä»»å‹™ï¼ˆæœ€è¿‘ 5 ç­†ï¼‰</h2>
            <div id="mytasks_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="mytasks_msg" class="small" style="margin-top:8px"></div>
        </section>
        </div>

        <section class="card" style="margin-top:15px;">
        <h2 style="margin:0; border:none; padding:0;">æ–°å¢ä»»å‹™</h2>
        <div class="grid" style="margin-top:8px">
            <div><label class="small">æ¨™é¡Œ<input id="task_title" placeholder="ä¾‹å¦‚ï¼šå·¡æª¢æ¸…å–®æ›´æ–°" /></label></div>
            <div>
            <label class="small">ç‹€æ…‹
                <select id="task_status">
                <option value="open" selected>open</option>
                <option value="doing">doing</option>
                <option value="done">done</option>
                </select>
            </label>
            </div>
            <div><label class="small">æŒ‡æ´¾çµ¦ï¼ˆåŒå ´åŸŸï¼Œå¯è¤‡é¸ï¼‰<select id="task_assignees" multiple size="4" style="height:80px;"></select></label></div>
            <div style="display:flex; align-items:center; padding-top:20px">
            <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:0.9rem;">
                <input type="checkbox" id="task_assign_all" style="width:auto; margin:0"> æŒ‡æ´¾çµ¦å…¨é«”
            </label>
            </div>
        </div>
        <label class="small" style="display:block; margin-top:8px;">å…§å®¹<textarea id="task_body" placeholder="å¯ç©º" style="min-height:60px;"></textarea></label>
        <button id="btn_create" class="action-btn" style="width:auto; padding:6px 16px; margin-top:8px;">å»ºç«‹ä»»å‹™</button>
        <div id="create_msg" class="msg"></div>
        </section>
        
        <section class="card">
        <h2 style="margin:0; border:none; padding:0;">ä»»å‹™åˆ—è¡¨</h2>
        <div id="tasks_box" style="display:grid; gap:8px; margin-top:10px"></div>
        <div id="tasks_msg" class="small" style="margin-top:8px"></div>
        </section>
    </div>
  </main>

<script>
    function toggleNav(element) {
      const wasActive = element.classList.contains('active');
      document.querySelectorAll('.nav-category').forEach(cat => cat.classList.remove('active'));
      if (!wasActive) element.classList.add('active');
    }
    window.showDashboard = function() {
        document.getElementById('dashboard_view').style.display = 'block';
        document.getElementById('tools_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        document.getElementById('btn_home').classList.add('current');
    }
    window.showTool = function(toolType, btnElement) {
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        document.getElementById('tools_view').style.display = 'block';
        document.getElementById('tool_ui_calc').style.display = (toolType === 'calc') ? 'block' : 'none';
        document.getElementById('tool_ui_fee').style.display = (toolType === 'fee') ? 'block' : 'none';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(btnElement) btnElement.classList.add('current');
    }
    window.loadPage = function(pageUrl) {
        const siteId = document.getElementById('site_sel').value;
        if(!siteId) { alert("è«‹å…ˆé¸æ“‡å ´åŸŸ"); return; }
        const fullUrl = `${pageUrl}?site_id=${encodeURIComponent(siteId)}`;
        const frame = document.getElementById('main_frame');
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('tools_view').style.display = 'none';
        frame.style.display = 'block';
        frame.src = fullUrl;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(event && event.currentTarget) event.currentTarget.classList.add('current');
    }

    // è¨ˆç®—æ©Ÿ
    let calcVal = "0";
    function updateCalc(){ document.getElementById('calc_display').value = calcVal; }
    window.calcAppend = function(v) { if(calcVal==="0" && v!==".") calcVal=""; calcVal+=v; updateCalc(); }
    window.calcDel = function() { calcVal=calcVal.slice(0,-1); if(calcVal==="") calcVal="0"; updateCalc(); }
    window.calcClear = function() { calcVal="0"; updateCalc(); }
    window.calcResult = function() { try{ if(/[^0-9+\-*/.]/.test(calcVal)) throw new Error(); calcVal=String(eval(calcVal)); }catch(e){ calcVal="Error"; } updateCalc(); }

    // è²»ç”¨è©¦ç®—
    let currentFeeMode = 'count'; 
    window.switchFeeMode = function(mode) {
        currentFeeMode = mode;
        const btnCount=document.getElementById('mode_btn_count'), btnTime=document.getElementById('mode_btn_time');
        const inC=document.getElementById('fee_input_group_count'), inT=document.getElementById('fee_input_group_time');
        const setC=document.getElementById('fee_setting_count'), setT=document.getElementById('fee_setting_time');
        const capIn=document.getElementById('fee_cap_amount'), capChk=document.getElementById('fee_has_cap');
        if(mode==='count'){ 
            btnCount.classList.add('active'); btnTime.classList.remove('active');
            inC.style.display='block'; inT.style.display='none'; setC.style.display='block'; setT.style.display='none';
            capChk.checked=false; capIn.value="";
        } else {
            btnTime.classList.add('active'); btnCount.classList.remove('active');
            inC.style.display='none'; inT.style.display='block'; setC.style.display='none'; setT.style.display='block';
            capChk.checked=true; capIn.value=300;
        }
        toggleCapInput(); document.getElementById('fee_result_area').style.display='none';
    }
    window.toggleCapInput = function() {
        const c=document.getElementById('fee_has_cap'), i=document.getElementById('fee_cap_amount');
        i.disabled=!c.checked; i.style.display=c.checked?'block':'none';
    }
    const holidaySet = new Set(["2025-01-01","2025-02-28","2025-04-04","2025-05-01","2025-10-10","2025-01-27","2025-01-28","2025-01-29","2025-01-30","2025-05-31","2025-10-06","2026-01-01","2026-02-28","2026-04-04","2026-05-01","2026-10-10","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-04-05","2026-06-19","2026-09-25"]);
    function isNationalHoliday(d){ return holidaySet.has(d); }
    window.calculateFee = function() {
        let total=0, details="";
        const rule=document.querySelector('input[name="holiday_rule"]:checked').value;
        const treatNatAsHol=(rule==='weekend'), forceHol=document.getElementById('fee_manual_holiday').checked;
        if(currentFeeMode==='count'){
            const s=document.getElementById('fee_date_start').value, e=document.getElementById('fee_date_end').value;
            if(!s||!e){ alert("è«‹è¼¸å…¥æ—¥æœŸ"); return; } if(s>e){ alert("æ—¥æœŸéŒ¯èª¤"); return; }
            const dStart=new Date(s), dEnd=new Date(e);
            let n=0, h=0;
            for(let d=new Date(dStart); d<=dEnd; d.setDate(d.getDate()+1)){
                const iso=d.toISOString().slice(0,10), day=d.getDay(), isW=(day===0||day===6), isN=isNationalHoliday(iso);
                if(forceHol||isW||(isN&&treatNatAsHol)) h++; else n++;
            }
            const pN=parseFloat(document.getElementById('fee_count_normal').value)||0, pH=parseFloat(document.getElementById('fee_count_holiday').value)||0;
            total=(n*pN)+(h*pH); details=`å€é–“ï¼š${s}~${e}\nå¹³æ—¥ï¼š${n}å¤©Ã—$${pN}\nå‡æ—¥ï¼š${h}å¤©Ã—$${pH}`;
        } else {
            const s=document.getElementById('fee_datetime_start').value, e=document.getElementById('fee_datetime_end').value;
            if(!s||!e){ alert("è«‹è¼¸å…¥æ™‚é–“"); return; } const tS=new Date(s), tE=new Date(e); if(tS>=tE){ alert("æ™‚é–“éŒ¯èª¤"); return; }
            const mins=Math.floor((tE-tS)/1000/60);
            const unit=parseFloat(document.getElementById('fee_time_unit').value)||30, rN=parseFloat(document.getElementById('fee_time_rate_normal').value)||0, rH=parseFloat(document.getElementById('fee_time_rate_holiday').value)||0;
            const units=Math.ceil(mins/unit);
            const iso=tS.toISOString().slice(0,10), day=tS.getDay(), isW=(day===0||day===6), isN=isNationalHoliday(iso);
            const isHol=(forceHol||isW||(isN&&treatNatAsHol));
            total=units*(isHol?rH:rN); details=`ç¸½æ™‚é•·ï¼š${mins}åˆ† (${units}å–®ä½)\né¡å‹ï¼š${isHol?'å‡æ—¥':'å¹³æ—¥'}`;
        }
        if(document.getElementById('fee_has_cap').checked){
            const cap=parseFloat(document.getElementById('fee_cap_amount').value)||0;
            if(total>cap){ details+=`\n(å·²è§¸ç™¼ä¸Šé™$${cap})`; total=cap; }
        }
        document.getElementById('fee_final_amount').textContent=`$${total}`;
        document.getElementById('fee_detail_msg').textContent=details;
        document.getElementById('fee_result_area').style.display='block';
    }
</script>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);
    function setText(el, t){ if(el) el.textContent = t||""; }
    function setMsg(el, t){ if(el) el.textContent = t||""; }
    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function toISODateLocal(d){ const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }

    $("header_date_line").textContent = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'long', day:'numeric', weekday:'long' });

    function getTagClass(t){ return t==='æ–½å·¥'?'tag-construction':t==='ç¶­ä¿®'?'tag-maintenance':t==='é‡å¤§äº‹ä»¶'?'tag-major':'tag-other'; }
    function getCalEventClass(t){ return t==='æ–½å·¥'?'ce-construction':t==='ç¶­ä¿®'?'ce-maintenance':t==='é‡å¤§äº‹ä»¶'?'ce-major':'ce-other'; }
    function diffDays(d1, d2) { return Math.round((new Date(d1).setHours(0,0,0,0) - new Date(d2).setHours(0,0,0,0)) / 86400000); }
    
    window.startEditEvent = function(id, s, e, t, c) {
        $("history_modal").close(); $("evt_id_edit").value=id; $("evt_date_start").value=s; $("evt_date_end").value=e; $("evt_type").value=t; $("evt_content").value=c;
        $("event_add_box").style.display="block"; $("btn_save_event").textContent="æ›´æ–°";
        $("btn_del_event_form").style.display="block"; $("btn_del_event_form").onclick=()=>window.deleteEvent(id);
        $("events_card").scrollIntoView({ behavior:'smooth' });
    };
    window.deleteEvent = async function(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const { error } = await supabase.from("site_events").delete().eq("id", id);
        if(error) alert(error.message); else location.reload();
    };

    async function refreshSiteEvents(siteId, isManager){
        const listEl=$("events_list"); listEl.innerHTML='<div class="small">è¼‰å…¥ä¸­...</div>';
        const today=toISODateLocal(new Date());
        const { data, error } = await supabase.from("site_events").select("*").eq("site_id", siteId).gte("event_end_date", today).order("event_date", { ascending: true }).limit(5);
        if(error || !data.length){ listEl.innerHTML='<div class="small" style="color:#888;">è¿‘æœŸç„¡é‡å¤§äº‹ä»¶</div>'; return; }
        listEl.innerHTML="";
        const todayObj = new Date(today);
        data.forEach(evt => {
            const startDiff = diffDays(evt.event_date, todayObj);
            const endDiff = diffDays(evt.event_end_date, todayObj);
            let daysText="", daysClass="days-left", rowStyle="";
            if(startDiff>0){ daysText=(startDiff===1)?"æ˜å¤©é–‹å§‹":`é‚„æœ‰ ${startDiff} å¤©`; if(startDiff===1) daysClass+=" days-urgent"; }
            else { if(endDiff>=0){ daysText="ğŸ”¥ é€²è¡Œä¸­"; daysClass="days-urgent"; rowStyle="background-color:#fff8f8;"; } else { daysText="å·²çµæŸ"; daysClass="days-ended"; rowStyle="opacity:0.8;"; } }
            const dDisplay = (evt.event_date!==evt.event_end_date) ? `${evt.event_date} ~ ${evt.event_end_date}` : evt.event_date;
            const actions = isManager ? `<div class="btn-group-right"><button class="btn-icon btn-edit" onclick="startEditEvent('${evt.id}', '${evt.event_date}', '${evt.event_end_date}', '${evt.category}', '${escapeHtml(evt.content).replace(/'/g,"&apos;")}')">âœï¸</button></div>` : "";
            const div=document.createElement("div");
            div.style.cssText=`padding:6px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; ${rowStyle}`;
            div.innerHTML=`<div style="flex:1;"><span class="tag-event ${getTagClass(evt.category)}">${escapeHtml(evt.category)}</span><span style="font-weight:600;margin-right:6px;">${escapeHtml(evt.content)}</span><span class="small">(${dDisplay})</span></div><div style="display:flex;align-items:center;"><div class="${daysClass}">${daysText}</div>${actions}</div>`;
            listEl.appendChild(div);
        });
    }

    let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), cachedEvents=[];
    async function loadCalendarEvents(siteId){
        const {data} = await supabase.from("site_events").select("*").eq("site_id", siteId);
        if(data) cachedEvents=data; renderCalendar();
    }
    function renderCalendar() {
        const grid=$("cal_grid"), title=$("cal_title"); title.textContent=`${calYear} å¹´ ${calMonth+1} æœˆ`; grid.innerHTML="";
        ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(w => { const d=document.createElement("div"); d.className="cal-head"; d.textContent=w; grid.appendChild(d); });
        const firstDay=new Date(calYear, calMonth, 1).getDay(), daysInMonth=new Date(calYear, calMonth+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(Object.assign(document.createElement("div"), {className:"cal-day other-month"}));
        for(let d=1; d<=daysInMonth; d++){
            const div=document.createElement("div"); div.className="cal-day";
            if(new Date().toDateString()===new Date(calYear,calMonth,d).toDateString()) div.classList.add("cal-today");
            div.innerHTML=`<span class="cal-date-num">${d}</span>`;
            const cur=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cachedEvents.filter(e => e.event_date<=cur && e.event_end_date>=cur).forEach(e => {
                const bar=document.createElement("div"); bar.className=`cal-event-bar ${getCalEventClass(e.category)}`; bar.textContent=e.content;
                bar.onclick=(ev)=>{ ev.stopPropagation(); startEditEvent(e.id, e.event_date, e.event_end_date, e.category, escapeHtml(e.content).replace(/'/g,"&apos;")); };
                div.appendChild(bar);
            });
            grid.appendChild(div);
        }
    }

    async function saveSiteEvent(siteId, uid){
        const id=$("evt_id_edit").value, s=$("evt_date_start").value, e=$("evt_date_end").value, t=$("evt_type").value, c=$("evt_content").value.trim();
        if(!s||!e||!c) return setMsg($("evt_msg"), "è«‹å¡«å¯«å®Œæ•´");
        if(s>e) return setMsg($("evt_msg"), "æ—¥æœŸéŒ¯èª¤");
        setMsg($("evt_msg"), "è™•ç†ä¸­...");
        const payload = { site_id:siteId, event_date:s, event_end_date:e, category:t, content:c, created_by:uid };
        const q = id ? supabase.from("site_events").update(payload).eq("id",id) : supabase.from("site_events").insert(payload);
        const {error} = await q;
        if(error) setMsg($("evt_msg"), error.message); else location.reload();
    }

    async function getSitePeople(siteId){
        const r = await supabase.rpc("get_site_people", { p_site_id: siteId });
        return { error: r.error, people: (r.data||[]).map(x=>({user_id:x.user_id, name:x.display_name||x.user_id})) };
    }
    async function loadAssignees(siteId){
        const sel=$("task_assignees"); sel.innerHTML="";
        const {people} = await getSitePeople(siteId);
        people.forEach(p => { const o=document.createElement("option"); o.value=p.user_id; o.textContent=p.name; sel.appendChild(o); });
    }

    async function refreshTasks(siteId, uid){
        const box=$("tasks_box"); box.innerHTML=""; setText($("tasks_msg"),"è®€å–ä¸­...");
        const {data:rows} = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at",{ascending:false});
        if(!rows || !rows.length){ setText($("tasks_msg"),"ç„¡ä»»å‹™"); return; }
        setText($("tasks_msg"), `å…± ${rows.length} ç­†`);
        const {people} = await getSitePeople(siteId); const nameMap={}; people.forEach(p=>nameMap[p.user_id]=p.name);
        const tIds=rows.map(r=>r.id);
        const {data:assData} = await supabase.from("task_assignees").select("*").in("task_id", tIds);
        const {data:compData} = await supabase.from("task_completions").select("*").in("task_id", tIds);
        const assMap={}, compMap={};
        (assData||[]).forEach(a => { if(!assMap[a.task_id])assMap[a.task_id]=[]; assMap[a.task_id].push(a.user_id); });
        (compData||[]).forEach(c => { if(!compMap[c.task_id])compMap[c.task_id]=[]; compMap[c.task_id].push(c); });
        
        rows.forEach(r => {
            const explicit = assMap[r.id] || [];
            const assNames = r.assign_all ? "å…¨é«”" : (explicit.length ? explicit.map(u=>nameMap[u]||u).join("ã€") : "æœªæŒ‡æ´¾");
            const doneLine = (compMap[r.id]||[]).slice(0,3).map(x=>(nameMap[x.user_id]||x.user_id)).join(", ");
            const canComp = (r.assign_all || explicit.includes(uid)) && !(compMap[r.id]||[]).some(x=>x.user_id===uid) && r.status!=="done";
            
            const div=document.createElement("div"); div.className="task";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.title)}</strong><span class="small">${new Date(r.created_at).toLocaleDateString()}</span></div>
            ${r.body?`<div style="margin-top:4px;white-space:pre-wrap">${escapeHtml(r.body)}</div>`:""}
            <div class="small" style="margin-top:6px">æŒ‡æ´¾ï¼š${escapeHtml(assNames)}ï½œç‹€æ…‹ï¼š${r.status}</div>
            ${doneLine?`<div class="small" style="color:#2e7d32">å·²å®Œæˆï¼š${doneLine}</div>`:""}
            ${canComp?`<button class="action-btn" style="width:auto;padding:2px 8px;font-size:12px;margin-top:6px;">æ¨™è¨˜å®Œæˆ</button>`:""}`;
            if(canComp) div.querySelector("button").onclick = async () => {
                await supabase.from("task_completions").insert({task_id:r.id, user_id:uid});
                refreshTasks(siteId, uid);
            };
            box.appendChild(div);
        });
    }

    async function refreshMyTasksPanel(siteId, uid){
        const box=$("mytasks_box"); box.innerHTML="";
        const {data:rows} = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at",{ascending:false}).limit(20);
        if(!rows || !rows.length) return setText($("mytasks_msg"),"ç„¡");
        const {data:ass} = await supabase.from("task_assignees").select("task_id").eq("user_id", uid);
        const myTIds = new Set((ass||[]).map(x=>x.task_id));
        const mine = rows.filter(r => r.created_by===uid || r.assign_all || myTIds.has(r.id)).slice(0,5);
        if(!mine.length) return setText($("mytasks_msg"),"ç„¡è¿‘æœŸä»»å‹™");
        setText($("mytasks_msg"),"");
        mine.forEach(r => {
            const div=document.createElement("div"); div.className="task";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.title)}</strong><span class="small">${r.status}</span></div>`;
            box.appendChild(div);
        });
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿ä¸»ç®¡æ¬Šé™æª¢æŸ¥æœ€å„ªå…ˆåŸ·è¡Œ â˜…â˜…â˜…
    function isManagerRole(r){ return r==="engineer"||r==="supervisor"; }
    function roleLabel(r){ return r==="engineer"?"å·¥ç¨‹å¸«":r==="supervisor"?"ä¸»ç®¡":"å“¡å·¥"; }

    async function refreshLeaveBadge(siteId, roleCur){
        const btnGroup = $("group_manager");
        const badge = $("leave_badge");
        const groupBadge = $("group_badge");
        
        // 1. å…ˆæ±ºå®šæ˜¯å¦é¡¯ç¤ºä¸»ç®¡é¸å–® (æœ€é‡è¦)
        if(isManagerRole(roleCur)){
            btnGroup.style.display = "block";
            // 2. åªæœ‰ä¸»ç®¡æ‰éœ€è¦å»æŸ¥ç´…é»
            const { count } = await supabase.from("leave_requests").select("id", { count: "exact", head: true }).eq("site_id", siteId).eq("status", "pending");
            if(count > 0){
                badge.style.display = "inline-block"; groupBadge.style.display = "inline-block";
            } else {
                badge.style.display = "none"; groupBadge.style.display = "none";
            }
        } else {
            btnGroup.style.display = "none";
        }
    }

    async function refreshTodaySchedule(siteId){
        const box=$("today_box"); box.innerHTML=""; $("today_msg").textContent="è®€å–ä¸­...";
        const today=toISODateLocal(new Date()); $("today_date_line").textContent=today;
        const {data} = await supabase.from("site_schedules").select("person_name,shift").eq("site_id",siteId).eq("work_date",today);
        if(!data||!data.length) return $("today_msg").textContent="ç„¡ç­è¡¨";
        $("today_msg").textContent=`å…± ${data.length} äºº`;
        data.forEach(r => {
            const div=document.createElement("div"); div.className="task"; div.style.padding="6px";
            div.innerHTML=`<div style="display:flex;justify-content:space-between;"><strong>${escapeHtml(r.person_name)}</strong><span>${escapeHtml(r.shift)}</span></div>`;
            box.appendChild(div);
        });
    }

    async function refreshMyScheduleLine(siteId, uid){
        const el=$("my_shift_text"); if(!el) return;
        const {data:links} = await supabase.from("site_person_links").select("person_name").eq("site_id", siteId).eq("user_id", uid);
        if(!links || !links.length) return el.innerHTML=`<span class="small" style="color:#999">æœªé€£çµç­è¡¨</span>`;
        const name = links[0].person_name;
        
        const today=new Date();
        const start=toISODateLocal(today);
        const endDt=new Date(); endDt.setDate(today.getDate()+30); const end=toISODateLocal(endDt);
        const tmrDt=new Date(); tmrDt.setDate(today.getDate()+1); const tmrStr=toISODateLocal(tmrDt);

        const {data:rows} = await supabase.from("site_schedules").select("work_date,shift").eq("site_id",siteId).eq("person_name",name).gte("work_date",start).lte("work_date",end).order("work_date");
        const list = rows || [];
        const todayShift = list.find(r=>r.work_date===start)?.shift || "ç„¡";
        const tmrShift = list.find(r=>r.work_date===tmrStr)?.shift || "ç„¡";
        
        const keywords=["ä¼‘","å‡"];
        const isTodayLeave = keywords.some(k=>todayShift.includes(k));
        let statusHtml = "";
        
        if(isTodayLeave) {
            statusHtml = `<div class="leave-countdown-bar status-on-leave">ğŸ–ï¸ ä¼‘å‡ä¸­ Enjoy!</div>`;
        } else {
            const nextLeave = list.find(r => r.work_date > start && keywords.some(k=>(r.shift||"").includes(k)));
            if(nextLeave){
                const diff = diffDays(nextLeave.work_date, start);
                statusHtml = `<div class="leave-countdown-bar status-working">ğŸ’ª ${diff===1?"æ˜å¤©":diff+" å¤©å¾Œ"} æ”¾å‡</div>`;
            } else {
                statusHtml = `<div class="leave-countdown-bar" style="background:#eee;color:#666">ğŸ“… è¿‘æœŸç„¡ä¼‘å‡</div>`;
            }
        }
        el.innerHTML = `<div class="shift-card"><div class="shift-row"><span class="shift-label">ä»Šæ—¥</span><span class="shift-val-today">${escapeHtml(todayShift)}</span></div><div class="shift-row" style="border-bottom:1px dashed #eee;padding-bottom:4px;margin-bottom:4px;"><span class="shift-label">æ˜æ—¥</span><span class="shift-val-tmr">${escapeHtml(tmrShift)}</span></div>${statusHtml}</div>`;
    }

    async function main(){
        $("btn_logout").onclick = async () => { await supabase.auth.signOut(); location.href="./index.html"; };
        const {data:{session}} = await supabase.auth.getSession();
        if(!session) return location.href="./index.html";
        const uid = session.user.id;
        
        // è¼‰å…¥å€‹äºº
        const {data:profile} = await supabase.from("profiles").select("display_name,username").eq("user_id", uid).single();
        const {data:mems} = await supabase.from("site_memberships").select("site_id,role").eq("user_id", uid).eq("is_active", true);
        if(!profile || !mems){ alert("è®€å–å¤±æ•—"); return; }
        setText($("me_name"), profile.display_name || profile.username);

        // è¼‰å…¥å ´åŸŸ
        const {data:sites} = await supabase.from("sites").select("id,name").in("id", mems.map(m=>m.site_id));
        const sel = $("site_sel");
        sites.forEach(s => { const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });
        
        const refreshAll = async () => {
            const siteId = sel.value;
            const role = mems.find(m=>m.site_id===siteId)?.role || "";
            setText($("me_role"), roleLabel(role));
            $("page_title").textContent = `${sites.find(s=>s.id===siteId)?.name} ä¸»æ§å°`;

            // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå°‡ä¸»ç®¡æª¢æŸ¥ç§»åˆ°æœ€å‰é¢ â˜…â˜…â˜…
            // é€™æ¨£å³ä½¿å¾Œé¢ç­è¡¨è®€å–å‡ºéŒ¯ï¼Œä¸»ç®¡é¸å–®ä¹Ÿå·²ç¶“é¡¯ç¤ºå‡ºä¾†äº†
            await refreshLeaveBadge(siteId, role);
            
            // æ¥è‘—åŸ·è¡Œå…¶ä»–éé—œéµ UI
            refreshTodaySchedule(siteId);
            refreshMyScheduleLine(siteId, uid);
            loadAssignees(siteId);
            refreshTasks(siteId, uid);
            refreshMyTasksPanel(siteId, uid);
            refreshSiteEvents(siteId, isManagerRole(role));
            
            // Iframe é€£å‹•
            const frame = $("main_frame");
            if(frame.style.display!=="none" && window.currentIframeUrl) window.loadPage(window.currentIframeUrl);
            
            // äº‹ä»¶æŒ‰éˆ•æ¬Šé™
            $("mgr_event_btns").style.display = isManagerRole(role) ? "flex" : "none";
        };

        if(sites.length) { sel.value=sites[0].id; refreshAll(); }
        sel.onchange = refreshAll;
        
        // å®šæœŸæª¢æŸ¥ç´…é» (éœé»˜åŸ·è¡Œ)
        setInterval(async()=>{
            const siteId=sel.value; const role=mems.find(m=>m.site_id===siteId)?.role||"";
            if(siteId) refreshLeaveBadge(siteId, role);
        }, 30000);

        // åˆå§‹åŒ–å…¶ä»–UIäº‹ä»¶
        $("cal_prev").onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();};
        $("cal_next").onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();};
        $("btn_history").onclick=async()=>{await loadCalendarEvents(sel.value);$("history_modal").showModal();};
        $("btn_close_history").onclick=()=>$("history_modal").close();
        $("btn_toggle_event_add").onclick=()=>{ 
            const b=$("event_add_box"); 
            if(b.style.display==="none"){ 
                $("evt_id_edit").value=""; $("evt_content").value=""; $("btn_save_event").textContent="å„²å­˜"; 
                $("btn_del_event_form").style.display="none"; 
                const t=new Date(); t.setDate(t.getDate()+1); const ts=toISODateLocal(t);
                $("evt_date_start").value=ts; $("evt_date_end").value=ts;
                b.style.display="block"; 
            } else b.style.display="none";
        };
        $("btn_cancel_event").onclick=()=>$("event_add_box").style.display="none";
        $("btn_save_event").onclick=()=>saveSiteEvent(sel.value, uid);
        
        $("btn_create").onclick=async()=>{
            const t=$("task_title").value, b=$("task_body").value, st=$("task_status").value;
            const all=$("task_assign_all").checked, selAss=$("task_assignees");
            const uids=Array.from(selAss.selectedOptions).map(o=>o.value);
            if(!t) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
            const {data, error} = await supabase.from("tasks").insert({site_id:sel.value, title:t, body:b, status:st, created_by:uid, assign_all:all}).select().single();
            if(error) return alert(error.message);
            if(!all && uids.length) await supabase.from("task_assignees").insert(uids.map(u=>({task_id:data.id, user_id:u})));
            $("task_title").value=""; $("task_body").value=""; refreshTasks(sel.value, uid); refreshMyTasksPanel(sel.value, uid);
        };
    }
    main();
</script>
</body>
</html>