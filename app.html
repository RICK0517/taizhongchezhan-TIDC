<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸»æ§å°</title>
  <style>
    /* ===== åŸºç¤é‡ç½®èˆ‡è®Šæ•¸ ===== */
    :root {
      --sidebar-width: 180px; 
      --header-height: 50px;
      --primary-color: #2196f3;
      --bg-color: #f4f6f8;
    }
    body { 
      font-family: system-ui, "Segoe UI", Arial, sans-serif; 
      margin: 0; padding: 0; 
      background: var(--bg-color); 
      color: #333;
      display: flex;
      height: 100vh; /* å›ºå®šé«˜åº¦ï¼Œè®“å…§éƒ¨æ»¾å‹• */
      overflow: hidden; /* é˜²æ­¢æ•´é æ»¾å‹• */
    }
    *, *::before, *::after { box-sizing: border-box; }

    /* ===== å·¦å´å´é‚Šæ¬„æ¨£å¼ ===== */
/* ===== å·¦å´å´é‚Šæ¬„æ¨£å¼ (ä¿®æ”¹å¾Œ) ===== */
    .sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0; 
      z-index: 100;
      height: 100vh; /* ç¢ºä¿é«˜åº¦æ’æ»¿ */
      overflow: hidden; /* â˜…é—œéµï¼šå¤–å±¤ä¸æ»¾å‹• */
      padding: 0; /* ç§»é™¤å¤–å±¤ paddingï¼Œç§»çµ¦å…§éƒ¨å®¹å™¨ */
      box-shadow: 2px 0 5px rgba(0,0,0,0.02);
      font-size: 0.9rem;
    }

    /* â˜…æ–°å¢ï¼šä¸­é–“æ»¾å‹•å€åŸŸ */
/* â˜…ä¿®æ”¹ï¼šä¸­é–“æ»¾å‹•å€åŸŸ */
    .sidebar-scroll-content {
      flex: 1; 
      
      /* åŸæœ¬æ˜¯ auto (è‡ªå‹•)ï¼Œæ”¹æˆ scroll (å¼·åˆ¶é¡¯ç¤º) */
      overflow-y: scroll; 
      
      padding: 10px;
      
      /* é‡å° Firefox çš„è¨­å®š (è®“æ²è»¸è®Šç´°) */
      scrollbar-width: thin; 
      scrollbar-color: #cfd8dc transparent;
    }

    /* ===== æ–°å¢ï¼šç¾åŒ–å´é‚Šæ¬„æ²è»¸ (è®“å¼·åˆ¶é¡¯ç¤ºçš„æ²è»¸ä¸é‚£éº¼ç¤™çœ¼) ===== */
    
    /* æ²è»¸æ•´é«”å¯¬åº¦ */
    .sidebar-scroll-content::-webkit-scrollbar {
      width: 6px; /* è¨­å®šå¾ˆç´°ï¼Œæ¸›å°‘è¦–è¦ºå¹²æ“¾ */
    }

    /* æ²è»¸è»Œé“ (èƒŒæ™¯) */
    .sidebar-scroll-content::-webkit-scrollbar-track {
      background: transparent; /* å¹³æ™‚éš±è—è»Œé“èƒŒæ™¯ */
    }

    /* æ²è»¸æ‹‰æ¡¿ (æœ¬é«”) */
    .sidebar-scroll-content::-webkit-scrollbar-thumb {
      background-color: #cfd8dc; /* æ·ºç°è‰² */
      border-radius: 10px; /* åœ“è§’ */
    }

    /* æ»‘é¼ ç§»éå»æ™‚è®Šæ·±ä¸€é» */
    .sidebar-scroll-content::-webkit-scrollbar-thumb:hover {
      background-color: #b0bec5; 
    }

    /* â˜…ä¿®æ”¹ï¼šåº•éƒ¨å›ºå®šå€åŸŸ */
    .sidebar-footer { 
      flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
      padding: 15px 10px; /* çµ¦äºˆå…§éƒ¨é–“è· */
      border-top: 1px solid #eee; 
      background-color: #fcfcfc; /* ç¨å¾®å€éš”èƒŒæ™¯è‰² */
      z-index: 101;
    }

    .brand {
      font-size: 1.1rem;
      font-weight: 800; color: #1565c0;
      margin-bottom: 15px; padding-left: 5px; 
      display: flex; align-items: center;
      cursor: pointer;
    }
    
    /* ===== ä¿®æ”¹ï¼šç·Šæ¹Šå‹å€‹äººè³‡è¨Šæ¨£å¼ ===== */
        .user-profile {
          background: #f5f9ff; 
          border-radius: 6px; 
          padding: 8px 10px;
          margin-bottom: 10px; 
          border: 1px solid #e3f2fd;
          display: flex;
          flex-direction: column;
          gap: 4px; /* ç¸®å°å…ƒä»¶é–“è· */
        }

        /* æ–°å¢ï¼šå°‡å§“åèˆ‡è·ä½æ©«å‘æ’åˆ— */
        .profile-header {
          display: flex;
          align-items: center; /* å‚ç›´ç½®ä¸­å°é½Š */
          gap: 8px; /* å§“åèˆ‡è·ä½ä¸­é–“çš„è·é›¢ */
          flex-wrap: wrap; /* å¦‚æœåå­—å¤ªé•·è‡ªå‹•æ›è¡Œï¼Œé¿å…è·‘ç‰ˆ */
        }

        .user-name { 
          font-weight: 800; 
          font-size: 0.95rem; 
          color: #1565c0; 
        }

        .user-role { 
          font-size: 0.7rem; 
          color: #555; 
          background-color: #e3f2fd; /* æ·¡è—è‰²èƒŒæ™¯ï¼Œåƒå€‹å°æ¨™ç±¤ */
          padding: 2px 6px;
          border-radius: 4px;
          white-space: nowrap; /* é˜²æ­¢è·ä½æ–‡å­—æ›è¡Œ */
        }
        
        /* ç­è¡¨æ–‡å­—å€å¡Š */
        .shift-text { 
          width: 100%;
    }
    /* å †ç–Šé¸å–® */
    .nav-category { margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
    .nav-header {
      width: 100%; text-align: left; background: none; border: none;
      padding: 8px 5px; font-weight: 700; color: #555; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: 4px; transition: background 0.2s; font-size: 0.85rem;
      position: relative;
    }
    .nav-header:hover { background: #f8f8f8; color: #000; }
    .nav-arrow { font-size: 0.6em; transition: transform 0.3s; opacity: 0.5; }
    .nav-category.active .nav-arrow { transform: rotate(180deg); }
    /* ===== ä¿®æ”¹ï¼šå †ç–Šé¸å–®æ»‘å‹•ç‰¹æ•ˆ ===== */
        .nav-items { 
          /* é—œéµï¼šä½¿ç”¨ max-height èˆ‡ opacity è£½ä½œå‹•ç•«ï¼Œè€Œé display:none */
          display: flex; 
          flex-direction: column; 
          gap: 2px; 
          padding-left: 8px; 
          
          /* é è¨­é—œé–‰ç‹€æ…‹ */
          max-height: 0;
          opacity: 0;
          overflow: hidden; /* é˜²æ­¢å…§å®¹åœ¨ç¸®èµ·æ™‚æº¢å‡º */
          margin-bottom: 0;
          
          /* å‹•ç•«è¨­å®šï¼š0.3ç§’æ»‘å‹• */
          transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-bottom 0.3s ease;
        }

        /* é–‹å•Ÿç‹€æ…‹ */
        .nav-category.active .nav-items { 
          /* çµ¦äºˆä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦è®“å…§å®¹å±•é–‹ (å¦‚æœé¸é …éå¸¸å¤šï¼Œå¯å°‡æ•¸å€¼èª¿å¤§) */
          max-height: 500px; 
          opacity: 1;
          margin-bottom: 8px;
        }

    /* å´é‚Šæ¬„æŒ‰éˆ• */
    .nav-btn {
      text-align: left; background: transparent; border: none;
      padding: 6px 8px; font-size: 0.8rem; color: #666;
      cursor: pointer; border-radius: 4px; position: relative;
      transition: all 0.2s;
    }
    .nav-btn:hover { background: #e3f2fd; color: #1565c0; }
    .nav-btn.current { background: #e3f2fd; color: #1565c0; font-weight: bold; }
    
    .sidebar-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
    .btn-logout { width: 100%; padding: 6px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    select.site-select { width: 100%; margin-bottom: 8px; padding: 4px; font-size: 0.8rem; }
    
    .badge-dot { display: inline-block; width: 6px; height: 6px; background-color: #d32f2f; border-radius: 50%; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); }
    .group-badge-dot { display: inline-block; width: 8px; height: 8px; background-color: #d32f2f; border-radius: 50%; margin-right: 6px; }

    /* ===== å³å´ä¸»è¦å…§å®¹å€ ===== */
    .main-wrapper {
      flex: 1; width: 100%;
      height: 100vh;
      overflow-y: auto; /* è®“å…§å®¹å€è‡ªå·±æ»¾å‹• */
      position: relative;
      background: var(--bg-color);
    }
    
    /* å„€è¡¨æ¿è¦–åœ– (é è¨­é¡¯ç¤º) */
    #dashboard_view, #tools_view {
      padding: 20px 30px;
      max-width: 1200px; /* é™åˆ¶æœ€å¤§å¯¬åº¦æ¯”è¼ƒå¥½çœ‹ */
      margin: 0 auto;
    }
    
    #tools_view { display: none; } /* é è¨­éš±è—å·¥å…·å€ */

    /* Iframe è¦–åœ– (é è¨­éš±è—) */
    #main_frame {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
      background: #fff;
    }

    /* å¡ç‰‡èˆ‡å…ƒä»¶æ¨£å¼ */
    .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
    h2 { font-size: 1.1rem; color: #333; margin-bottom: 12px; border-left: 4px solid var(--primary-color); padding-left: 8px; }
    
    input, select, textarea, button.action-btn { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
    button.action-btn { background: #2196f3; color: white; font-weight: bold; border: none; cursor: pointer; transition: opacity 0.2s; }
    button.action-btn:hover { opacity: 0.9; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    
    .small { font-size: 12px; color: #666; }
    .msg { margin-top: 8px; white-space: pre-wrap; color: #b00020; font-size: 0.85rem; }
    .task { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px; transition: transform 0.2s; }
    .task:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* RWD */
    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; padding: 10px; }
      .main-wrapper { height: auto; overflow: visible; }
      #main_frame { height: 800px; /* æ‰‹æ©Ÿç‰ˆçµ¦ä¸€å€‹å›ºå®šé«˜åº¦ */ }
      .nav-items { display: none; }
      .nav-category.active .nav-items { display: flex; }
    }

    /* å…¶ä»–æ¨£å¼ (æ¨™ç±¤ç­‰) */
    #today_card { height: auto; min-height: 400px; max-height: 700px; overflow-y: auto; }
    .shift-red{ color:#d10000; font-weight:700; }
    .shift-orange{ color:#e67e00; font-weight:700; }
    .tag-event { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; }
    .tag-construction { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .tag-maintenance { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .tag-major { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
    .tag-other { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
    .days-left { float: right; font-weight: bold; color: #00695c; font-size: 0.85rem; }
    .days-urgent { color: #d32f2f; }
    .btn-group-right { float: right; display: flex; gap: 4px; margin-left: 8px; }
    .btn-icon { border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 12px; color: #fff; }
    .btn-edit { background-color: #1976d2; } 
    .btn-history { background-color: #607d8b; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }

    /* Modal */
    dialog { border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 95%; max-width: 800px; padding: 15px; background: #fff; }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
    .modal-close { background: transparent; border: none; font-size: 18px; cursor: pointer; color: #666; }
    .cal-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
    .cal-head { background: #f5f5f5; padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; font-size: 0.8rem; }
    .cal-day { min-height: 80px; padding: 2px; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; background: #fff; }
    .cal-event-bar { font-size: 10px; padding: 1px 3px; margin-bottom: 1px; border-radius: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid rgba(0,0,0,0.1); }
    .ce-construction { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .ce-maintenance { background: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
    .ce-major { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
    .ce-other { background: #f5f5f5; color: #616161; border-color: #e0e0e0; }
    
    /* ===== è¨ˆç®—æ©Ÿèˆ‡å·¥å…·æ¨£å¼ ===== */
    .tool-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
    .tool-tab-btn { background: none; border: none; border-bottom: 3px solid transparent; padding: 8px 16px; font-weight: bold; color: #666; cursor: pointer; font-size: 1rem; }
    .tool-tab-btn.active { border-bottom-color: #2196f3; color: #2196f3; }
    
    /* è¨ˆç®—æ©Ÿ */
    .calc-container { width: 100%; max-width: 320px; margin: 0 auto; background: #333; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .calc-display { width: 100%; height: 60px; background: #444; color: white; text-align: right; font-size: 2rem; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: none; outline: none; }
    .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .calc-btn { width: 100%; padding: 15px 0; font-size: 1.2rem; border-radius: 8px; border: none; cursor: pointer; background: #555; color: white; transition: background 0.1s; }
    .calc-btn:active { background: #777; }
    .calc-btn.op { background: #f39c12; color: white; }
    .calc-btn.eq { background: #2196f3; color: white; grid-column: span 2; }
    .calc-btn.clr { background: #d32f2f; }

    /* è²»ç”¨è©¦ç®— */
    .fee-form { max-width: 600px; margin: 0 auto; }
    .fee-group { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
    .fee-label { display: block; font-weight: bold; margin-bottom: 4px; color: #555; }
    .fee-result-box { margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb; text-align: center; }
    .fee-total { font-size: 1.8rem; font-weight: bold; color: #1565c0; margin: 5px 0; }
    .switch-mode-btn { margin-right: 10px; padding: 6px 12px; background: #eee; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; }
    .switch-mode-btn.active { background: #2196f3; color: white; border-color: #2196f3; }
    /* ===== æ–°å¢ï¼šå´é‚Šæ¬„å€‹äººç­è¡¨å¢å¼·æ¨£å¼ ===== */
    .user-profile {
      /* èª¿æ•´åŸæœ¬çš„ profile æ¨£å¼ï¼Œå¢åŠ é–“è· */
      gap: 6px;
      display: flex;
      flex-direction: column;
    }
    
    .shift-card {
      background-color: #fff;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 8px 10px;
      margin-top: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .shift-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    
    .shift-label { font-size: 0.75rem; color: #78909c; }
    
    /* ä»Šæ—¥ç­åˆ¥åŠ å¤§åŠ ç²— */
    .shift-val-today { 
      font-size: 1.2rem; 
      font-weight: 800; 
      color: #1565c0; 
    }
    
    .shift-val-tmr { 
      font-size: 0.9rem; 
      font-weight: 600; 
      color: #555; 
    }

    /* ä¼‘å‡å€’æ•¸æ¢ */
    .leave-countdown-bar {
      margin-top: 6px;
      padding: 4px 0;
      border-radius: 4px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: bold;
      display: block;
    }
    
    /* å·¥ä½œä¸­ç‹€æ…‹ (ç¶ è‰²ç³»æˆ–è—è‰²ç³») */
    .status-working {
      background-color: #e0f2f1; 
      color: #00695c;
      border: 1px solid #b2dfdb;
    }
    
    /* ä¼‘å‡ä¸­ç‹€æ…‹ (ç´…è‰²ç³»æˆ–é¡¯çœ¼è‰²) */
    .status-on-leave {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>

<nav class="sidebar">
    <div class="sidebar-scroll-content">
    
        <div class="brand" onclick="showDashboard()">ğŸ“… æ’ç­ç³»çµ±</div>
        
        <div class="user-profile">
          <div class="profile-header">
            <div id="me_name" class="user-name">è®€å–ä¸­...</div>
            <div id="me_role" class="user-role"></div>
          </div>
          <div id="my_shift_text" class="shift-text"></div>
        </div>

        <div class="nav-category active" onclick="toggleNav(this)">
            <button class="nav-header">ä¸€èˆ¬åŠŸèƒ½<span class="nav-arrow">â–¼</span></button>
            <div class="nav-items" onclick="event.stopPropagation()">
                <button class="nav-btn current" id="btn_home" onclick="showDashboard()">ğŸ  ä¸»æ§å°</button>
            </div>
        </div>

        <div class="nav-category active" onclick="toggleNav(this)">
          <button class="nav-header">å°å·¥å…·<span class="nav-arrow">â–¼</span></button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="showTool('calc', this)">ğŸ§® è¨ˆç®—æ©Ÿ</button>
            <button class="nav-btn" onclick="showTool('fee', this)">ğŸ’° é‡‘é¡è©¦ç®—</button>
          </div>
        </div>

 <div class="nav-category" onclick="toggleNav(this)">
          <button class="nav-header">
            å€‹äººè³‡æ–™
            <span class="nav-arrow">â–¼</span>
          </button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./schedule_view.html')">ğŸ“… æŸ¥çœ‹ç­è¡¨</button>
            <button class="nav-btn" onclick="loadPage('./staff_info.html')">ğŸ‘¤ äººäº‹è³‡æ–™</button>
          </div>
        </div>

        <div class="nav-category" onclick="toggleNav(this)">
          <button class="nav-header">
            ä¼‘å‡ç”³è«‹
            <span class="nav-arrow">â–¼</span>
          </button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./leave_apply.html')">ğŸ“ ç”³è«‹ä¼‘å‡</button>
            <button class="nav-btn" onclick="loadPage('./stats.html')">ğŸ“Š å‡åˆ¥çµ±è¨ˆ</button>
          </div>
        </div>

        <div class="nav-category" id="group_manager" style="display:none;" onclick="toggleNav(this)">
          <button class="nav-header">
            ä¸»ç®¡ç®¡ç†
            <div style="display:flex; align-items:center;">
              <span id="group_badge" class="group-badge-dot" style="display:none;"></span>
              <span class="nav-arrow">â–¼</span>
            </div>
          </button>
          <div class="nav-items" onclick="event.stopPropagation()">
            <button class="nav-btn" onclick="loadPage('./mapping.html')">ğŸ‘¥ äººå“¡å°ç…§</button>
            <button class="nav-btn" onclick="loadPage('./schedule_import.html')">ğŸ“¥ åŒ¯å…¥ç­è¡¨</button>
            <button id="btn_leave_review" class="nav-btn" onclick="loadPage('./leave_review.html')">
              âœ… å¯©æ ¸è«‹å‡
              <span id="leave_badge" class="badge-dot" style="display:none;"></span>
            </button>
          </div>
        </div>

    </div> 
    <div class="sidebar-footer">
      <label class="small" style="display:block; margin-bottom:2px;">åˆ‡æ›å ´åŸŸ</label>
      <select id="site_sel" class="site-select"></select>
      <button id="btn_logout" class="btn-logout">ç™»å‡º</button>
      <div id="dbg" class="small" style="margin-top:6px; word-break:break-all; font-size:10px;"></div>
    </div>
  </nav>


  <main class="main-wrapper">
    
    <iframe id="main_frame" src=""></iframe>

    <div id="tools_view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 id="tool_page_title" style="margin:0; font-size:1.4rem;">å°å·¥å…·</h1>
        </div>

        <section id="tool_ui_calc" class="card" style="display:none;">
            <h2 style="text-align:center; border:none;">ç°¡æ˜“è¨ˆç®—æ©Ÿ</h2>
            <div class="calc-container">
                <input type="text" id="calc_display" class="calc-display" readonly value="0">
                <div class="calc-keys">
                    <button class="calc-btn clr" onclick="calcClear()">C</button>
                    <button class="calc-btn op" onclick="calcAppend('/')">Ã·</button>
                    <button class="calc-btn op" onclick="calcAppend('*')">Ã—</button>
                    <button class="calc-btn op" onclick="calcDel()">â†</button>
                    
                    <button class="calc-btn" onclick="calcAppend('7')">7</button>
                    <button class="calc-btn" onclick="calcAppend('8')">8</button>
                    <button class="calc-btn" onclick="calcAppend('9')">9</button>
                    <button class="calc-btn op" onclick="calcAppend('-')">-</button>
                    
                    <button class="calc-btn" onclick="calcAppend('4')">4</button>
                    <button class="calc-btn" onclick="calcAppend('5')">5</button>
                    <button class="calc-btn" onclick="calcAppend('6')">6</button>
                    <button class="calc-btn op" onclick="calcAppend('+')">+</button>
                    
                    <button class="calc-btn" onclick="calcAppend('1')">1</button>
                    <button class="calc-btn" onclick="calcAppend('2')">2</button>
                    <button class="calc-btn" onclick="calcAppend('3')">3</button>
                    <button class="calc-btn eq" onclick="calcResult()">=</button>
                    
                    <button class="calc-btn" style="grid-column: span 2;" onclick="calcAppend('0')">0</button>
                    <button class="calc-btn" onclick="calcAppend('.')">.</button>
                </div>
            </div>
        </section>

        <section id="tool_ui_fee" class="card" style="display:none;">
            <h2 style="border:none;">é‡‘é¡è¨ˆç®—</h2>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <button id="mode_btn_count" class="switch-mode-btn active" onclick="switchFeeMode('count')">1. è¨ˆæ¬¡æ¨¡å¼</button>
                <button id="mode_btn_time" class="switch-mode-btn" onclick="switchFeeMode('time')">2. è¨ˆæ™‚æ¨¡å¼</button>
            </div>

            <div class="fee-form">
                <div id="fee_input_group_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ“… æ—¥æœŸå€é–“ (è¨ˆæ¬¡)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ—¥æœŸ <input type="date" id="fee_date_start"></label>
                             <label class="small">çµæŸæ—¥æœŸ <input type="date" id="fee_date_end"></label>
                        </div>
                        <div class="small" style="margin-top:6px; color:#666;">ç³»çµ±å°‡è‡ªå‹•åˆ¤æ–·å€é–“å…§çš„åœ‹å®šå‡æ—¥(ä¾æ“š2025-2026æ³•è¦)èˆ‡é€±æœ«ã€‚</div>
                    </div>
                </div>

                <div id="fee_input_group_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">â° ç²¾æº–å€é–“ (è¨ˆæ™‚)</span>
                        <div class="grid">
                             <label class="small">é–‹å§‹æ™‚é–“ <input type="datetime-local" id="fee_datetime_start"></label>
                             <label class="small">çµæŸæ™‚é–“ <input type="datetime-local" id="fee_datetime_end"></label>
                        </div>
                    </div>
                </div>

                <div id="fee_setting_count">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ¬¡)</span>
                        <div class="grid">
                            <label class="small">å¹³æ—¥è²»ç”¨ <input type="number" id="fee_count_normal" value="30"></label>
                            <label class="small">å‡æ—¥è²»ç”¨ <input type="number" id="fee_count_holiday" value="50"></label>
                        </div>
                    </div>
                </div>

                <div id="fee_setting_time" style="display:none;">
                    <div class="fee-group">
                        <span class="fee-label">ğŸ’° è²»ç‡è¨­å®š (è¨ˆæ™‚)</span>
                        <div class="grid">
                            <label class="small">æ™‚é–“å–®ä½(åˆ†é˜) <input type="number" id="fee_time_unit" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å¹³æ—¥) <input type="number" id="fee_time_rate_normal" value="30"></label>
                            <label class="small">å–®ä½è²»ç”¨(å‡æ—¥) <input type="number" id="fee_time_rate_holiday" value="50"></label>
                        </div>
                    </div>
                </div>

                <div class="fee-group">
                    <span class="fee-label">âš™ï¸ é€²éšè¦å‰‡</span>
                    <label style="cursor:pointer; display:block; margin-bottom:4px;">
                        <input type="radio" name="holiday_rule" value="weekend" checked style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå‡æ—¥ã€
                    </label>
                    <label style="cursor:pointer; display:block; margin-bottom:8px;">
                        <input type="radio" name="holiday_rule" value="weekday" style="width:auto;"> åœ‹å®šå‡æ—¥è¦–åŒã€Œå¹³æ—¥ã€
                    </label>
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px; color:#d32f2f;">
                            <input type="checkbox" id="fee_manual_holiday" style="width:auto;"> 
                            (æ‰‹å‹•) å¼·åˆ¶è¦–ç‚ºå‡æ—¥
                        </label>
                    </div>
                    
                    <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" id="fee_has_cap" style="width:auto;" onchange="toggleCapInput()"> å•Ÿç”¨é‡‘é¡ä¸Šé™
                        </label>
                        <input type="number" id="fee_cap_amount" placeholder="è¼¸å…¥ä¸Šé™é‡‘é¡" disabled style="display:none;">
                    </div>
                </div>

                <button class="action-btn" onclick="calculateFee()">é–‹å§‹è¨ˆç®—</button>

                <div class="fee-result-box" id="fee_result_area" style="display:none;">
                    <div class="small">è¨ˆç®—çµæœ</div>
                    <div id="fee_final_amount" class="fee-total">$0</div>
                    <div id="fee_detail_msg" class="small" style="color:#666; white-space: pre-line;"></div>
                </div>
            </div>
        </section>
    </div>

    <div id="dashboard_view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div>
            <h1 id="page_title" style="margin:0; font-size:1.4rem;">ä¸»æ§å°</h1>
            <div class="small" id="header_date_line"></div>
        </div>
        </div>

        <section class="card" id="events_card" style="border-left: 4px solid #2196f3;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; border:none; padding:0;">ğŸ“† è¿‘æœŸé‡è¦è¡Œäº‹æ›†</h2>
            <div id="mgr_event_btns" style="display:none; gap:6px;">
                <button id="btn_history" class="btn-history">ğŸ“… æŸ¥è©¢</button>
                <button id="btn_toggle_event_add" class="btn-history" style="background:#2196f3;">+ æ–°å¢</button>
            </div>
        </div>

        <div id="event_add_box" style="display:none; margin-top:10px; padding:10px; background:#f9f9f9; border-radius:6px; border:1px solid #eee;">
            <input type="hidden" id="evt_id_edit" value="">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                <div style="display:flex; gap:6px;">
                    <label class="small" style="display:block">é–‹å§‹ <input type="date" id="evt_date_start"></label>
                    <label class="small" style="display:block">çµæŸ <input type="date" id="evt_date_end"></label>
                </div>
                <div style="flex:1; min-width:100px;">
                    <label class="small">é¡å‹
                        <select id="evt_type">
                            <option value="æ–½å·¥">æ–½å·¥</option>
                            <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                            <option value="é‡å¤§äº‹ä»¶">é‡å¤§äº‹ä»¶</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </label>
                </div>
                <div style="flex:2; min-width:180px;">
                    <label class="small">å…§å®¹ <input type="text" id="evt_content" placeholder="ä¾‹å¦‚ï¼šäºŒå» å€é›»åŠ›æ­²ä¿®"></label>
                </div>
                <div style="display:flex; gap:4px;">
                    <button id="btn_save_event" class="action-btn" style="width:auto; padding:8px 12px;">å„²å­˜</button>
                    <button id="btn_del_event_form" class="action-btn" style="width:auto; padding:8px 10px; background:#d32f2f; display:none;">åˆªé™¤</button>
                    <button id="btn_cancel_event" class="action-btn" style="width:auto; padding:8px 10px; background:#ccc; color:#333;">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="evt_msg" class="small" style="color:#d10000; margin-top:4px;"></div>
        </div>

        <div id="events_list" style="margin-top:10px; display:grid; gap:6px;">
            <div class="small">è¼‰å…¥ä¸­...</div>
        </div>
        </section>

        <dialog id="history_modal">
            <div class="modal-header">
                <h3 style="margin:0">æ­·å²è¡Œäº‹æ›†</h3>
                <button class="modal-close" id="btn_close_history">âœ•</button>
            </div>
            <div class="cal-controls">
                <button class="action-btn" style="width:36px;" id="cal_prev">&lt;</button>
                <span class="cal-title" id="cal_title" style="font-size:1.1rem; font-weight:bold; padding-top:6px;"></span>
                <button class="action-btn" style="width:36px;" id="cal_next">&gt;</button>
            </div>
            <div class="cal-grid" id="cal_grid"></div>
        </dialog>

        <div style="display:flex; gap:12px; align-items:flex-start; margin-top:15px; flex-wrap:wrap;">
        <section class="card" id="today_card" style="flex:1; min-width:240px;">
            <h2 style="margin:0; border:none; padding:0;">ä»Šå¤©ç­è¡¨</h2>
            <div class="small" id="today_date_line" style="margin-top:4px"></div>
            <div id="today_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="today_msg" class="small" style="margin-top:8px"></div>
        </section>

        <section class="card" id="mytasks_card" style="flex:2; min-width:280px;">
            <h2 style="margin:0; border:none; padding:0;">æˆ‘çš„ä»»å‹™ï¼ˆæœ€è¿‘ 5 ç­†ï¼‰</h2>
            <div id="mytasks_box" style="margin-top:8px; display:grid; gap:6px"></div>
            <div id="mytasks_msg" class="small" style="margin-top:8px"></div>
        </section>
        </div>

        <section class="card" style="margin-top:15px;">
        <h2 style="margin:0; border:none; padding:0;">æ–°å¢ä»»å‹™</h2>
        <div class="grid" style="margin-top:8px">
            <div><label class="small">æ¨™é¡Œ<input id="task_title" placeholder="ä¾‹å¦‚ï¼šå·¡æª¢æ¸…å–®æ›´æ–°" /></label></div>
            <div>
            <label class="small">ç‹€æ…‹
                <select id="task_status">
                <option value="open" selected>open</option>
                <option value="doing">doing</option>
                <option value="done">done</option>
                </select>
            </label>
            </div>
            <div><label class="small">æŒ‡æ´¾çµ¦ï¼ˆåŒå ´åŸŸï¼Œå¯è¤‡é¸ï¼‰<select id="task_assignees" multiple size="4" style="height:80px;"></select></label></div>
            <div style="display:flex; align-items:center; padding-top:20px">
            <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:0.9rem;">
                <input type="checkbox" id="task_assign_all" style="width:auto; margin:0"> æŒ‡æ´¾çµ¦å…¨é«”
            </label>
            </div>
        </div>
        <label class="small" style="display:block; margin-top:8px;">å…§å®¹<textarea id="task_body" placeholder="å¯ç©º" style="min-height:60px;"></textarea></label>
        <button id="btn_create" class="action-btn" style="width:auto; padding:6px 16px; margin-top:8px;">å»ºç«‹ä»»å‹™</button>
        <div id="create_msg" class="msg"></div>
        </section>

        <section class="card">
        <h2 style="margin:0; border:none; padding:0;">ä»»å‹™åˆ—è¡¨</h2>
        <div id="tasks_box" style="display:grid; gap:8px; margin-top:10px"></div>
        <div id="tasks_msg" class="small" style="margin-top:8px"></div>
        </section>
    </div>
  </main>

  <script>
// å´é‚Šæ¬„æŠ˜ç–Šé‚è¼¯ (ä¿®æ”¹å¾Œï¼šæ‰‹é¢¨ç´æ¨¡å¼ - ä¸€æ¬¡åªé–‹ä¸€å€‹)
    function toggleNav(element) {
      // 1. è¨˜éŒ„ç›®å‰é»æ“Šçš„é€™å€‹é …ç›®åŸæœ¬æ˜¯ä¸æ˜¯é–‹è‘—çš„
      const wasActive = element.classList.contains('active');

      // 2. å¼·åˆ¶é—œé–‰ã€Œæ‰€æœ‰ã€çš„é¸å–® (ç§»é™¤ active æ¨£å¼)
      document.querySelectorAll('.nav-category').forEach(cat => {
        cat.classList.remove('active');
      });

      // 3. åˆ¤æ–·é‚è¼¯ï¼š
      // å¦‚æœåŸæœ¬æ˜¯é—œè‘—çš„ (wasActive ç‚º false)ï¼Œä»£è¡¨ä½¿ç”¨è€…æƒ³æ‰“é–‹å®ƒ -> åŠ ä¸Š active
      // å¦‚æœåŸæœ¬æ˜¯é–‹è‘—çš„ (wasActive ç‚º true)ï¼Œä»£è¡¨ä½¿ç”¨è€…æƒ³æ”¶èµ·å®ƒ -> ä¸Šé¢ç¬¬2æ­¥å·²ç¶“é—œäº†ï¼Œé€™è£¡ä¸åšäº‹
      if (!wasActive) {
        element.classList.add('active');
      }
    }

    // ===== é é¢åˆ‡æ›é‚è¼¯ (SPA æ¨¡æ“¬) =====
    let currentIframeUrl = "";

    // é¡¯ç¤ºä¸»æ§å°
    window.showDashboard = function() {
        document.getElementById('dashboard_view').style.display = 'block';
        document.getElementById('tools_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        
        // æ›´æ–°å´é‚Šæ¬„æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        document.getElementById('btn_home').classList.add('current');
        
        currentIframeUrl = ""; 
    }

    // é¡¯ç¤ºå°å·¥å…·
    window.showTool = function(toolType, btnElement) {
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('main_frame').style.display = 'none';
        document.getElementById('tools_view').style.display = 'block';

        // åˆ‡æ›å·¥å…·å…§å®¹
        document.getElementById('tool_ui_calc').style.display = (toolType === 'calc') ? 'block' : 'none';
        document.getElementById('tool_ui_fee').style.display = (toolType === 'fee') ? 'block' : 'none';

        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(btnElement) btnElement.classList.add('current');
    }

    // è¼‰å…¥å¤–éƒ¨é é¢åˆ° Iframe
    window.loadPage = function(pageUrl) {
        const siteId = document.getElementById('site_sel').value;
        if(!siteId) {
            alert("è«‹å…ˆé¸æ“‡å ´åŸŸ");
            return;
        }

        const fullUrl = `${pageUrl}?site_id=${encodeURIComponent(siteId)}`;
        const frame = document.getElementById('main_frame');
        
        document.getElementById('dashboard_view').style.display = 'none';
        document.getElementById('tools_view').style.display = 'none';
        frame.style.display = 'block';
        frame.src = fullUrl;
        
        currentIframeUrl = pageUrl;

        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        if(event && event.currentTarget) {
            event.currentTarget.classList.add('current');
        }
    }

    // ===== è¨ˆç®—æ©Ÿé‚è¼¯ =====
    let calcVal = "0";
    function updateCalc(){ document.getElementById('calc_display').value = calcVal; }
    window.calcAppend = function(v) {
        if(calcVal === "0" && v !== ".") calcVal = "";
        calcVal += v;
        updateCalc();
    }
    window.calcDel = function() {
        calcVal = calcVal.slice(0, -1);
        if(calcVal === "") calcVal = "0";
        updateCalc();
    }
    window.calcClear = function() {
        calcVal = "0";
        updateCalc();
    }
    window.calcResult = function() {
        try {
            // å®‰å…¨æ€§éæ¿¾
            if(/[^0-9+\-*/.]/.test(calcVal)) throw new Error("Invalid");
            calcVal = String(eval(calcVal)); 
        } catch(e) {
            calcVal = "Error";
        }
        updateCalc();
    }

    // ===== é‡‘é¡è©¦ç®—é‚è¼¯ =====
    let currentFeeMode = 'count'; // count or time

    window.switchFeeMode = function(mode) {
        currentFeeMode = mode;
        const btnCount = document.getElementById('mode_btn_count');
        const btnTime = document.getElementById('mode_btn_time');
        
        // è¼¸å…¥å€å¡Š
        const inputCount = document.getElementById('fee_input_group_count');
        const inputTime = document.getElementById('fee_input_group_time');
        
        // è¨­å®šå€å¡Š
        const settingCount = document.getElementById('fee_setting_count');
        const settingTime = document.getElementById('fee_setting_time');

        // ä¸Šé™
        const capInput = document.getElementById('fee_cap_amount');
        const capCheck = document.getElementById('fee_has_cap');

        if(mode === 'count') {
            btnCount.classList.add('active'); btnTime.classList.remove('active');
            inputCount.style.display = 'block'; inputTime.style.display = 'none';
            settingCount.style.display = 'block'; settingTime.style.display = 'none';
            // é è¨­ç„¡ä¸Šé™
            capCheck.checked = false;
            capInput.value = "";
        } else {
            btnTime.classList.add('active'); btnCount.classList.remove('active');
            inputCount.style.display = 'none'; inputTime.style.display = 'block';
            settingCount.style.display = 'none'; settingTime.style.display = 'block';
            // é è¨­ä¸Šé™ 300
            capCheck.checked = true;
            capInput.value = 300;
        }
        toggleCapInput();
        document.getElementById('fee_result_area').style.display = 'none';
    }

    window.toggleCapInput = function() {
        const check = document.getElementById('fee_has_cap');
        const input = document.getElementById('fee_cap_amount');
        if(check.checked) {
            input.disabled = false;
            input.style.display = 'block';
        } else {
            input.disabled = true;
            input.style.display = 'none';
        }
    }

    // === åœ‹å®šå‡æ—¥è³‡æ–™åº« (2025-2026) ===
    // æ ¼å¼ï¼šYYYY-MM-DD
    const holidaySet = new Set([
        // å›ºå®šç¯€æ—¥ 2025
        "2025-01-01", "2025-02-28", "2025-04-04", "2025-05-01", "2025-10-10",
        // 2025 è¾²æ›†æ˜¥ç¯€ (é™¤å¤• 1/27 ~ åˆä¸‰ 1/30)
        "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30",
        // 2025 æ¸…æ˜ (4/4 å·²ç¶“åœ¨å›ºå®šç¯€æ—¥)
        // 2025 ç«¯åˆ (5/31)
        "2025-05-31",
        // 2025 ä¸­ç§‹ (10/6)
        "2025-10-06",

        // å›ºå®šç¯€æ—¥ 2026
        "2026-01-01", "2026-02-28", "2026-04-04", "2026-05-01", "2026-10-10",
        // 2026 è¾²æ›†æ˜¥ç¯€ (é™¤å¤• 2/16 ~ åˆä¸‰ 2/19)
        "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19",
        // 2026 æ¸…æ˜ (4/5)
        "2026-04-05",
        // 2026 ç«¯åˆ (6/19)
        "2026-06-19",
        // 2026 ä¸­ç§‹ (9/25)
        "2026-09-25"
    ]);

    function isNationalHoliday(dateStr) {
        return holidaySet.has(dateStr);
    }

    window.calculateFee = function() {
        let total = 0;
        let details = "";
        
        // è¦å‰‡è®€å–
        const rule = document.querySelector('input[name="holiday_rule"]:checked').value;
        const treatNationalHolidayAsHoliday = (rule === 'weekend');
        const manualForceHoliday = document.getElementById('fee_manual_holiday').checked;

        if (currentFeeMode === 'count') {
            const sStr = document.getElementById('fee_date_start').value;
            const eStr = document.getElementById('fee_date_end').value;
            
            if(!sStr || !eStr) { alert("è«‹è¼¸å…¥é–‹å§‹èˆ‡çµæŸæ—¥æœŸ"); return; }
            if(sStr > eStr) { alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ"); return; }

            const dStart = new Date(sStr);
            const dEnd = new Date(eStr);
            
            let normalDays = 0;
            let holidayDays = 0;

            // éæ­·æ—¥æœŸå€é–“
            for (let d = new Date(dStart); d <= dEnd; d.setDate(d.getDate() + 1)) {
                // æ ¼å¼åŒ– YYYY-MM-DD
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const isoDate = `${y}-${m}-${dd}`;

                const day = d.getDay(); // 0=Sun, 6=Sat
                const isWeekend = (day === 0 || day === 6);
                const isNatHol = isNationalHoliday(isoDate);

                let isHolidayRate = false;

                if (manualForceHoliday) {
                    isHolidayRate = true;
                } else if (isWeekend) {
                    isHolidayRate = true; 
                } else if (isNatHol && treatNationalHolidayAsHoliday) {
                    isHolidayRate = true;
                }

                if (isHolidayRate) holidayDays++; else normalDays++;
            }

            const priceNormal = parseFloat(document.getElementById('fee_count_normal').value) || 0;
            const priceHoliday = parseFloat(document.getElementById('fee_count_holiday').value) || 0;
            
            total = (normalDays * priceNormal) + (holidayDays * priceHoliday);
            details = `å€é–“ï¼š${sStr} ~ ${eStr}\nå¹³æ—¥ï¼š${normalDays} å¤© Ã— $${priceNormal}\nå‡æ—¥(å«é€±æœ«/åœ‹å®š)ï¼š${holidayDays} å¤© Ã— $${priceHoliday}`;

        } else {
            // Time Mode
            const sVal = document.getElementById('fee_datetime_start').value;
            const eVal = document.getElementById('fee_datetime_end').value;

            if(!sVal || !eVal) { alert("è«‹è¼¸å…¥å®Œæ•´çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“"); return; }
            
            const tStart = new Date(sVal);
            const tEnd = new Date(eVal);

            if(tStart >= tEnd) { alert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“"); return; }

            const diffMs = tEnd - tStart;
            const diffMins = Math.floor(diffMs / 1000 / 60);
            
            const unit = parseFloat(document.getElementById('fee_time_unit').value) || 30;
            const rateNormal = parseFloat(document.getElementById('fee_time_rate_normal').value) || 0;
            const rateHoliday = parseFloat(document.getElementById('fee_time_rate_holiday').value) || 0;

            const units = Math.ceil(diffMins / unit);

            // åˆ¤æ–·è²»ç‡ï¼šä½¿ç”¨ã€Œé–‹å§‹æ™‚é–“ã€
            const startDay = tStart.getDay();
            const y = tStart.getFullYear();
            const m = String(tStart.getMonth() + 1).padStart(2, '0');
            const dd = String(tStart.getDate()).padStart(2, '0');
            const isoStart = `${y}-${m}-${dd}`;

            const isWeekend = (startDay === 0 || startDay === 6);
            const isNatHol = isNationalHoliday(isoStart);
            
            let isHolidayRate = false;
            
            if (manualForceHoliday) {
                isHolidayRate = true;
            } else if (isWeekend) {
                isHolidayRate = true;
            } else if (isNatHol && treatNationalHolidayAsHoliday) {
                isHolidayRate = true;
            }
            
            const rate = isHolidayRate ? rateHoliday : rateNormal;
            
            total = units * rate;
            
            const holName = isNatHol ? "(åœ‹å®šå‡æ—¥)" : "";
            details = `å€é–“ï¼š${sVal.replace('T', ' ')} ~ ${eVal.replace('T', ' ')}\nç¸½æ™‚é•·ï¼š${diffMins} åˆ†é˜\nå–®ä½æ•¸ï¼š${units} (æ¯${unit}åˆ†)\nè²»ç‡é¡å‹ï¼š${isHolidayRate?`å‡æ—¥${holName}`:"å¹³æ—¥"} ($${rate}/å–®ä½)`;
        }

        // ä¸Šé™æª¢æŸ¥
        const hasCap = document.getElementById('fee_has_cap').checked;
        if(hasCap) {
            const cap = parseFloat(document.getElementById('fee_cap_amount').value) || 0;
            if (total > cap) {
                details += `\n(å·²è§¸ç™¼ä¸Šé™ $${cap}ï¼ŒåŸè¨ˆç®—é‡‘é¡ $${total})`;
                total = cap;
            }
        }

        document.getElementById('fee_final_amount').textContent = `$${total}`;
        document.getElementById('fee_detail_msg').textContent = details;
        document.getElementById('fee_result_area').style.display = 'block';
    }
  </script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import * as XLSX from "https://esm.sh/xlsx@0.18.5";

    // ====== è«‹å¡«å…¥æ‚¨çš„ Supabase è¨­å®š ======
    const SUPABASE_URL = "https://whbllncddoqbwukstxel.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2";
    // ===================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);

    function dbg(msg){ const el = document.getElementById("dbg"); if(el) el.textContent = msg || ""; }
    function setText(el, t){ if(el) el.textContent = t || ""; }
    function setMsg(el, t){ if(el) el.textContent = t || ""; }
    function escapeHtml(s){ return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    
    function toISODateLocal(d){
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tz).toISOString().slice(0,10);
    }
    // è¨­å®š Header æ—¥æœŸ
    $("header_date_line").textContent = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    // ====== è¡Œäº‹æ›†é‚è¼¯ (ä¿ç•™åŸåŠŸèƒ½) ======
    function getTagClass(type){
        if(type === 'æ–½å·¥') return 'tag-construction';
        if(type === 'ç¶­ä¿®') return 'tag-maintenance';
        if(type === 'é‡å¤§äº‹ä»¶') return 'tag-major';
        return 'tag-other';
    }
    function getCalEventClass(type){
        if(type === 'æ–½å·¥') return 'ce-construction';
        if(type === 'ç¶­ä¿®') return 'ce-maintenance';
        if(type === 'é‡å¤§äº‹ä»¶') return 'ce-major';
        return 'ce-other';
    }

    function diffDays(d1, d2) {
        const t1 = new Date(d1).setHours(0,0,0,0);
        const t2 = new Date(d2).setHours(0,0,0,0);
        return Math.round((t1 - t2) / (1000 * 60 * 60 * 24));
    }

    // [ç·¨è¼¯] å•Ÿå‹•ç·¨è¼¯æ¨¡å¼
    window.startEditEvent = function(id, dateStart, dateEnd, type, content) {
        $("history_modal").close(); 
        $("evt_id_edit").value = id;
        $("evt_date_start").value = dateStart;
        $("evt_date_end").value = dateEnd;
        $("evt_type").value = type;
        $("evt_content").value = content;
        
        $("event_add_box").style.display = "block";
        $("btn_save_event").textContent = "æ›´æ–°";
        
        const delBtn = $("btn_del_event_form");
        delBtn.style.display = "block";
        delBtn.onclick = () => window.deleteEvent(id, null, null);

        $("evt_msg").textContent = "ç·¨è¼¯ä¸­...";
        $("events_card").scrollIntoView({ behavior: 'smooth' });
    };

    window.deleteEvent = async function(id, siteId, meUid) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œäº‹æ›†å—ï¼Ÿ")) return;
        const { error } = await supabase.from("site_events").delete().eq("id", id);
        if(error) {
            alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
        } else {
            location.reload(); 
        }
    };

    async function refreshSiteEvents(siteId, isManager){
        const listEl = $("events_list");
        if(!listEl) return;
        listEl.innerHTML = '<div class="small">è¼‰å…¥ä¸­...</div>';
        const todayStr = toISODateLocal(new Date());

        const { data, error } = await supabase
            .from("site_events")
            .select("*")
            .eq("site_id", siteId)
            .gte("event_end_date", todayStr) 
            .order("event_date", { ascending: true }) 
            .limit(5);

        if(error){
            listEl.innerHTML = `<div class="small" style="color:red">ç„¡æ³•è®€å–è¡Œäº‹æ›†ï¼š${error.message}</div>`;
            return;
        }

        if(!data || data.length === 0){
            listEl.innerHTML = `<div class="small" style="color:#888;">è¿‘æœŸç„¡é‡å¤§äº‹ä»¶</div>`;
            return;
        }

        listEl.innerHTML = "";
        const todayObj = new Date(todayStr);

        data.forEach(evt => {
            const startObj = new Date(evt.event_date);
            const endObj = new Date(evt.event_end_date);
            const startDiff = diffDays(startObj, todayObj);
            const endDiff = diffDays(endObj, todayObj);

            let daysText = "";
            let daysClass = "days-left";
            let rowStyle = "";

            if (startDiff > 0) {
                if(startDiff === 1) { daysText = "æ˜å¤©é–‹å§‹"; daysClass += " days-urgent"; } 
                else { daysText = `é‚„æœ‰ ${startDiff} å¤©`; }
            } else {
                if (endDiff >= 0) {
                    daysText = "ğŸ”¥ é€²è¡Œä¸­"; daysClass = "days-urgent";
                    rowStyle = "background-color: #fff8f8;"; 
                } else {
                    daysText = "å·²çµæŸ";
                    daysClass = "days-ended";
                    rowStyle = "background-color: #f9f9f9; opacity: 0.8;";
                }
            }

            let dateDisplay = evt.event_date;
            if (evt.event_date !== evt.event_end_date) {
                dateDisplay = `${evt.event_date} ~ ${evt.event_end_date}`;
            }

            let actions = "";
            if(isManager) {
                const safeContent = escapeHtml(evt.content).replace(/'/g, "&apos;");
                actions = `
                    <div class="btn-group-right">
                        <button class="btn-icon btn-edit" title="ç·¨è¼¯" onclick="startEditEvent('${evt.id}', '${evt.event_date}', '${evt.event_end_date}', '${evt.category}', '${safeContent}')">
                           âœï¸
                        </button>
                    </div>
                `;
            }

            const div = document.createElement("div");
            div.style.cssText = `padding:6px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; ${rowStyle}`;
            div.innerHTML = `
                <div style="flex:1;">
                    <span class="tag-event ${getTagClass(evt.category)}">${escapeHtml(evt.category)}</span>
                    <span style="font-weight:600; font-size:14px; margin-right:6px;">${escapeHtml(evt.content)}</span>
                    <span class="small" style="color:#666">(${dateDisplay})</span>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="${daysClass}" style="white-space:nowrap;">${daysText}</div>
                    ${actions}
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    // ====== æœˆæ›†åŠŸèƒ½ (ä¿ç•™åŸåŠŸèƒ½) ======
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth(); 
    let cachedEvents = []; 

    async function loadCalendarEvents(siteId){
        const { data, error } = await supabase
            .from("site_events")
            .select("*")
            .eq("site_id", siteId);
        
        if(!error && data) {
            cachedEvents = data;
        }
        renderCalendar();
    }

    function renderCalendar() {
        const grid = $("cal_grid");
        const title = $("cal_title");
        
        title.textContent = `${calYear} å¹´ ${String(calMonth + 1).padStart(2, '0')} æœˆ`;
        grid.innerHTML = "";
        
        const weeks = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
        weeks.forEach(w => {
            const div = document.createElement("div");
            div.className = "cal-head";
            div.textContent = w;
            grid.appendChild(div);
        });

        const firstDay = new Date(calYear, calMonth, 1).getDay(); 
        const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
        const today = new Date();
        const isCurrentMonth = (today.getFullYear() === calYear && today.getMonth() === calMonth);
        const todayDate = today.getDate();

        for(let i=0; i<firstDay; i++){
            const div = document.createElement("div");
            div.className = "cal-day other-month";
            grid.appendChild(div);
        }

        for(let d=1; d<=daysInMonth; d++){
            const div = document.createElement("div");
            div.className = "cal-day";
            if(isCurrentMonth && d === todayDate) div.classList.add("cal-today");
            
            div.innerHTML = `<span class="cal-date-num">${d}</span>`;
            
            const curDateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const daysEvents = cachedEvents.filter(evt => {
                return evt.event_date <= curDateStr && evt.event_end_date >= curDateStr;
            });
            
            daysEvents.forEach(evt => {
                const bar = document.createElement("div");
                bar.className = `cal-event-bar ${getCalEventClass(evt.category)}`;
                bar.textContent = evt.content;
                bar.title = `${evt.content} (${evt.category})\n${evt.event_date} ~ ${evt.event_end_date}`;
                
                const safeContent = escapeHtml(evt.content).replace(/'/g, "&apos;");
                bar.onclick = (e) => {
                    e.stopPropagation();
                    startEditEvent(evt.id, evt.event_date, evt.event_end_date, evt.category, safeContent);
                };
                div.appendChild(bar);
            });
            grid.appendChild(div);
        }
    }

    // ====== äº‹ä»¶å„²å­˜ ======
    async function saveSiteEvent(siteId, meUid){
        const idVal = $("evt_id_edit").value; 
        const sVal = $("evt_date_start").value;
        const eVal = $("evt_date_end").value;
        const typeVal = $("evt_type").value;
        const contentVal = $("evt_content").value.trim();
        const msgEl = $("evt_msg");

        if(!sVal || !eVal || !contentVal){
            setMsg(msgEl, "è«‹å¡«å¯«å®Œæ•´æ—¥æœŸèˆ‡å…§å®¹");
            return;
        }
        
        if(sVal > eVal){
            setMsg(msgEl, "çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ");
            return;
        }

        setMsg(msgEl, idVal ? "æ›´æ–°ä¸­..." : "æ–°å¢ä¸­...");
        
        let res;
        if (idVal) {
            res = await supabase.from("site_events").update({
                event_date: sVal,
                event_end_date: eVal,
                category: typeVal,
                content: contentVal
            }).eq("id", idVal);
        } else {
            res = await supabase.from("site_events").insert({
                site_id: siteId,
                event_date: sVal,
                event_end_date: eVal,
                category: typeVal,
                content: contentVal,
                created_by: meUid
            });
        }

        if(res.error){
            setMsg(msgEl, "å„²å­˜å¤±æ•—ï¼š" + res.error.message);
        } else {
            setMsg(msgEl, "");
            closeEventForm();
            location.reload(); 
        }
    }

    function closeEventForm() {
        $("evt_id_edit").value = "";
        $("evt_content").value = "";
        $("evt_msg").textContent = "";
        $("event_add_box").style.display = "none";
        $("btn_save_event").textContent = "å„²å­˜";
        $("btn_del_event_form").style.display = "none";
    }

    async function getSitePeople(siteId){
      const r = await supabase.rpc("get_site_people", { p_site_id: siteId });
      if (r.error) return { error: r.error, people: [] };
      const people = (r.data || []).map(x => ({ user_id: x.user_id, name: x.display_name || x.user_id }));
      return { error: null, people };
    }

    async function loadAssignees(siteId){
      const sel = $("task_assignees");
      const allBox = $("task_assign_all");
      if (!sel) return;
      sel.innerHTML = "";
      const r = await getSitePeople(siteId);
      if (r.error){
        const opt = document.createElement("option"); opt.value = ""; opt.textContent = "ç„¡æ³•è¼‰å…¥äººå“¡"; sel.appendChild(opt); return;
      }
      for (const it of r.people){
        const opt = document.createElement("option"); opt.value = it.user_id; opt.textContent = it.name; sel.appendChild(opt);
      }
      if (allBox){
        const sync = () => { const on = allBox.checked; sel.disabled = on; if (on) for (const o of sel.options) o.selected = false; };
        allBox.removeEventListener("change", allBox.__syncAssignAll || (()=>{}));
        allBox.__syncAssignAll = sync;
        allBox.addEventListener("change", sync);
        sync();
      }
    }

    async function requireSession(){
      const { data, error } = await supabase.auth.getSession();
      if (error || !data.session){ location.href = "./index.html"; return null; }
      return data.session;
    }

    async function loadMe(){
      const sess = await requireSession();
      if (!sess) return null;
      const uid = sess.user.id;
      
      const p = await supabase.from("profiles").select("username,display_name").eq("user_id", uid).single();
      const m = await supabase.from("site_memberships").select("site_id,role,is_active,user_id").eq("user_id", uid).eq("is_active", true);
      
      if (p.error || m.error) {
        setText($("me_name"), "è®€å–å¤±æ•—");
        return null;
      }
      
      const username = p.data.username;
      const name = p.data.display_name || "";
      const memberships = m.data || [];
      
      // æ›´æ–°å´é‚Šæ¬„å€‹äººè³‡è¨Š
      setText($("me_name"), name || username);
      
      return { uid, username, memberships };
    }

    async function loadSites(siteIds){
      const s = await supabase.from("sites").select("id,code,name");
      if (s.error) return { map:{}, list:[] };
      const map = {}; for (const it of s.data) map[it.id] = it;
      const list = siteIds.map(id => map[id]).filter(Boolean);
      return { map, list };
    }

    async function refreshTasks(siteId, meUid){
      const box = $("tasks_box"); box.innerHTML = ""; setText($("tasks_msg"), "è®€å–ä¸­â€¦");
      const t = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at", { ascending: false });
      if (t.error){ setText($("tasks_msg"), "è®€å–å¤±æ•—"); return; }
      
      const rows = t.data || [];
      if (rows.length === 0){ setText($("tasks_msg"), "ç›®å‰æ²’æœ‰ä»»å‹™"); return; }
      
      setText($("tasks_msg"), `å…± ${rows.length} ç­†`);
      const peopleRes = await getSitePeople(siteId);
      const nameMap = {}; for (const it of (peopleRes.people || [])) nameMap[it.user_id] = it.name;

      const taskIds = rows.map(r => r.id);
      const assRes = await supabase.from("task_assignees").select("task_id,user_id").in("task_id", taskIds);
      const assMap = {};
      if (!assRes.error) for(const it of (assRes.data||[])) { if(!assMap[it.task_id])assMap[it.task_id]=[]; assMap[it.task_id].push(it.user_id); }

      const cRes = await supabase.from("task_completions").select("task_id,user_id,completed_at").in("task_id", taskIds).order("completed_at", { ascending: false });
      const compMap = {};
      if (!cRes.error) for(const it of (cRes.data||[])) { if(!compMap[it.task_id])compMap[it.task_id]=[]; compMap[it.task_id].push(it); }

      for (const r of rows){
        const explicit = assMap[r.id] || [];
        const isAll = !!r.assign_all;
        const assigneeNames = isAll ? "åŒå ´åŸŸå…¨é«”" : (explicit.length ? explicit.map(uid => nameMap[uid] || uid).join("ã€") : "æœªæŒ‡æ´¾");
        const canComplete = !!meUid && (isAll || explicit.includes(meUid));
        const myCompleted = !!meUid && (compMap[r.id] || []).some(x => x.user_id === meUid);
        const doneLine = (compMap[r.id] && compMap[r.id].length)
          ? "å·²å®Œæˆï¼š" + compMap[r.id].slice(0, 5).map(x => (nameMap[x.user_id] || x.user_id) + "ï¼ˆ" + new Date(x.completed_at).toLocaleString() + "ï¼‰").join("\n")
          : "";

        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <strong>${escapeHtml(r.title)}</strong>
            <span class="small">${new Date(r.created_at).toLocaleString()}</span>
          </div>
          ${r.body ? `<div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(r.body)}</div>` : ""}
          <div class="small" style="margin-top:8px">æŒ‡æ´¾ï¼š${escapeHtml(assigneeNames)}</div>
          <div class="small" style="margin-top:6px">statusï¼š${escapeHtml(r.status)}</div>
          ${doneLine ? `<div class="doneby">${escapeHtml(doneLine)}</div>` : ``}
          ${(canComplete && !myCompleted && r.status !== "done") ? `<button class="action-btn" data-done="${r.id}" style="margin-top:10px; width:auto; padding:4px 10px;">å·²å®Œæˆ</button>` : ``}
        `;
        box.appendChild(div);

        const doneBtn = div.querySelector('button[data-done]');
        if (doneBtn){
          doneBtn.addEventListener("click", async () => {
            const id = doneBtn.getAttribute("data-done");
            await supabase.from("task_completions").insert({ task_id: id, user_id: meUid });
            await supabase.from("tasks").update({ status: "done" }).eq("id", id);
            await refreshTasks(siteId, meUid);
            await refreshMyTasksPanel(siteId, meUid);
          });
        }
      }
    }

    async function refreshMyTasksPanel(siteId, meUid){
      const box = $("mytasks_box");
      const msg = $("mytasks_msg");
      if (!box || !msg) return;
      box.innerHTML = ""; msg.textContent = "è®€å–ä¸­â€¦";
      const t = await supabase.from("tasks").select("*").eq("site_id", siteId).order("created_at", { ascending: false }).limit(50);
      if (t.error){ msg.textContent = "è®€å–å¤±æ•—"; return; }
      const rows = t.data || [];
      if (!rows.length){ msg.textContent = "ç›®å‰æ²’æœ‰ä»»å‹™"; return; }
      const taskIds = rows.map(r => r.id);
      const ass = await supabase.from("task_assignees").select("task_id").eq("user_id", meUid).in("task_id", taskIds);
      const assignedSet = new Set((ass.error ? [] : (ass.data || []).map(x => x.task_id)));
      const mine = rows.filter(r => r.created_by === meUid || !!r.assign_all || assignedSet.has(r.id)).slice(0, 5);
      if (!mine.length){ msg.textContent = "ä½ ç›®å‰æ²’æœ‰è¿‘æœŸä»»å‹™"; return; }
      msg.textContent = `é¡¯ç¤º ${mine.length} / ${rows.length}`;
      for (const r of mine){
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:baseline">
            <strong>${escapeHtml(r.title || "")}</strong>
            <span class="small">${new Date(r.created_at).toLocaleString()}</span>
          </div>
          <div class="small" style="margin-top:6px">statusï¼š${escapeHtml(r.status || "")}</div>
        `;
        box.appendChild(div);
      }
    }

    function roleLabel(role){ return (role === "engineer" ? "å·¥ç¨‹å¸«" : (role === "supervisor" ? "ä¸»ç®¡" : "å“¡å·¥")); }
    function isManagerRole(role){ return role === "engineer" || role === "supervisor"; }

    // ğŸ”´ å¯©æ ¸æŒ‰éˆ•èˆ‡å¤–å±¤ç´…é»é‚è¼¯
    async function refreshLeaveBadge(siteId, roleCur){
      const btnGroup = $("group_manager"); // ä¸»ç®¡ç®¡ç†åˆ†é¡
      const reviewBtn = $("btn_leave_review"); // å…§éƒ¨å¯©æ ¸æŒ‰éˆ•
      const badge = $("leave_badge"); // å…§éƒ¨ç´…é»
      const groupBadge = $("group_badge"); // å¤–å±¤åˆ†é¡æ¨™é¡Œç´…é»
      
      if (!btnGroup || !reviewBtn || !badge || !groupBadge) return;
      
      const isMgr = isManagerRole(roleCur);
      
      // æ¬Šé™æ§åˆ¶
      if(isMgr) {
          btnGroup.style.display = "block";
      } else {
          btnGroup.style.display = "none";
          return; 
      }

      // æŸ¥è©¢å¾…å¯©æ ¸
      const q = await supabase.from("leave_requests")
          .select("id", { count: "exact", head: true })
          .eq("site_id", siteId)
          .eq("status", "pending");
          
      const count = q.count || 0;

      // ç´…é»é¡¯ç¤ºé‚è¼¯
      if (!q.error && count > 0) {
          // å…§éƒ¨ç´…é»
          badge.style.display = "inline-block";
          reviewBtn.title = `æœ‰ ${count} ç­†å¾…å¯©æ ¸`;
          // å¤–å±¤ç´…é» (ä¸éœ€å±•é–‹å°±çœ‹å¾—åˆ°)
          groupBadge.style.display = "inline-block";
      } else {
          badge.style.display = "none";
          reviewBtn.title = "å¯©æ ¸è«‹å‡";
          groupBadge.style.display = "none";
      }
    }

    async function refreshTodaySchedule(siteId){
      const box = $("today_box");
      const msg = $("today_msg");
      const dateLine = $("today_date_line");
      if (!box || !msg || !dateLine) return;
      box.innerHTML = ""; msg.textContent = "è®€å–ä¸­â€¦";
      const today = toISODateLocal(new Date());
      dateLine.textContent = today;
      const q = await supabase.from("site_schedules").select("person_name,shift").eq("site_id", siteId).eq("work_date", today).order("person_name", { ascending: true });
      if (q.error){ msg.textContent = "è®€å–å¤±æ•—"; return; }
      const rows = q.data || [];
      if (!rows.length){ msg.textContent = "ä»Šå¤©æ²’æœ‰ç­è¡¨"; return; }
      msg.textContent = `å…± ${rows.length} äºº`;
      for (const r of rows){
        const div = document.createElement("div");
        div.className = "task";
        div.style.padding = "6px";
        const shiftText = String(r.shift || "").trim();
        let cls = "";
        if (["ä¼‘","ä¼‘å‡","å–ªå‡","äº‹å‡","ç—…å‡","ç”Ÿç†å‡"].includes(shiftText)) cls = "shift-red";
        if (["ç‰¹ä¼‘","è¡Œæ”¿"].includes(shiftText)) cls = "shift-orange";
        div.innerHTML = `<div style="display:flex;justify-content:space-between; font-size:0.9rem;"><strong>${escapeHtml(r.person_name)}</strong><span class="small ${cls}">${escapeHtml(shiftText)}</span></div>`;
        box.appendChild(div);
      }
    }

async function refreshMyScheduleLine(siteId, meUid){
      const el = $("my_shift_text");
      if (!el) return;
      
      // 1. å–å¾—ä½¿ç”¨è€…çš„é¡¯ç¤ºåç¨± (Person Name)
      const links = await supabase.from("site_person_links").select("person_name").eq("site_id", siteId).eq("user_id", meUid);
      if (links.error || !links.data.length) {
          el.innerHTML = `<span class="small" style="color:#999">å°šæœªé€£çµç­è¡¨å§“å</span>`;
          return;
      }
      const myName = String(links.data[0].person_name || "").trim();
      
      // 2. è¨­å®šæœå°‹ç¯„åœï¼šå¾ä»Šå¤©é–‹å§‹å¾€å¾Œæ‰¾ 30 å¤©
      const todayObj = new Date();
      const todayStr = toISODateLocal(todayObj);
      
      const nextMonthObj = new Date();
      nextMonthObj.setDate(todayObj.getDate() + 30);
      const nextMonthStr = toISODateLocal(nextMonthObj);
      
      const tomorrowObj = new Date();
      tomorrowObj.setDate(todayObj.getDate() + 1);
      const tomorrowStr = toISODateLocal(tomorrowObj);

      // 3. æŸ¥è©¢ç­è¡¨
      const q = await supabase
          .from("site_schedules")
          .select("work_date, shift")
          .eq("site_id", siteId)
          .eq("person_name", myName)
          .gte("work_date", todayStr)
          .lte("work_date", nextMonthStr)
          .order("work_date", { ascending: true });
          
      if (q.error) return;
      const rows = q.data || [];

      // 4. è§£æä»Šæ—¥èˆ‡æ˜æ—¥
      const todayShift = rows.find(r => r.work_date === todayStr)?.shift || "ç„¡";
      const tmrShift = rows.find(r => r.work_date === tomorrowStr)?.shift || "ç„¡";

      // 5. è¨ˆç®—è·é›¢ä¸‹å€‹ä¼‘å‡çš„å¤©æ•¸
      // å®šç¾©ä»€éº¼å­—çœ¼ç®—ä¼‘å‡ (åªè¦ç­åˆ¥åç¨±åŒ…å«é€™äº›å­—å°±ç®—)
      const leaveKeywords = ["ä¼‘", "å‡"]; 
      
      let leaveStatusHtml = "";
      
      // åˆ¤æ–·ä»Šå¤©æ˜¯ä¸æ˜¯ä¼‘å‡
      const isTodayLeave = leaveKeywords.some(k => todayShift.includes(k));

      if (isTodayLeave) {
          leaveStatusHtml = `<div class="leave-countdown-bar status-on-leave">ğŸ–ï¸ ä¼‘å‡ä¸­ Enjoy!</div>`;
      } else {
          // å°‹æ‰¾æœªä¾†çš„æœ€è¿‘ä¸€å€‹ä¼‘å‡
          let nextLeaveDate = null;
          // å¾é™£åˆ—ä¸­æ‰¾ï¼Œéæ¿¾æ‰ä»Šå¤©
          for(const r of rows) {
              if (r.work_date === todayStr) continue; // è·³éä»Šå¤©
              if (leaveKeywords.some(k => (r.shift||"").includes(k))) {
                  nextLeaveDate = r.work_date;
                  break;
              }
          }

          if (nextLeaveDate) {
              // è¨ˆç®—å¤©æ•¸å·®
              const d1 = new Date(todayStr);
              const d2 = new Date(nextLeaveDate);
              const diffTime = Math.abs(d2 - d1);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
              // diffDays = 1 ä»£è¡¨æ˜å¤©ä¼‘å‡
              
              const dayText = (diffDays === 1) ? "æ˜å¤©" : `${diffDays} å¤©å¾Œ`;
              leaveStatusHtml = `<div class="leave-countdown-bar status-working">ğŸ’ª ${dayText} æ”¾å‡</div>`;
          } else {
              leaveStatusHtml = `<div class="leave-countdown-bar" style="background:#eee;color:#666">ğŸ“… è¿‘æœŸç„¡ä¼‘å‡</div>`;
          }
      }

      // 6. æ¸²æŸ“ HTML
      el.innerHTML = `
        <div class="shift-card">
            <div class="shift-row">
                <span class="shift-label">ä»Šæ—¥</span>
                <span class="shift-val-today">${escapeHtml(todayShift)}</span>
            </div>
            <div class="shift-row" style="border-bottom:1px dashed #eee; padding-bottom:4px; margin-bottom:4px;">
                <span class="shift-label">æ˜æ—¥</span>
                <span class="shift-val-tmr">${escapeHtml(tmrShift)}</span>
            </div>
            ${leaveStatusHtml}
        </div>
      `;
    }

    async function main(){
      $("btn_logout").addEventListener("click", async () => { await supabase.auth.signOut(); location.href = "./index.html"; });
      const me = await loadMe();
      if (!me){ setText($("tasks_msg"), "ç™»å…¥å¤±æ•—"); return; }
      const siteIds = me.memberships.map(x => x.site_id);
      const { list: siteList } = await loadSites(siteIds);
      const sel = $("site_sel");
      sel.innerHTML = "";
      for (const s of siteList){ const opt = document.createElement("option"); opt.value = s.id; opt.textContent = `${s.name} (${s.code})`; sel.appendChild(opt); }
      const currentSiteId = siteList[0]?.id || "";
      if (!currentSiteId){ setText($("tasks_msg"), "ç„¡å¯ç”¨å ´åŸŸ"); return; }
      sel.value = currentSiteId;

      const refreshAll = async () => {
        const siteId = sel.value;
        const roleCur = (me.memberships.find(x => x.site_id === siteId)?.role) || "";
        const titleEl = $("page_title");
        
        // æ›´æ–°å·¦å´æ¬„è³‡è¨Š
        $("me_role").textContent = roleLabel(roleCur);
        if (titleEl) titleEl.textContent = `${siteList.find(s => s.id === siteId)?.name || ""} ä¸»æ§å°`;
        
        const isMgr = isManagerRole(roleCur);

        await refreshTodaySchedule(siteId);
        await refreshMyScheduleLine(siteId, me.uid);
        await refreshLeaveBadge(siteId, roleCur); 
        await loadAssignees(siteId);
        await refreshTasks(siteId, me.uid);
        await refreshMyTasksPanel(siteId, me.uid);

        await refreshSiteEvents(siteId, isMgr);
        
        const btnsBox = $("mgr_event_btns");
        if(btnsBox){
            btnsBox.style.display = isMgr ? "flex" : "none";
            $("event_add_box").style.display = "none";
        }

        // --- Iframe é€£å‹•æ›´æ–° ---
        // å¦‚æœç¾åœ¨ Iframe æ˜¯æ‰“é–‹çš„ï¼Œåˆ‡æ›å ´åŸŸå¾Œè¦è‡ªå‹• reload iframe åˆ°æ–°å ´åŸŸ
        const frame = $("main_frame");
        if(frame.style.display !== "none" && window.currentIframeUrl) {
            window.loadPage(window.currentIframeUrl);
        }
      };

      await refreshAll();
      sel.addEventListener("change", refreshAll);

      // ===== è¡Œäº‹æ›† UI =====
      $("btn_toggle_event_add").onclick = () => {
        const box = $("event_add_box");
        const isHidden = (box.style.display === "none");
        
        if(isHidden) {
            $("evt_id_edit").value = "";
            $("evt_content").value = "";
            $("evt_msg").textContent = "";
            $("btn_save_event").textContent = "å„²å­˜";
            $("btn_del_event_form").style.display = "none";

            const tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
            const tmrStr = toISODateLocal(tmr);
            $("evt_date_start").value = tmrStr;
            $("evt_date_end").value = tmrStr; 
            box.style.display = "block";
        } else {
            box.style.display = "none";
        }
      };

      // Modal æ§åˆ¶
      $("btn_history").onclick = async () => {
          const m = $("history_modal");
          await loadCalendarEvents(sel.value);
          m.showModal();
      };
      $("btn_close_history").onclick = () => $("history_modal").close();
      
      // æœˆæ›†ä¸Šä¸‹æœˆæŒ‰éˆ•
      $("cal_prev").onclick = () => {
          calMonth--;
          if(calMonth < 0){ calMonth = 11; calYear--; }
          renderCalendar();
      };
      $("cal_next").onclick = () => {
          calMonth++;
          if(calMonth > 11){ calMonth = 0; calYear++; }
          renderCalendar();
      };

      $("btn_cancel_event").onclick = () => {
          closeEventForm();
      };

      $("evt_date_start").addEventListener("change", (e) => {
          if(!$("evt_id_edit").value && !$("evt_date_end").value) $("evt_date_end").value = e.target.value;
      });

      $("btn_save_event").onclick = () => {
        saveSiteEvent(sel.value, me.uid);
      };

      // ===== å´é‚Šæ¬„æŒ‰éˆ•é€£çµ =====
      $("btn_create").addEventListener("click", async () => {
        setMsg($("create_msg"), "");
        const siteId = sel.value;
        const title = $("task_title").value.trim();
        const body = $("task_body").value.trim();
        const status = $("task_status").value;
        const assignAll = $("task_assign_all")?.checked || false;
        const assSel = $("task_assignees");
        const assignees = assSel ? Array.from(assSel.selectedOptions).map(o => o.value).filter(Boolean) : [];

        if (!title){ setMsg($("create_msg"), "è«‹è¼¸å…¥æ¨™é¡Œ"); return; }
        const ins = await supabase.from("tasks").insert({ site_id: siteId, title, body: body || null, status, created_by: me.uid, assign_all: assignAll }).select("id").single();
        if (ins.error){ setMsg($("create_msg"), ins.error.message); return; }
        const taskId = ins.data.id;
        if (!assignAll && assignees.length){
          const rows = assignees.map(uid => ({ task_id: taskId, user_id: uid }));
          await supabase.from("task_assignees").insert(rows);
        }
        $("task_title").value = ""; $("task_body").value = ""; $("task_status").value = "open";
        if ($("task_assign_all")) $("task_assign_all").checked = false;
        if (assSel){ for (const o of assSel.options) o.selected = false; assSel.disabled = false; }
        await loadAssignees(siteId); await refreshTasks(siteId, me.uid); await refreshMyTasksPanel(siteId, me.uid);
      });

      // ç§»é™¤äº†åŸæœ¬çš„ window.openï¼Œç¾åœ¨ç›´æ¥ç”± HTML ä¸­çš„ onclick="loadPage()" è™•ç†
      // ä½†æˆ‘å€‘ä»éœ€ä¿ç•™å®šæœŸæª¢æŸ¥ç´…é»çš„åŠŸèƒ½
      setInterval(async () => {
        try{
            const siteId = sel.value;
            const roleCur = (me.memberships.find(x => x.site_id === siteId)?.role) || "";
            await refreshLeaveBadge(siteId, roleCur);
        }catch(e){}
      }, 30000);
    }
    main();
  </script>
</body>
</html>