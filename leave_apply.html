<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç”³è«‹ä¼‘å‡ / å€‹äººè³‡æ–™</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;margin:0;background:#fafafa;padding-bottom:40px}
    .bar{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#fff;border-bottom:1px solid #e8e8e8}
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 4px rgba(0,0,0,0.02)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,select,textarea,button{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    button{background:#2563eb;color:#fff;font-weight:600;cursor:pointer;border:none}
    button:hover{background:#1d4ed8}
    .msg{margin-top:10px;color:#d32f2f;font-size:14px;white-space:pre-wrap}
    .msg.ok{color:#2e7d32}
    .small{font-size:12px;color:#666;margin-bottom:4px;display:block}
    
    /* çµ±è¨ˆå€å¡Šæ¨£å¼ */
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));gap:8px;margin-top:10px}
    .stat-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center}
    .stat-val{font-size:18px;font-weight:700;color:#0f172a}
    .stat-label{font-size:11px;color:#64748b}
    
    .task{border-bottom:1px solid #eee;padding:12px 0}
    .task:last-child{border-bottom:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;background:#eee;color:#333}
    .pill.approved{background:#dcfce7;color:#166534}
    .pill.rejected{background:#fee2e2;color:#991b1b}
    
    /* å…¥è·æ—¥ Badge */
    .info-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div class="bar">
    <div style="font-weight:700">ç”³è«‹ / å€‹äººè³‡æ–™</div>
    <button style="width:auto;background:none;color:#666;padding:4px" onclick="location.href='./app.html'">å›ä¸»æ§å°</button>
  </div>

  <section class="card" style="border-top: 4px solid #2563eb;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
        <div style="font-weight:700;color:#333;">ğŸ“Š æˆ‘çš„å‡åˆ¥çµ±è¨ˆ (å·²é€šé)</div>
        <div id="seniority_tag" class="info-badge" style="display:none"></div>
    </div>
    
    <div style="margin-top:12px;font-weight:600;font-size:13px;color:#666;border-bottom:1px solid #eee;padding-bottom:4px">æœ¬æœˆçµ±è¨ˆ</div>
    <div id="stat_box_month" class="stat-grid">
      <div class="small">è¼‰å…¥ä¸­...</div>
    </div>

    <div style="margin-top:16px;font-weight:600;font-size:13px;color:#666;border-bottom:1px solid #eee;padding-bottom:4px">
        æœ¬å¹´åº¦çµ±è¨ˆ (å«ç‰¹ä¼‘é¡åº¦)
    </div>
    <div id="stat_box_year" class="stat-grid">
      <div class="small">è¼‰å…¥ä¸­...</div>
    </div>
  </section>

  <section class="card">
    <div class="grid">
      <div>
        <label class="small">å ´åŸŸ</label>
        <select id="site_sel"></select>
      </div>
      <div>
        <label class="small">å‡åˆ¥</label>
        <select id="leave_type">
          <option value="äº‹å‡">äº‹å‡</option>
          <option value="ç—…å‡">ç—…å‡</option>
          <option value="ç”Ÿç†å‡">ç”Ÿç†å‡</option>
          <option value="å–ªå‡">å–ªå‡</option>
          <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
        </select>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="grid">
      <div><label class="small">é–‹å§‹æ—¥æœŸ</label><input id="date_from" type="date"></div>
      <div><label class="small">çµæŸæ—¥æœŸ (åŒå¤©å¯å…å¡«)</label><input id="date_to" type="date"></div>
    </div>
    
    <div style="height:10px"></div>
    <label class="small">è­‰æ˜ç…§ç‰‡ (é¸å¡«)</label>
    <input id="photo" type="file" accept="image/*">
    
    <div style="height:10px"></div>
    <label class="small">å‚™è¨» / åŸå› </label>
    <textarea id="note" placeholder="è«‹è¼¸å…¥è«‹å‡äº‹ç”±..."></textarea>

    <div style="height:16px"></div>
    <button id="btn_submit">é€å‡ºç”³è«‹</button>
    <div id="msg" class="msg"></div>
  </section>

  <section class="card">
    <div style="font-weight:700;margin-bottom:10px">ç”³è«‹ç´€éŒ„</div>
    <div id="my_box"></div>
  </section>

<script>
  const $ = id => document.getElementById(id);
  // è«‹ç¢ºèªé€™è£¡çš„ URL å’Œ Key æ˜¯æ­£ç¢ºçš„
  const sb = supabase.createClient("https://whbllncddoqbwukstxel.supabase.co", "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2");
  
  function setMsg(t, ok=false){ const el=$("msg"); el.textContent=t; el.className=ok?"msg ok":"msg"; }

  // === ç‰¹ä¼‘è¨ˆç®—é‚è¼¯ (ä¾ç…§åœ–ç‰‡è¦å‰‡) ===
  function calcAnnualLeaveDays(entryDateStr) {
    if (!entryDateStr) return 0;
    
    const entry = new Date(entryDateStr);
    const now = new Date(); // ä»¥ç•¶ä¸‹æ™‚é–“è¨ˆç®—
    
    // è¨ˆç®—å®Œæ•´å¹´è³‡
    let years = now.getFullYear() - entry.getFullYear();
    const m = now.getMonth() - entry.getMonth();
    // è‹¥æœˆä»½ä¸æ»¿æˆ–åŒæœˆä»½æ—¥æœŸæœªåˆ°ï¼Œå¹´è³‡æ¸›ä¸€
    if (m < 0 || (m === 0 && now.getDate() < entry.getDate())) {
        years--;
    }
    
    // è¨ˆç®—ç¸½æœˆæ•¸ (ç”¨æ–¼æœªæ»¿ä¸€å¹´åˆ¤å®š)
    const totalMonths = (now.getFullYear() - entry.getFullYear()) * 12 + (now.getMonth() - entry.getMonth());

    // ä¾ç…§åœ–ç‰‡è¦å‰‡åˆ¤æ–·
    if (years >= 25) return 30; // æ»¿25å¹´
    if (years >= 24) return 30; // æ»¿24å¹´
    if (years >= 10) return 16 + (years - 10); // æ»¿10å¹´16å¤©ï¼Œæ¯å¤šä¸€å¹´åŠ ä¸€å¤© (10->16, 11->17... 23->29)
    
    // æœªæ»¿10å¹´çš„åˆ—è¡¨ (ä¾ç…§åœ–ç‰‡)
    if (years >= 9) return 15;
    if (years >= 8) return 15;
    if (years >= 7) return 15;
    if (years >= 6) return 15;
    if (years >= 5) return 15;
    if (years >= 4) return 14; // åœ–ç‰‡ï¼šæ»¿4å¹´ 14å¤©
    if (years >= 3) return 14; // åœ–ç‰‡ï¼šæ»¿3å¹´ 14å¤©
    if (years >= 2) return 10; // åœ–ç‰‡ï¼šæ»¿2å¹´ 10å¤©
    if (years >= 1) return 7;  // åœ–ç‰‡ï¼šæ»¿1å¹´ 7å¤©
    
    if (totalMonths >= 6) return 3; // åœ–ç‰‡ï¼šæ»¿6å€‹æœˆ 3å¤©
    
    return 0; // æœªæ»¿6å€‹æœˆ
  }

  // === æ ¸å¿ƒï¼šæ¸²æŸ“çµ±è¨ˆ (åˆ†æœˆèˆ‡å¹´) ===
  async function renderStats(siteId, uid) {
    const now = new Date();
    // 1. æœ¬æœˆç¬¬ä¸€å¤©
    const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
    // 2. ä»Šå¹´ç¬¬ä¸€å¤©
    const firstDayYear = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);

    // å¹³è¡ŒæŸ¥è©¢ï¼šæœ¬æœˆç´€éŒ„ã€æœ¬å¹´ç´€éŒ„ã€å€‹äººæª”æ¡ˆ(æŸ¥å…¥è·æ—¥)
    const [resMonth, resYear, resProfile] = await Promise.all([
        sb.from("leave_requests")
          .select("leave_type").eq("site_id", siteId).eq("requester_id", uid).eq("status", "approved")
          .gte("date_from", firstDayMonth),
        
        sb.from("leave_requests")
          .select("leave_type").eq("site_id", siteId).eq("requester_id", uid).eq("status", "approved")
          .gte("date_from", firstDayYear),
          
        sb.from("personal_profiles").select("entry_date").eq("user_id", uid).maybeSingle()
    ]);

    // A. è™•ç†å…¥è·æ—¥èˆ‡ç‰¹ä¼‘é¡åº¦
    let maxAnnual = 0;
    if (resProfile.data && resProfile.data.entry_date) {
        const ed = resProfile.data.entry_date;
        maxAnnual = calcAnnualLeaveDays(ed);
        const tag = $("seniority_tag");
        tag.style.display = "block";
        tag.innerHTML = `å…¥è·æ—¥ï¼š${ed} <br> ç‰¹ä¼‘é¡åº¦ï¼š${maxAnnual} å¤©`;
    } else {
        const tag = $("seniority_tag");
        tag.style.display = "block";
        tag.style.background = "#eee";
        tag.style.color = "#666";
        tag.textContent = "æœªè¨­å®šå…¥è·æ—¥ (è«‹è‡³äººäº‹è³‡æ–™è¨­å®š)";
    }

    // B. è¨ˆç®—çµ±è¨ˆæ¬¡æ•¸ helper
    const calc = (rows) => {
        const c = { "äº‹å‡":0, "ç—…å‡":0, "ç”Ÿç†å‡":0, "ç‰¹ä¼‘":0, "å–ªå‡":0 };
        (rows||[]).forEach(r => { if(c[r.leave_type]!==undefined) c[r.leave_type]++; });
        return c;
    };

    const monthCounts = calc(resMonth.data);
    const yearCounts = calc(resYear.data);

    // C. æ¸²æŸ“ HTML
    // æœˆçµ±è¨ˆ
    $("stat_box_month").innerHTML = Object.entries(monthCounts).map(([k,v]) => `
      <div class="stat-item">
        <div class="stat-label">${k}</div>
        <div class="stat-val">${v}</div>
      </div>
    `).join("");

    // å¹´çµ±è¨ˆ (ç‰¹ä¼‘é¡¯ç¤ºå·²ç”¨/ç¸½é¡)
    $("stat_box_year").innerHTML = Object.entries(yearCounts).map(([k,v]) => {
        let displayVal = v;
        if (k === "ç‰¹ä¼‘") {
            const color = v > maxAnnual ? "#d32f2f" : "#15803d"; // è¶…éè®Šç´…ï¼Œæœªè¶…éç¶ 
            displayVal = `<span style="color:${color}">${v}</span> <span style="font-size:13px;color:#999">/ ${maxAnnual}</span>`;
        }
        return `
          <div class="stat-item">
            <div class="stat-label">${k}</div>
            <div class="stat-val">${displayVal}</div>
          </div>
        `;
    }).join("");
  }

  // 2. æ¸²æŸ“ç”³è«‹åˆ—è¡¨ (åŸæœ¬åŠŸèƒ½)
  async function renderMy(siteId, uid){
    const { data: rows } = await sb.from("leave_requests")
      .select("*").eq("site_id", siteId).eq("requester_id", uid)
      .order("created_at", {ascending:false}).limit(20);
      
    $("my_box").innerHTML = (rows||[]).map(r => {
      const dTo = r.date_to || r.date_from;
      let imgTag = "";
      if(r.photo_path){
        const {data} = sb.storage.from('leave-photos').getPublicUrl(r.photo_path);
        imgTag = `<div style="margin-top:4px"><a href="${data.publicUrl}" target="_blank" style="font-size:12px;color:#2563eb">æŸ¥çœ‹è­‰æ˜åœ–</a></div>`;
      }
      return `
      <div class="task">
        <div style="display:flex;justify-content:space-between">
          <strong>${r.leave_type}</strong>
          <span class="pill ${r.status}">${r.status==="pending"?"å¯©æ ¸ä¸­":r.status==="approved"?"å·²é€šé":"æœªé€šé"}</span>
        </div>
        <div class="small">${r.date_from}${dTo!==r.date_from?" ~ "+dTo:""}</div>
        ${r.note ? `<div style="font-size:13px;margin-top:4px">${r.note}</div>` : ""}
        ${imgTag}
      </div>`;
    }).join("") || "<div class='small'>ç„¡ç´€éŒ„</div>";
    
    // åŒæ­¥æ›´æ–°çµ±è¨ˆ (é‡è¦ï¼šæ¯æ¬¡æ¸²æŸ“åˆ—è¡¨ä¹Ÿé‡ç®—çµ±è¨ˆ)
    await renderStats(siteId, uid);
  }

  (async () => {
    const {data:{session}} = await sb.auth.getSession();
    if(!session) { location.href="./index.html"; return; }
    const uid = session.user.id;
    
    // è®€å–å ´åŸŸ
    const {data: mems} = await sb.from("site_memberships").select("site_id").eq("user_id", uid).eq("is_active", true);
    if(!mems?.length){ alert("ç„¡å ´åŸŸæ¬Šé™"); return; }
    const siteIds = mems.map(m=>m.site_id);
    const {data: sites} = await sb.from("sites").select("id,name").in("id", siteIds);
    
    const sel = $("site_sel");
    sites.forEach(s => {
      const opt = document.createElement("option"); opt.value=s.id; opt.textContent=s.name; sel.appendChild(opt);
    });
    
    // åˆå§‹åŒ–
    $("date_from").value = new Date().toISOString().slice(0,10);
    renderMy(sel.value, uid);
    sel.onchange = () => renderMy(sel.value, uid);

    // æäº¤é‚è¼¯ (å«åœ–ç‰‡ä¸Šå‚³)
    $("btn_submit").onclick = async () => {
      setMsg("è™•ç†ä¸­...");
      const file = $("photo").files[0];
      let photo_path = null;
      
      if(file){
        const ext = file.name.split(".").pop();
        const path = `${uid}/${Date.now()}.${ext}`;
        const {error: upErr} = await sb.storage.from("leave-photos").upload(path, file);
        if(upErr){ setMsg("åœ–ç‰‡ä¸Šå‚³å¤±æ•—: "+upErr.message); return; }
        photo_path = path;
      }

      const {error} = await sb.from("leave_requests").insert({
        site_id: sel.value, requester_id: uid, leave_type: $("leave_type").value,
        date_from: $("date_from").value, date_to: $("date_to").value||$("date_from").value,
        note: $("note").value||null, photo_path
      });

      if(error) setMsg(error.message);
      else {
        setMsg("ç”³è«‹æˆåŠŸ", true);
        $("note").value=""; $("photo").value="";
        renderMy(sel.value, uid);
      }
    };
  })();
</script>
</body>
</html>