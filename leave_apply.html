<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>申請休假</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="theme.js"></script>
  <style>
    /* 使用變數 */
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;margin:0;background:var(--bg-color, #fafafa);padding:20px; color:var(--text-color, #333)}
    .card{background:var(--card-bg, #fff);border:1px solid var(--border-color, #e8e8e8);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.02)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    
    input,select,textarea,button{width:100%;box-sizing:border-box;padding:12px;border:1px solid var(--input-border, #ddd);border-radius:8px;font-size:14px; background:var(--input-bg, #fff); color:var(--text-color, #333)}
    textarea{min-height:80px;resize:vertical}
    
    button{background:var(--primary-color, #2563eb);color:#fff;font-weight:600;cursor:pointer;border:none}
    button:hover{opacity:0.9}
    
    .msg{margin-top:10px;color:#d32f2f;font-size:14px;white-space:pre-wrap}
    .msg.ok{color:#2e7d32}
    .small{font-size:12px;color:var(--text-color);opacity:0.7;margin-bottom:4px;display:block}
    .section-title { font-weight:700; color:var(--text-color, #333); border-left:4px solid var(--primary-color, #2563eb); padding-left:8px; margin: 0 0 15px 0; }
    .task{border-bottom:1px solid var(--border-color, #eee);padding:12px 0}
    .pill{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;background:rgba(0,0,0,0.05);color:var(--text-color)}
  </style>
</head>
<body>

  <section class="card">
    <div class="section-title">1. 休假資訊</div>
    <div class="grid">
      <div>
        <label class="small">假別類型</label>
        <select id="leave_type">
          <option value="特休">特休</option>
          <option value="補休">補休</option>
          <option value="公假">公假</option>
          <option value="事假">事假</option>
          <option value="病假">病假</option>
          <option value="生理假">生理假</option>
          <option value="家庭照顧假">家庭照顧假</option>
          <option value="產假">產假</option>
          <option value="陪產假">陪產假</option>
          <option value="婚假">婚假</option>
          <option value="喪假">喪假</option>
          <option value="其他">其他 (請在備註說明)</option>
        </select>
      </div>
      </div>

    <div class="grid" style="margin-top:12px">
      <div><label class="small">開始時間</label><input id="date_from" type="datetime-local"></div>
      <div><label class="small">結束時間</label><input id="date_to" type="datetime-local"></div>
    </div>
    
    <div style="margin-top:12px">
        <label class="small">請假事由 / 備註</label>
        <textarea id="note" placeholder="請輸入請假原因..."></textarea>
    </div>

    <div style="margin-top:12px">
        <label class="small">證明照片 (選填)</label>
        <input id="photo" type="file" accept="image/*">
    </div>

    <div style="margin-top:20px">
        <button id="btn_submit">送出申請</button>
        <div id="msg" class="msg"></div>
    </div>
  </section>

  <section class="card">
    <div style="font-weight:700;margin-bottom:10px">我的近期申請</div>
    <div id="my_box"></div>
  </section>

<script>
  const $ = id => document.getElementById(id);
  const sb = supabase.createClient("https://whbllncddoqbwukstxel.supabase.co", "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2");
  const params = new URLSearchParams(window.location.search);
  const currentSiteId = params.get("site_id");

  function setMsg(t, ok=false){ const el=$("msg"); el.textContent=t; el.className=ok?"msg ok":"msg"; }
  function toLocalISO(dt) {
      const tz = dt.getTimezoneOffset() * 60000;
      return new Date(dt.getTime() - tz).toISOString().slice(0, 16);
  }

  async function renderMy(uid){
    if(!currentSiteId) return;
    const { data: rows } = await sb.from("leave_requests")
      .select("*").eq("site_id", currentSiteId).eq("requester_id", uid)
      .order("created_at", {ascending:false}).limit(10);
      
    $("my_box").innerHTML = (rows||[]).map(r => {
      const t1 = r.date_from ? r.date_from.replace("T", " ") : "";
      const t2 = r.date_to ? r.date_to.replace("T", " ") : "";
      // 若主管尚未填寫，total_duration 可能為空
      return `
      <div class="task">
        <div style="display:flex;justify-content:space-between">
          <strong>${r.leave_type}</strong>
          <span class="pill ${r.status}">${r.status}</span>
        </div>
        <div class="small" style="margin-top:4px">${t1} ~ ${t2}</div>
        <div class="small" style="color:#666">${r.total_duration ? "核定: "+r.total_duration : "尚未核定時數"}</div>
      </div>`;
    }).join("") || "<div class='small'>無紀錄</div>";
  }

  (async () => {
    const {data:{session}} = await sb.auth.getSession();
    if(!session || !currentSiteId) { document.body.innerHTML="請先登入並選擇場域"; return; }
    const uid = session.user.id;
    
    $("date_from").value = toLocalISO(new Date());
    $("date_to").value = toLocalISO(new Date());
    renderMy(uid);

    $("btn_submit").onclick = async () => {
      setMsg("處理中...");
      const file = $("photo").files[0];
      let photo_path = null;
      if(file){
        const ext = file.name.split(".").pop();
        const path = `${uid}/${Date.now()}.${ext}`;
        const {error: upErr} = await sb.storage.from("leave-photos").upload(path, file);
        if(upErr){ setMsg("圖片上傳失敗: "+upErr.message); return; }
        photo_path = path;
      }

      const {error} = await sb.from("leave_requests").insert({
        site_id: currentSiteId, 
        requester_id: uid, 
        leave_type: $("leave_type").value,
        date_from: $("date_from").value, 
        date_to: $("date_to").value,
        note: $("note").value || null,
        photo_path
      });

      if(error) setMsg(error.message);
      else {
        setMsg("申請成功！", true);
        $("note").value=""; $("photo").value="";
        renderMy(uid);
      }
    };
  })();
</script>
</body>
</html>