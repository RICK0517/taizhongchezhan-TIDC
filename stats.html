<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>假別統計</title>
  <script src="theme.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;padding:20px;background:var(--bg-color); color:var(--text-color)}
    .card{border:1px solid var(--border-color);border-radius:10px;padding:15px;margin-bottom:15px;background:var(--card-bg)}
    .bar{margin-bottom:15px}
    input,button{padding:10px;border:1px solid var(--input-border);border-radius:6px; background:var(--input-bg); color:var(--text-color)}
    button{background:var(--primary-color, #2563eb);color:#fff;font-weight:700;cursor:pointer;border:none}
    
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--border-color);padding:8px 6px;text-align:left;font-size:14px}
    th{background:rgba(0,0,0,0.05)}
    
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
    .stat-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; background: var(--card-bg); }
    .stat-num { font-size: 20px; font-weight: 700; color: var(--primary-color, #2563eb); }
    .small { font-size: 13px; color: var(--text-color); opacity:0.7; }
  </style>
</head>
<body>
  <div class="bar">
    <h1 style="margin:0">假別統計</h1>
  </div>

  <section class="card">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label class="small">開始日期 <input type="date" id="date_start"></label>
      <label class="small">結束日期 <input type="date" id="date_end"></label>
      <button id="btn_search">查詢</button>
    </div>
    <div id="msg" style="margin-top:10px;color:red"></div>
  </section>

  <section class="card" id="view_employee" style="display:none">
    <h2 style="margin:0;font-size:1.1rem">我的統計</h2>
    <div class="small" style="margin-top:4px" id="emp_name_display"></div>
    <div class="stat-grid" id="emp_stats_box"></div>
  </section>

  <section class="card" id="view_manager" style="display:none">
    <h2 style="margin:0;font-size:1.1rem">全員統計表</h2>
    <div style="overflow-x:auto">
      <table id="mgr_table">
        <thead>
            <tr>
                <th>姓名</th><th>事假</th><th>病假</th><th>喪假</th><th>特休</th><th>生理假</th><th>合計</th>
            </tr>
        </thead>
        <tbody id="mgr_tbody"></tbody>
      </table>
    </div>
  </section>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const sb = createClient("https://whbllncddoqbwukstxel.supabase.co", "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2");

const $ = id => document.getElementById(id);
const params = new URLSearchParams(window.location.search);
const currentSiteId = params.get("site_id");
const TARGET_SHIFTS = ["事假", "病假", "喪假", "特休", "生理假"];

const today = new Date();
$("date_start").value = `${today.getFullYear()}-01-01`;
$("date_end").value = `${today.getFullYear()}-12-31`;

async function main(){
    const {data:{session}} = await sb.auth.getSession();
    if(!session || !currentSiteId) return;
    const uid = session.user.id;
    
    // 取得身分
    const {data:mem} = await sb.from("site_memberships").select("role").eq("user_id",uid).eq("site_id",currentSiteId).maybeSingle();
    const role = mem ? mem.role : "";
    
    $("btn_search").onclick = () => doSearch(uid, role);
    doSearch(uid, role); // 自動執行一次
}

async function doSearch(uid, role){
    $("msg").textContent = "查詢中...";
    const start = $("date_start").value;
    const end = $("date_end").value;
    
    let q = sb.from("site_schedules").select("person_name, shift")
        .eq("site_id", currentSiteId)
        .gte("work_date", start).lte("work_date", end)
        .in("shift", TARGET_SHIFTS);
        
    const isManager = (role==='engineer'||role==='supervisor');
    let myNames = [];
    
    if(!isManager){
        // 員工只能查自己
        const {data:links} = await sb.from("site_person_links").select("person_name").eq("site_id",currentSiteId).eq("user_id",uid);
        myNames = (links||[]).map(x=>x.person_name);
        if(!myNames.length) { $("msg").textContent="您尚未連結班表姓名"; return; }
        q = q.in("person_name", myNames);
    }
    
    const {data:rows, error} = await q;
    if(error) { $("msg").textContent=error.message; return; }
    $("msg").textContent = "";
    
    if(isManager){
        $("view_manager").style.display="block";
        $("view_employee").style.display="none";
        renderManager(rows);
    } else {
        $("view_manager").style.display="none";
        $("view_employee").style.display="block";
        $("emp_name_display").textContent = "對象: " + myNames.join(", ");
        renderEmployee(rows);
    }
}

function renderManager(rows){
    const map = {};
    rows.forEach(r => {
        if(!map[r.person_name]) { map[r.person_name]={total:0}; TARGET_SHIFTS.forEach(k=>map[r.person_name][k]=0); }
        if(map[r.person_name][r.shift]!==undefined) { map[r.person_name][r.shift]++; map[r.person_name].total++; }
    });
    const tbody = $("mgr_tbody"); tbody.innerHTML="";
    Object.keys(map).sort().forEach(name => {
        const d = map[name];
        tbody.innerHTML += `<tr><td>${name}</td><td>${d['事假']}</td><td>${d['病假']}</td><td>${d['喪假']}</td><td>${d['特休']}</td><td>${d['生理假']}</td><td>${d.total}</td></tr>`;
    });
}

function renderEmployee(rows){
    const counts = {}; TARGET_SHIFTS.forEach(k=>counts[k]=0);
    rows.forEach(r => { if(counts[r.shift]!==undefined) counts[r.shift]++; });
    $("emp_stats_box").innerHTML = TARGET_SHIFTS.map(k => `
        <div class="stat-box"><div class="small">${k}</div><div class="stat-num">${counts[k]}</div></div>
    `).join("");
}

main();
</script>
</body>
</html>