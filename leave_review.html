<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¯©æ ¸è«‹å‡</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;margin:0;background:#fafafa;padding:20px}
    
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    input,select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    button{padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:13px}
    button:hover{background:#f5f5f5}
    /* åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ */
    button.export-btn{background:#00796b;color:white;border:none;padding:8px 16px;font-weight:bold;}
    button.export-btn:hover{background:#004d40;}
    
    .task{border:1px solid #e2e2e2;border-radius:10px;padding:16px; margin-bottom:12px; background:#fff;}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;font-size:12px}
    .pill.pending{background:#fff7ed;color:#c2410c}
    .pill.approved{background:#f0fdf4;color:#15803d}
    .pill.rejected{background:#fef2f2;color:#b91c1c}
    
    /* å”¯è®€è³‡è¨Šåˆ— */
    .detail-row { font-size:14px; color:#444; margin-top:6px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    
    /* ä¸»ç®¡å¡«å¯«å€æ¨£å¼ */
    .mgr-input-group {
        margin-top: 12px; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 1px solid #b3e5fc;
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .mgr-input-group label { font-size: 12px; font-weight: bold; color: #0277bd; display:block; margin-bottom:4px;}
    .mgr-input-group input { width: 100%; box-sizing: border-box; border: 1px solid #90caf9; padding:8px; }
    
    /* å¼·èª¿ç¬¬8é»ï¼šæ™‚æ•¸åˆè¨ˆ */
    .highlight-input { border: 2px solid #29b6f6 !important; background:#fff; }
  </style>
</head>
<body>
  
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="margin:0">å¯©æ ¸è«‹å‡ç®¡ç†</h2>
      <div style="display:flex;gap:10px;">
        <select id="status_sel">
            <option value="pending" selected>å¾…å¯©æ ¸</option>
            <option value="approved">å·²é€šé</option>
            <option value="rejected">æœªé€šé</option>
            <option value="all">å…¨éƒ¨æ­·å²</option>
        </select>
        <button id="btn_refresh">é‡æ–°æ•´ç†</button>
        <button id="btn_export" class="export-btn">ğŸ“Š åŒ¯å‡º Excel (9æ¬„)</button>
      </div>
  </div>

  <div id="msg" style="color:red;font-size:13px;margin-bottom:10px"></div>
  <div id="box"></div>

<script>
  const $ = (id) => document.getElementById(id);
  const sb = supabase.createClient("https://whbllncddoqbwukstxel.supabase.co", "sb_publishable_-uGXQX02_yogpjSRjVQImA_FVcaqfQ2");
  const params = new URLSearchParams(window.location.search);
  const currentSiteId = params.get("site_id");

  // === å¯©æ ¸é€šé (å¯«å…¥è³‡æ–™åº«) ===
  window.approve = async (id) => {
    if (!confirm("ç¢ºå®šé€šéä¸¦å„²å­˜è³‡æ–™?")) return;
    
    // å–å¾—ä¸»ç®¡å¡«å¯«çš„æ¬„ä½ (å°æ‡‰ 3, 4, 5, 8, 9)
    const agentName = $(`agent_name_${id}`).value;
    const agentUnit = $(`agent_unit_${id}`).value;
    const task = $(`task_${id}`).value;
    const duration = $(`duration_${id}`).value; // ç¬¬8é»
    const mgrNote = $(`mgr_note_${id}`).value;   // ç¬¬9é»ï¼šå‚™è¨»æ¬„

    // å¿…å¡«æª¢æŸ¥
    if(!agentName){ alert("è«‹å¡«å¯«ã€ä»£ç†äººã€‘"); return; }
    if(!duration){ alert("è«‹å¡«å¯«ã€è«‹å‡æ™‚ç¨‹åˆè¨ˆã€‘(ä¾‹å¦‚: 1æ—¥4å°æ™‚)"); return; }

    const { error } = await sb.from("leave_requests").update({
        agent_name: agentName,
        agent_unit: agentUnit,
        delegation_task: task,
        total_duration: duration,
        manager_note: mgrNote,
        status: 'approved'
    }).eq("id", id);

    if (error) alert("æ›´æ–°å¤±æ•—: " + error.message); 
    else { alert("å·²é€šé"); loadData(); }
  };

  // === æ‹’çµ• ===
  window.reject = async (id) => {
      if (!confirm("ç¢ºå®šæ‹’çµ•?")) return;
      const { error } = await sb.from("leave_requests").update({ status: 'rejected' }).eq("id", id);
      if (error) alert("æ“ä½œå¤±æ•—"); else loadData();
  };

  let currentData = [];
  let currentSiteName = "";

  async function loadData(){
    if(!currentSiteId) { $("box").innerHTML="ç„¡æ•ˆçš„å ´åŸŸ ID"; return; }
    
    const status = $("status_sel").value;
    $("box").innerHTML = "è®€å–ä¸­...";

    // å–å¾—å ´åŸŸåç¨± (å°æ‡‰ç¬¬2é»)
    const {data:s} = await sb.from("sites").select("name").eq("id", currentSiteId).single();
    if(s) currentSiteName = s.name;
    
    // å–å¾—äººå“¡å°ç…§è¡¨ (å°æ‡‰ç¬¬1é»ï¼šç”³è«‹äººå§“å)
    const { data: people } = await sb.rpc("get_site_people", { p_site_id: currentSiteId });
    const nameMap = {};
    if(people) people.forEach(p => nameMap[p.user_id] = p.display_name || p.username);

    let q = sb.from("leave_requests").select("*").eq("site_id", currentSiteId).order("created_at", { ascending:false });
    if (status !== "all") q = q.eq("status", status);
    
    const { data, error } = await q;
    if (error) { $("box").innerHTML = "è®€å–éŒ¯èª¤"; return; }
    
    currentData = data.map(r => ({ ...r, requester_name: nameMap[r.requester_id] || "æœªçŸ¥äººå“¡" }));

    if (currentData.length === 0){ $("box").innerHTML = "<div style='color:#666;text-align:center'>ç„¡è³‡æ–™</div>"; return; }

    $("box").innerHTML = "";
    currentData.forEach(r => {
      const dateStr = r.date_from.replace("T"," ") + " ~ " + r.date_to.replace("T"," ");
      const isPending = r.status === "pending";
      
      const div = document.createElement("div");
      div.className = "task";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div style="font-weight:700;font-size:16px;color:#1565c0">
            ${r.requester_name} <span style="color:#333;font-weight:normal;font-size:14px">ç”³è«‹</span> ${r.leave_type}
          </div>
          <span class="pill ${r.status}">${r.status==="pending"?"å¾…å¯©æ ¸":r.status}</span>
        </div>

        <div class="detail-row">
            <span>ğŸ“… æ™‚é–“å€é–“ï¼š${dateStr}</span>
        </div>
        ${r.note ? `<div style="background:#f5f5f5;padding:8px;margin-top:8px;border-radius:6px;font-size:13px">ğŸ“„ äº‹ç”±ï¼š${r.note}</div>` : ""}
        
        ${isPending ? `
            <div class="mgr-input-group">
                <div style="grid-column: span 2; border-bottom:1px dashed #90caf9; padding-bottom:4px; margin-bottom:4px; font-weight:bold; display:flex; justify-content:space-between;">
                    <span>âœï¸ ä¸»ç®¡æ ¸å®šå¡«å¯«å€</span>
                    <span style="font-size:11px;color:#666;font-weight:normal">è«‹å¡«å¯«ä»¥ä¸‹ 5 å€‹æ¬„ä½</span>
                </div>
                
                <div style="grid-column: span 2">
                    <label>8. è«‹å‡æ™‚ç¨‹åˆè¨ˆ (å¿…å¡«)</label>
                    <input id="duration_${r.id}" class="highlight-input" placeholder="ä¾‹å¦‚: 1æ—¥4å°æ™‚" value="${r.total_duration||''}">
                </div>

                <div>
                    <label>3. ä»£ç†äºº</label>
                    <input id="agent_name_${r.id}" placeholder="å§“å" value="${r.agent_name||''}">
                </div>
                <div>
                    <label>4. ä»£ç†äººå–®ä½</label>
                    <input id="agent_unit_${r.id}" placeholder="å ´åŸŸ" value="${r.agent_unit||''}">
                </div>

                <div style="grid-column: span 2">
                    <label>5. å§”è¨—ä»£ç†äº‹é …</label>
                    <input id="task_${r.id}" placeholder="äº‹é …å…§å®¹" value="${r.delegation_task||''}">
                </div>

                <div style="grid-column: span 2">
                    <label>9. å‚™è¨»æ¬„</label>
                    <input id="mgr_note_${r.id}" placeholder="ä¸»ç®¡å‚™è¨»..." value="${r.manager_note||''}">
                </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
                <button onclick="reject('${r.id}')" style="background:#fee2e2;color:#b91c1c;border:none">æ‹’çµ•</button>
                <button onclick="approve('${r.id}')" style="background:#2563eb;color:#fff;border:none;padding:6px 16px">ç¢ºèªä¸¦é€šé</button>
            </div>
        ` : `
            <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-size:13px;color:#555">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
                    <div>â±ï¸ æ ¸å®šåˆè¨ˆï¼š<strong>${r.total_duration || "æœªå¡«å¯«"}</strong></div>
                    <div>ğŸ‘¤ ä»£ç†äººï¼š${r.agent_name || "-"} (${r.agent_unit || "-"})</div>
                    <div style="grid-column:span 2">ğŸ“‹ å§”è¨—äº‹é …ï¼š${r.delegation_task || "-"}</div>
                    <div style="grid-column:span 2;color:#d81b60">ğŸ“ å‚™è¨»æ¬„ï¼š${r.manager_note || "(ç„¡)"}</div>
                </div>
            </div>
        `}
      `;
      $("box").appendChild(div);
    });
  }

  // === åŒ¯å‡º Excel (åš´æ ¼å°æ‡‰ 9 å€‹æ¬„ä½) ===
  $("btn_export").onclick = () => {
    if(!currentData.length) { alert("ç›®å‰ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; }
    
    const exportData = currentData.map(row => ({
        "1ç”³è«‹äºº": row.requester_name,
        "2å–®ä½åç¨±(é¸æ“‡å ´åŸŸ)": currentSiteName,
        "3ä»£ç†äºº": row.agent_name || "",
        "4ä»£ç†äººå–®ä½(é¸æ“‡å ´åŸŸ)": row.agent_unit || "",
        "5å§”è¨—ä»£ç†äº‹é …": row.delegation_task || "",
        "6è«‹å‡é¡å‹": row.leave_type,
        "7è«‹å‡äº‹ç”±": row.note || "",
        "8è«‹å‡æ™‚ç¨‹": `${row.date_from.replace("T"," ")} ~ ${row.date_to.replace("T"," ")} (å…±è¨ˆ ${row.total_duration||""})`,
        "9å‚™è¨»æ¬„": row.manager_note || ""
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è«‹å‡æ˜ç´°");
    XLSX.writeFile(wb, `è«‹å‡åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  $("btn_refresh").onclick = loadData;
  $("status_sel").onchange = loadData;
  loadData();

</script>
</body>
</html>